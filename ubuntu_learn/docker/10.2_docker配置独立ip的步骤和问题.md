如果你想让 Docker 容器：

* 具有 **一个独立的 IP 地址**（像一台独立主机）
* 和宿主机 **在同一网段**
* 容器 ↔ 宿主机 可以 **互相 ping、互相访问端口**
* 而不是共享 host 网络

那么你应该使用 **macvlan 网络模式**。

这是 Docker 中唯一可以实现「同网段独立 IP」的方式。

---

# ✅ **方案：使用 macvlan 创建虚拟网卡 + 独立 IP**

下面我给你完整步骤（最常用、最稳的结构）。

---

# ① **确认宿主机正在使用的网卡名称**

执行：

```bash
ip addr
```

找到你用于上网的网卡（例如：

* `eth0`
* `ens33`
* `enp3s0`
* `wlp2s0` ← 注意：WiFi 不适合 macvlan）

假设是：

```
eth0
```

---

# ② **创建 macvlan 网络**

假设你的局域网网段是：
`192.168.1.0/24`

宿主机 IP：
`192.168.1.100`

你想把容器分配一个 IP：
`192.168.1.200`

执行：

```bash
docker network create -d macvlan \
  --subnet=192.168.1.0/24 \
  --gateway=192.168.1.1 \
  --ip-range=192.168.1.200/28 \
  -o parent=eth0 \
  macvlan_net
```

解释：

| 参数               | 含义             |
| ---------------- | -------------- |
| `-d macvlan`     | 使用 macvlan 驱动  |
| `--subnet`       | 使用你局域网网段       |
| `--gateway`      | 你的路由器地址        |
| `--ip-range`     | 提供给容器使用的 IP 范围 |
| `-o parent=eth0` | 使用的宿主机物理网卡     |

你修改成你的实际网段即可。

---

# ③ **创建容器并使用 macvlan 网络**

示例：

```bash
docker run -it --name test_mac --network macvlan_net --ip 192.168.1.200 ubuntu bash
```

容器内部会拥有：

```
IP: 192.168.1.200
网关: 192.168.1.1
```

和宿主机一样处于局域网内。

---

# ⚠️ ④ 容器默认无法 ping 宿主机（macvlan 设计如此）

要让容器 ↔ 宿主机 互相 ping
你必须在宿主机创建一个 macvlan 代理接口。

---

# ⑤ **宿主机创建一个 macvlan 虚拟接口（关键）**

宿主机执行：

```bash
ip link add macvlan0 link eth0 type macvlan mode bridge
ip addr add 192.168.1.150/24 dev macvlan0
ip link set macvlan0 up
```

这里给宿主机新的网卡 `macvlan0` 一个独立 IP（例如 192.168.1.150）。

这样你就有：

| 设备           | IP            |
| ------------ | ------------- |
| 宿主机 eth0     | 192.168.1.100 |
| 宿主机 macvlan0 | 192.168.1.150 |
| Docker 容器    | 192.168.1.200 |

完全同网段，非常干净。

---

# ⑥ **测试互相访问**

容器 ping 宿主机虚拟网卡：

```bash
ping 192.168.1.150
```

宿主机 ping 容器：

```bash
ping 192.168.1.200
```

互相访问端口：

容器开启 8000 端口 → 宿主机访问：

```
curl 192.168.1.200:8000
```

宿主机开启 9000 → 容器可访问：

```
curl 192.168.1.100:9000
```

（容器访问宿主机本体 IP 也行）

---

# 🚀 **结果（你想要的效果）**

你会得到：

* ✔ 容器有独立 IP，如同一台独立主机
* ✔ 和局域网设备、宿主机、其他容器 都在同一网段
* ✔ 可以互相 ping
* ✔ 可以互相访问端口
* ✔ 没有使用 NAT
* ✔ 不受 Docker 端口映射限制
* ✔ proxy 也完全不影响 UDP、TCP、ICMP

这是你想要的「容器像真实电脑一样在同网段」的最标准方式。

---

# 如果你愿意

我还可以帮你：

* 为你的 ROS2 + PX4 + QGC 容器自动配置 macvlan
* 写一个 docker-compose 文件让你一键启动
* 检测你的网卡、网段，自动生成正确配置

你需要吗？
