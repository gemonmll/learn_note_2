å¥½é—®é¢˜ï¼Œè¿™æ®µä»£ç å…¶å®å·²ç»æŠŠ **epoll çš„æ ¸å¿ƒä½¿ç”¨å§¿åŠ¿**éƒ½è¸©äº†ä¸€é ğŸ‘ã€‚æˆ‘ä»ã€Œepoll æ˜¯å•¥ â†’ ä¸ºå•¥è¦å’Œ socket ä¸€èµ·ç”¨ â†’ ä½ çš„ä»£ç é€æ®µè®² â†’ ET/LT æ¨¡å¼å·®å¼‚ â†’ å·¥ç¨‹çº§å‘ç‚¹ã€å¸®ä½ ç³»ç»Ÿæ¢³ä¸€éã€‚å­¦å®Œä½ ä¼šå¯¹ Linux é«˜æ€§èƒ½ç½‘ç»œ IO æœ‰æ¸…æ™°ç›´è§‰ã€‚

---

## 1ï¸âƒ£ epoll æ˜¯ä»€ä¹ˆï¼Ÿä¸€å¥è¯è®²æ¸…æ¥š

> **epoll æ˜¯ Linux æä¾›çš„â€œé«˜æ€§èƒ½ IO å¤šè·¯å¤ç”¨æœºåˆ¶â€**
> è®©ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶ç®¡ç†æˆç™¾ä¸Šåƒä¸ª socket / fdï¼Œè€Œä¸ç”¨é˜»å¡æˆ–ç–¯ç‹‚è½®è¯¢ã€‚

ä¼ ç»Ÿåšæ³•çš„é—®é¢˜ï¼š

* `recv(fd)`ï¼šä¸€æ¬¡åªèƒ½ç­‰ä¸€ä¸ª fd
* `select/poll`ï¼šfd å¤šäº†æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼ˆO(n) æ‰«æï¼‰

epoll çš„ä¼˜åŠ¿ï¼š

* å†…æ ¸å¸®ä½ ç»´æŠ¤â€œå“ªäº› fd å°±ç»ªäº†â€
* ç”¨æˆ·æ€åªå¤„ç† **æœ‰äº‹ä»¶çš„ fd**
* è§„æ¨¡å¤§æ—¶ä»ç„¶é«˜æ•ˆï¼ˆæ¥è¿‘ O(1)ï¼‰

---

## 2ï¸âƒ£ ä¸ºä»€ä¹ˆ epoll è¦å’Œ socket ä¸€èµ·ä½¿ç”¨ï¼Ÿ

å…ˆè¯´ç»“è®ºï¼š

> âŒ epoll ä¸æ˜¯ç½‘ç»œåº“
> âœ… epoll æ˜¯ **IO äº‹ä»¶é€šçŸ¥æœºåˆ¶**
> ğŸ‘‰ socket åªæ˜¯å®ƒæœ€å¸¸ç”¨çš„å¯¹è±¡

epoll èƒ½ç›‘å¬çš„å…¶å®æ˜¯ **æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦(fd)**ï¼š

* socketï¼ˆç½‘ç»œï¼‰
* pipe
* eventfd
* timerfd
* æ™®é€šæ–‡ä»¶ï¼ˆä½†æ™®é€šæ–‡ä»¶å‡ ä¹æ°¸è¿œâ€œå¯è¯»â€ï¼Œæ„ä¹‰ä¸å¤§ï¼‰

### ğŸ¯ é‚£ä¸ºä»€ä¹ˆå®é™…å·¥ç¨‹ä¸­å‡ ä¹æ€»æ˜¯ epoll + socketï¼Ÿ

å› ä¸ºï¼š

* ç½‘ç»œ IO æ˜¯ **é«˜å¹¶å‘ + ä¸ç¡®å®šå»¶è¿Ÿ**
* socket ä¼šï¼š

  * é˜»å¡
  * è¢«å®¢æˆ·ç«¯æ–­å¼€
  * åŒæ—¶æœ‰æˆåƒä¸Šä¸‡ä¸ªè¿æ¥

ğŸ‘‰ epoll + socket = Linux é«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å™¨çš„â€œæ ‡å‡†ç»„åˆæ‹³â€

å…¸å‹æ¶æ„ï¼š

```text
å®¢æˆ·ç«¯ socket x N
        |
      epoll
        |
   äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰
        |
    onRead / onWrite / onClose
```

---

## 3ï¸âƒ£ ä½ çš„ä»£ç é€æ®µè®²è§£ï¼ˆå·²ç»å¾ˆæ¥è¿‘å·¥ç¨‹å†™æ³•ï¼‰

### âœ… åˆ›å»º epoll å®ä¾‹

```cpp
int epollfd = epoll_create(1);
```

epoll å†…æ ¸é‡Œç»´æŠ¤äº†ä¸€æ£µçº¢é»‘æ ‘ + å°±ç»ªé“¾è¡¨ï¼š

* çº¢é»‘æ ‘ï¼šç®¡ç†ä½ å…³å¿ƒçš„ fd
* å°±ç»ªé“¾è¡¨ï¼šå·²ç»â€œå¯è¯»/å¯å†™â€çš„ fd

ğŸ‘‰ epollfd å°±æ˜¯ä½ å’Œå†…æ ¸äº¤äº’çš„â€œäº‹ä»¶ä¸­å¿ƒâ€

---

### âœ… æŠŠ socket åŠ å…¥ epoll ç›‘å¬

```cpp
epoll_ctl(efd, op, fd, &ev);
```

æœ¬è´¨å«ä¹‰ï¼š

> â€œå†…æ ¸å•Šï¼Œè¿™ä¸ª fd æœ‰è¿™äº›äº‹ä»¶ï¼ˆEPOLLIN/EPOLLOUTï¼‰ï¼Œ
> ç­‰å®ƒå°±ç»ªäº†ä½ é€šçŸ¥æˆ‘â€

æ¯”å¦‚ï¼š

```cpp
ev.events = EPOLLIN | EPOLLET;
```

è¡¨ç¤ºï¼š

* å…³å¿ƒå¯è¯»äº‹ä»¶
* ä½¿ç”¨ ETï¼ˆè¾¹ç¼˜è§¦å‘ï¼‰

---

### âœ… è¯»äº‹ä»¶å¤„ç†ï¼ˆET æ¨¡å¼çš„æ­£ç¡®å§¿åŠ¿ï¼‰

ä½ è¿™æ®µå†™å¾—éå¸¸ä¸“ä¸šï¼š

```cpp
while ((n = ::recv(fd, read_buf, sizeof(read_buf), 0)) > 0) {
    msg.append(read_buf, static_cast<size_t>(n));
}
```

è¿™æ˜¯ **ET æ¨¡å¼çš„æ ‡å‡†è¯»æ³•**ï¼š

> **è¾¹ç¼˜è§¦å‘ = ä¸€æ¬¡é€šçŸ¥ä½ â€œæœ‰æ•°æ®äº†â€ï¼Œ
> ä½ å¿…é¡»ä¸€æ¬¡æ€§æŠŠå†…æ ¸ç¼“å†²åŒºè¯»ç©º**

å¦åˆ™ï¼š

* å¦‚æœä½ æ²¡è¯»ç©º
* epoll ä¸ä¼šå†é€šçŸ¥ä½ 
* ä½ ä¼šæ°¸è¿œâ€œå¡ä½â€è¿™ä¸ªè¿æ¥

ğŸ‘ ä½ å·²ç»æŒæ¡äº† epoll çš„å…³é”®éš¾ç‚¹ã€‚

---

### âœ… é”™è¯¯å¤„ç†é€»è¾‘ä¹Ÿå†™å¯¹äº†

```cpp
if (errno == EAGAIN || errno == EWOULDBLOCK) {
    return;  // è¯»å®Œäº†
}
```

è¿™æ˜¯ ET + éé˜»å¡ socket çš„æ­£ç¡®ç»“æŸæ¡ä»¶ã€‚

---

## 4ï¸âƒ£ ET vs LT æ¨¡å¼ï¼ˆæ ¸å¿ƒæ€æƒ³å·®å¼‚ï¼‰

| æ¨¡å¼ | å…¨ç§°            | ç‰¹ç‚¹             | ä½ ç°åœ¨ç”¨çš„ |
| -- | ------------- | -------------- | ----- |
| LT | Level Trigger | åªè¦ç¼“å†²åŒºè¿˜æœ‰æ•°æ®å°±ä¸æ–­é€šçŸ¥ | âŒ     |
| ET | Edge Trigger  | åªåœ¨çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥ä¸€æ¬¡    | âœ…     |

### ğŸ”¥ ç›´è§‰å¯¹æ¯”ï¼š

* **LTï¼š**

  > â€œä½ è¿˜æœ‰æ•°æ®æ²¡è¯»å®Œï¼Œæˆ‘ä¼šä¸€ç›´çƒ¦ä½ â€

* **ETï¼š**

  > â€œæˆ‘åªæé†’ä½ ä¸€æ¬¡ï¼Œæœ‰æ²¡æœ‰æœ¬äº‹è¯»å¹²å‡€çœ‹ä½ è‡ªå·±â€

ğŸ‘‰ é«˜æ€§èƒ½æœåŠ¡å™¨ä¸€èˆ¬ç”¨ ETï¼Œä½†ç¼–ç¨‹éš¾åº¦é«˜ã€‚

---

## 5ï¸âƒ£ ä¸ºä»€ä¹ˆä¸ç”¨é˜»å¡ recvï¼Œè€Œè¦ epollï¼Ÿ

æƒ³è±¡ 10000 ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼š

### âŒ é˜»å¡æ¨¡å‹ï¼š

```text
ä¸€ä¸ª socket ä¸€ä¸ªçº¿ç¨‹
â†’ çº¿ç¨‹çˆ†ç‚¸
â†’ ä¸Šä¸‹æ–‡åˆ‡æ¢çˆ†ç‚¸
â†’ ç³»ç»Ÿç›´æ¥æŠ–æ­»
```

### âŒ è½®è¯¢æ¨¡å‹ï¼š

```cpp
for (fd in all_fds) recv(fd)
```

â†’ 9999 ä¸ª fd æ²¡æ•°æ®ï¼Œä½ ç™½è·‘ 9999 æ¬¡

### âœ… epoll æ¨¡å‹ï¼š

```text
epoll_wait -> åªè¿”å›â€œæœ‰æ•°æ®çš„ fdâ€
```

â†’ CPU æ—¶é—´èŠ±åœ¨çœŸæ­£æœ‰ IO çš„è¿æ¥ä¸Š

---

## 6ï¸âƒ£ epoll + socket çš„å·¥ç¨‹çº§å®Œæ•´æ¶æ„ï¼ˆä½ ç°åœ¨åªå·®æœ€åä¸€å—ï¼‰

æ ‡å‡†æ¨¡å‹ï¼š

```text
accept æ–°è¿æ¥
   |
è®¾ç½® socket éé˜»å¡
   |
åŠ å…¥ epoll
   |
epoll_wait
   |
for (event in events)
   |
OnSocketRead / OnSocketWrite / Close
```

âš ï¸ å…³é”®å‰æï¼š**socket å¿…é¡»è®¾ç½®æˆéé˜»å¡**

```cpp
fcntl(fd, F_SETFL, O_NONBLOCK);
```

å¦åˆ™ï¼š

* ET æ¨¡å¼ä¸‹ recv ä¼šæŠŠçº¿ç¨‹å¡æ­»
* epoll çš„æ„ä¹‰ç›´æ¥è¢«ç ´å

---

## 7ï¸âƒ£ ä½ è¿™ä»½ä»£ç çš„å‡ ä¸ªå¯ä¼˜åŒ–ç‚¹ï¼ˆå·¥ç¨‹è§†è§’ï¼‰

### âš ï¸ 1. recv ç¼“å†²åŒºå¤§å°å›ºå®š 10KB

å¦‚æœä¸Šå±‚åè®®åŒ…å¾ˆå¤§ï¼š

ğŸ‘‰ å»ºè®®å¾ªç¯ + åŠ¨æ€ bufferï¼ˆä½ ç°åœ¨å·²ç» append äº†ï¼Œæ–¹å‘æ˜¯å¯¹çš„ï¼‰

---

### âš ï¸ 2. ç²˜åŒ…æ‹†åŒ… TODO å¾ˆå…³é”®

```cpp
// todo(wangxiantao): use MAGIC_HEAD to segment packet
```

è¿™æ˜¯ç½‘ç»œç¼–ç¨‹çš„æ ¸å¿ƒé—®é¢˜ä¹‹ä¸€ï¼š

TCP æ˜¯ **å­—èŠ‚æµï¼Œä¸æ˜¯æ¶ˆæ¯æµ**
å¿…é¡»ï¼š

* è‡ªå®šä¹‰åè®®å¤´
* æˆ–é•¿åº¦å­—æ®µ
* æˆ– magic + length

---

### âš ï¸ 3. epollfd ç”Ÿå‘½å‘¨æœŸç®¡ç†

ä½ ç°åœ¨ï¼š

```cpp
int32_t EpollTcpBase::CreateEpoll()
```

å·¥ç¨‹é‡Œé€šå¸¸ï¼š

* epollfd å±äº EventLoop
* ç¨‹åºæ•´ä¸ªç”Ÿå‘½å‘¨æœŸåªåˆ›å»ºä¸€æ¬¡

---

## 8ï¸âƒ£ ä¸€å¥è¯å¸®ä½ å»ºç«‹ç›´è§‰

> **socket è´Ÿè´£â€œæ”¶å‘æ•°æ®â€ï¼Œ
> epoll è´Ÿè´£â€œå‘Šè¯‰ä½ ä»€ä¹ˆæ—¶å€™å¯ä»¥æ”¶å‘â€ã€‚**
>
> epoll æ˜¯è°ƒåº¦å‘˜ï¼Œsocket æ˜¯å·¥äººã€‚

---

## 9ï¸âƒ£ æ€»ç»“ä¸€å¥å·¥ç¨‹çº§ç»“è®º

| é—®é¢˜            | ç­”æ¡ˆ                   |
| ------------- | -------------------- |
| epoll æ˜¯å¹²å˜›çš„    | IO äº‹ä»¶é€šçŸ¥å™¨             |
| ä¸ºä»€ä¹ˆå’Œ socket ç”¨ | è§£å†³é«˜å¹¶å‘ç½‘ç»œ IO           |
| epoll èƒ½å•ç‹¬ç”¨å—   | èƒ½ï¼Œä½†æ²¡æ„ä¹‰               |
| ET æ¨¡å¼éš¾ç‚¹       | å¿…é¡»ä¸€æ¬¡è¯»ç©º               |
| ä½ è¿™æ®µä»£ç æ°´å¹³       | å·²ç»æ˜¯ä¸­é«˜çº§ Linux ç½‘ç»œç¼–ç¨‹æ°´å¹³äº† |

---

## ğŸš€ å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥å¸®ä½ 

ğŸ‘‰ å¸®ä½ æŠŠè¿™å¥—ä»£ç å‡çº§æˆï¼š

* å®Œæ•´ TCP Server
* å¸¦ accept + éé˜»å¡ socket
* epoll äº‹ä»¶å¾ªç¯
* ç²˜åŒ…æ‹†åŒ…åè®®
* reactor æ¨¡å‹ï¼ˆone loop per threadï¼‰

è¿™å¥—æ˜¯**é«˜æ€§èƒ½ä¸­é—´ä»¶ / Apollo æ¨¡å—é€šä¿¡ / æ„ŸçŸ¥æœåŠ¡ç«¯**çš„æ ‡å‡†åº•åº§ã€‚



## epoll loop

```cpp
// one loop per thread, call epoll_wait and handle all coming events
void EpollTcpClient::EpollLoop() {
    // request some memory, if events ready, socket events will copy to this
    // memory from kernel
    struct epoll_event* alive_events =
        static_cast<epoll_event*>(calloc(kMaxEvents, sizeof(epoll_event)));
    if (!alive_events) {
        LOG(ERROR) << "calloc memory failed for epoll_events!" << std::endl;
        return;
    }
    while (loop_flag_) {
        int num = epoll_wait(efd_, alive_events, kMaxEvents, kEpollWaitTime);

        for (int i = 0; i < num; ++i) {
            int fd = alive_events[i].data.fd;
            int events = alive_events[i].events;

            if ((events & EPOLLERR) || (events & EPOLLHUP)) {
                LOG(INFO) << "epoll_wait error!" << std::endl;
                // An error has occured on this fd, or the socket is not ready
                // for reading (why were we notified then?).
                ::close(fd);
            } else if (events & EPOLLRDHUP) {
                // Stream socket peer closed connection, or shut down writing
                // half of connection.
                // more inportant, We still to handle disconnection when
                // read()/recv() return 0 or -1 just to be sure.
                LOG(INFO) << "fd:" << fd << " closed EPOLLRDHUP!" << std::endl;
                // close fd and epoll will remove it
                ::close(fd);
            } else if (events & EPOLLIN) {
                // other fd read event coming, meaning data coming
                OnSocketRead(fd);
            } else if (events & EPOLLOUT) {
                // pass
            } else {
                LOG(INFO) << "unknow epoll event!" << std::endl;
            }
        }  // end for (int i = 0; ...
    }  // end while (loop_flag_)
    free(alive_events);
}
```

è¿™æ®µ `EpollLoop()` åŸºæœ¬å°±æ˜¯ä¸€ä¸ª**æ ‡å‡† Reactor/EventLoop çš„é›å½¢**äº† ğŸ‘ã€‚æˆ‘æŒ‰â€œæ•´ä½“æµç¨‹ â†’ æ¯ä¸€æ®µåœ¨å¹²å˜› â†’ äº‹ä»¶ç±»å‹å«ä¹‰ â†’ è®¾è®¡ä¸Šçš„å…³é”®ç‚¹ & å¯æ”¹è¿›ç‚¹â€ç»™ä½ æ‹†è§£ï¼Œå¸®ä½ çœŸæ­£åƒé€ epoll äº‹ä»¶å¾ªç¯ã€‚

---

## 1ï¸âƒ£ è¿™æ®µå‡½æ•°åœ¨å¹²å˜›ï¼Ÿï¼ˆä¸€å¥è¯æ€»è§ˆï¼‰

> **ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ª epoll äº‹ä»¶å¾ªç¯ï¼š
> ç­‰å¾… IO äº‹ä»¶ â†’ åˆ†å‘äº‹ä»¶ â†’ å¤„ç† socket è¯»å†™ / å…³é—­**

å…¸å‹çš„ç½‘ç»œäº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ï¼š

```text
while (running) {
    epoll_wait(...)
    for (event in ready_events) {
        handle(event)
    }
}
```

ä½ è¿™å°±æ˜¯æ ‡å‡† Reactor æ¨¡å¼ä¸­çš„ **Event Loop**ã€‚

---

## 2ï¸âƒ£ é€æ®µè§£é‡Šä½ çš„ä»£ç 

### âœ… ç”³è¯·äº‹ä»¶æ•°ç»„ï¼ˆç”¨æˆ·æ€ç¼“å†²åŒºï¼‰

```cpp
struct epoll_event* alive_events =
    static_cast<epoll_event*>(calloc(kMaxEvents, sizeof(epoll_event)));
```

ä½œç”¨ï¼š

* `epoll_wait()` è¿”å›çš„å°±ç»ªäº‹ä»¶ï¼Œä¼šè¢«å†…æ ¸æ‹·è´åˆ°è¿™ä¸ªæ•°ç»„é‡Œ
* `kMaxEvents` = ä¸€æ¬¡æœ€å¤šå¤„ç†å¤šå°‘ä¸ª fd çš„äº‹ä»¶

ç›´è§‰ç†è§£ï¼š

> epoll_wait æŠŠâ€œå·²å°±ç»ª fd åˆ—è¡¨â€å¡è¿›ä½ æä¾›çš„æ•°ç»„

---

### âœ… epoll_waitï¼šé˜»å¡ç­‰å¾…å†…æ ¸äº‹ä»¶

```cpp
int num = epoll_wait(efd_, alive_events, kMaxEvents, kEpollWaitTime);
```

å«ä¹‰ï¼š

* é˜»å¡ç­‰å¾…ï¼ˆæœ€å¤š kEpollWaitTime msï¼‰
* è¿”å› **å°±ç»ª fd çš„æ•°é‡**
* alive_events[0..num-1] æ˜¯æœ¬è½®å‘ç”Ÿäº‹ä»¶çš„ fd

ç›´è§‰ï¼š

> â€œå†…æ ¸ï¼Œæœ‰äº‹ä»¶ä½ å«æˆ‘ï¼Œæ²¡æœ‰å°±ç­‰ä¸€ä¼šå„¿â€

---

### âœ… éå†æœ¬è½®æ‰€æœ‰å°±ç»ªäº‹ä»¶

```cpp
for (int i = 0; i < num; ++i) {
    int fd = alive_events[i].data.fd;
    int events = alive_events[i].events;
```

* `fd`ï¼šå‘ç”Ÿäº‹ä»¶çš„ socket
* `events`ï¼šäº‹ä»¶ç±»å‹ä½æ©ç ï¼ˆEPOLLIN / EPOLLOUT / EPOLLRDHUP ...ï¼‰

---

## 3ï¸âƒ£ æ¯ç§ epoll äº‹ä»¶çš„çœŸå®å«ä¹‰

### ğŸš¨ 1. EPOLLERR / EPOLLHUP

```cpp
if ((events & EPOLLERR) || (events & EPOLLHUP)) {
    ::close(fd);
}
```

å«ä¹‰ï¼š

* **EPOLLERR**ï¼šsocket å‡ºé”™ï¼ˆå¯¹ç«¯å¼‚å¸¸ã€ç½‘ç»œé”™è¯¯ç­‰ï¼‰
* **EPOLLHUP**ï¼šè¿æ¥æŒ‚èµ·ï¼ˆhang upï¼‰ï¼Œé€šå¸¸æ„å‘³ç€è¿æ¥ä¸å¯ç”¨äº†

å¤„ç†ç­–ç•¥ï¼š

ğŸ‘‰ ç›´æ¥å…³é—­ fdï¼Œé‡Šæ”¾èµ„æº
è¿™æ˜¯å·¥ç¨‹é‡Œæœ€å¸¸è§çš„åšæ³•ã€‚

---

### ğŸ”Œ 2. EPOLLRDHUPï¼ˆå¯¹ç«¯å…³é—­å†™ç«¯ï¼‰

```cpp
else if (events & EPOLLRDHUP) {
    ::close(fd);
}
```

å«ä¹‰ï¼š

* TCP å¯¹ç«¯è°ƒç”¨äº†ï¼š

  ```cpp
  shutdown(sock, SHUT_WR);
  ```
* æˆ–ç›´æ¥ close äº† socket
* è¡¨ç¤ºï¼š**å¯¹ç«¯ä¸ä¼šå†å‘æ•°æ®**

ä½ è¿™é‡Œçš„æ³¨é‡Šè¯´å¾—å¾ˆä¸“ä¸š ğŸ‘ï¼š

> è¯»åˆ° 0 æˆ– -1 æ—¶ä»ç„¶è¦å…œåº•å¤„ç†

å·¥ç¨‹å®è·µä¸­ï¼š

* RDHUP é€šå¸¸æ„å‘³ç€è¿æ¥ç”Ÿå‘½å‘¨æœŸç»“æŸ
* å…³é—­æ˜¯åˆç†é€‰æ‹©

---

### ğŸ“¥ 3. EPOLLINï¼ˆå¯è¯»äº‹ä»¶ï¼‰

```cpp
else if (events & EPOLLIN) {
    OnSocketRead(fd);
}
```

å«ä¹‰ï¼š

* socket æ¥æ”¶ç¼“å†²åŒºæœ‰æ•°æ®
* æˆ–å¯¹ç«¯å…³é—­å¯¼è‡´ recv è¿”å› 0

è¿™å°±æ˜¯ epoll + socket çš„æ ¸å¿ƒå·¥ä½œè·¯å¾„ï¼š

> â€œæœ‰æ•°æ®äº†ï¼Œå¿«æ¥è¯»â€

ä½ åœ¨ `OnSocketRead(fd)` é‡Œç”¨ ET æ¨¡å¼å¾ªç¯ recvï¼Œæ˜¯éå¸¸æ­£ç¡®çš„å†™æ³•ã€‚

---

### ğŸ“¤ 4. EPOLLOUTï¼ˆå¯å†™äº‹ä»¶ï¼‰

```cpp
else if (events & EPOLLOUT) {
    // pass
}
```

å«ä¹‰ï¼š

* socket å‘é€ç¼“å†²åŒºæœ‰ç©ºé—´
* å¯ä»¥ç»§ç»­ send ä¹‹å‰æ²¡å‘å®Œçš„æ•°æ®

ä½ ç°åœ¨æ²¡å®ç°å†™äº‹ä»¶å¤„ç†ï¼Œä½†å·¥ç¨‹é‡Œé€šå¸¸ç”¨æ¥ï¼š

* å¤„ç†å¤§åŒ…å‘é€
* å¤„ç† send è¿”å› EAGAIN çš„ç»­å†™

---

### â“ 5. å…œåº•æœªçŸ¥äº‹ä»¶

```cpp
else {
    LOG(INFO) << "unknow epoll event!" << std::endl;
}
```

åŸºæœ¬å±äºè°ƒè¯•ä¿æŠ¤ï¼Œå®é™…è¿è¡Œä¸­ä¸å¸¸è§ã€‚

---

## 4ï¸âƒ£ è®¾è®¡æ€æƒ³ï¼šone loop per thread

```cpp
// one loop per thread, call epoll_wait and handle all coming events
```

è¿™å¥è¯å¾ˆå…³é”®ï¼Œè¿™æ˜¯é«˜æ€§èƒ½ç½‘ç»œæœåŠ¡çš„ä¸»æµæ¨¡å‹ä¹‹ä¸€ï¼š

* æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ª epoll å®ä¾‹
* æ¯ä¸ªçº¿ç¨‹ç®¡ç†ä¸€ç»„è¿æ¥
* é¿å…å¤šçº¿ç¨‹æŠ¢åŒä¸€ä¸ª epollfd çš„é”ç«äº‰

å¸¸è§æ¶æ„ï¼š

```text
ä¸»çº¿ç¨‹ï¼šaccept æ–°è¿æ¥
   |
hash / round-robin
   |
åˆ†å‘ fd åˆ°å¤šä¸ª IO çº¿ç¨‹
   |
æ¯ä¸ª IO çº¿ç¨‹ï¼šç‹¬ç«‹ epoll_wait
```

ğŸ‘‰ è¿™å°±æ˜¯å¾ˆå¤šé«˜æ€§èƒ½ç½‘ç»œåº“ï¼ˆmuduo / libevent / libev / nettyï¼‰çš„åŸºæœ¬æ¨¡å‹ã€‚

---

## 5ï¸âƒ£ ä½ è¿™ä»½ä»£ç çš„å·¥ç¨‹çº§è¯„ä»· ğŸ‘

ä¼˜ç‚¹ï¼š

* âœ… epoll_wait + äº‹ä»¶åˆ†å‘æ¨¡å‹æ­£ç¡®
* âœ… é”™è¯¯äº‹ä»¶å¤„ç†é½å…¨ï¼ˆERR/HUP/RDHUPï¼‰
* âœ… one loop per thread æ¶æ„åˆç†
* âœ… ET æ¨¡å¼é…å¥— recv å†™æ³•æ­£ç¡®

å·²ç»æ˜¯**â€œé«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹å…¥é—¨åˆ°ä¸­çº§â€æ°´å¹³**äº†ã€‚

---

## 6ï¸âƒ£ å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç‚¹ï¼ˆè¿›é˜¶ï¼‰

### âš ï¸ 1. close(fd) å‰æœ€å¥½ epoll_ctl DEL

è™½ç„¶å†…æ ¸åœ¨ close(fd) æ—¶ä¼šè‡ªåŠ¨ä» epoll ä¸­ç§»é™¤ï¼Œä½†å·¥ç¨‹é‡Œæ›´ä¸¥è°¨ï¼š

```cpp
epoll_ctl(efd_, EPOLL_CTL_DEL, fd, nullptr);
close(fd);
```

---

### âš ï¸ 2. EPOLLOUT ä¸åº”é•¿æœŸç›‘å¬

å·¥ç¨‹å®è·µä¸­ï¼š

* é»˜è®¤ä¸ç›‘å¬ EPOLLOUT
* åªæœ‰å½“ send è¿”å› EAGAINï¼ˆå†™ç¼“å†²åŒºæ»¡ï¼‰æ—¶ï¼Œæ‰ä¸´æ—¶æ³¨å†Œ EPOLLOUT
* å¯å†™åå†å–æ¶ˆç›‘å¬ï¼Œé¿å… busy loop

---

### âš ï¸ 3. alive_events æ¯æ¬¡å¾ªç¯ calloc/free

ä½ ç°åœ¨æ˜¯åœ¨å‡½æ•°å…¥å£ callocï¼Œä¸€æ¬¡å¾ªç¯ç»“æŸ freeï¼Œå…¶å®æ²¡é—®é¢˜ã€‚
ä½†æ›´é«˜æ€§èƒ½çš„åšæ³•ï¼š

* alive_events ä½œä¸ºæˆå‘˜å˜é‡
* åªåˆ†é…ä¸€æ¬¡ï¼Œå¾ªç¯å¤ç”¨

---

### âš ï¸ 4. epoll_wait è¿”å› 0 çš„å¤„ç†

å½“ `num == 0`ï¼š

* è¡¨ç¤ºè¶…æ—¶
* å¯ä»¥åšï¼š

  * å¿ƒè·³æ£€æµ‹
  * è¿æ¥æ¸…ç†
  * ç»Ÿè®¡

---

## 7ï¸âƒ£ ä¸€å¥è¯æ€»ç»“ä½ è¿™æ®µ EpollLoop

> **è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ Reactor äº‹ä»¶å¾ªç¯ï¼š
> epoll_wait æ‹‰äº‹ä»¶ï¼Œ
> for å¾ªç¯åˆ†å‘ï¼Œ
> OnSocketRead å¤„ç† IOï¼Œ
> close è´Ÿè´£è¿æ¥ç”Ÿå‘½å‘¨æœŸã€‚**

---

## ğŸš€ å¦‚æœä½ æƒ³è¿›é˜¶ä¸‹ä¸€æ­¥

æˆ‘å¯ä»¥å¸®ä½ è¡¥ä¸€ä¸ªå®Œæ•´æ¶æ„ç¤ºä¾‹ï¼š

ğŸ‘‰ epoll + accept + éé˜»å¡ socket + EPOLLET + å‘é€é˜Ÿåˆ— + ç²˜åŒ…åè®® + è¿æ¥ç®¡ç†

è¿™å¥—åŸºæœ¬å°±æ˜¯ä¸€ä¸ªâ€œè¿·ä½ ç‰ˆé«˜æ€§èƒ½ TCP å®¢æˆ·ç«¯/æœåŠ¡ç«¯æ¡†æ¶â€ã€‚
