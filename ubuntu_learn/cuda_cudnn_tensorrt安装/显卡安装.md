https://forums.developer.nvidia.com/t/nvidia-smi-no-devices-were-found-vmware-esxi-ubuntu-server-20-04-03-with-rtx3070/202904/42


https://blog.csdn.net/m0_46406504/article/details/140982294

----
1 配置bios显卡为discrete模式，而非混合模式
----

其他的一些配置

太好了，这个日志信息非常完整，我可以很明确地告诉你：

---

## 🚨 根本原因：

日志末尾核心报错是：

```
nvidia 0000:01:00.0: Unable to change power state from D3cold to D0, device inaccessible
NVRM: The NVIDIA GPU (PCI ID: 10de:24b7) installed in this system has fallen off the bus and is not responding to commands.
nvidia: probe of 0000:01:00.0 failed with error -1
NVRM: None of the NVIDIA devices were initialized.
```

意思是：

> 显卡在安装时被系统识别到了（PCI ID 存在），
> 但它处于 **D3cold（完全断电）状态**，驱动尝试唤醒失败，
> 所以显卡设备无法通信，也就无法加载 `nvidia.ko`。

---

## 🔍 问题来源可能有三种：

| 原因类型                | 说明                                                                        |
| ------------------- | ------------------------------------------------------------------------- |
| ⚙️ BIOS/ACPI 电源管理问题 | 一些笔记本或主板会让独显默认进入 D3cold（节能断电），需要内核参数禁用 ASPM。                              |
| 💡 混合显卡/Optimus 冲突  | 如果是笔记本（例如带 Intel + NVIDIA），nouveau 或 iGPU 驱动可能抢占设备。                       |
| 💾 硬件或固件兼容性         | 内核版本 6.8 对部分新 GPU（特别是移动 Ada 芯片，如 RTX 40 系列）有 “fallen off the bus” 已知 bug。 |

---

## ✅ 一步步解决方案

### **① 检查显卡是否在 PCI 总线上被识别**

执行：

```bash
lspci | grep -i nvidia
```

如果有输出（如 `01:00.0 3D controller: NVIDIA Corporation ...`），说明设备存在，只是未唤醒。
如果没有输出，那显卡被 ACPI 隐藏，需要调整 BIOS。

---

### **② 禁用 ASPM，防止显卡被挂起**

编辑 GRUB 配置文件：

```bash
sudo nano /etc/default/grub
```

找到这行：

```
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
```

修改为（在引号内添加内核参数）：

```
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash pci=noaer pcie_aspm=off"
```

保存并执行：

```bash
sudo update-grub
sudo reboot
```

---

### **③ 重启后重新加载驱动**

```bash
sudo modprobe nvidia
nvidia-smi
```

如果这次能显示 GPU 信息，说明成功。

---

### **④ 如果仍然失败，请再执行**

```bash
dmesg | grep -i nvidia | tail -n 30
```

我可以从内核日志中看出是 **ACPI 问题**、**PCI 电源管理问题** 还是 **nouveau 抢占问题**。

---

## 🧩 额外建议

* 如果你是 **笔记本电脑（特别是带 Intel 核显 + NVIDIA 独显）**，可以考虑安装：

  ```bash
  sudo apt install nvidia-driver-535
  ```

  这是 Ubuntu 官方 DKMS 驱动，会自动处理 ACPI 与 PCI 唤醒逻辑，比 `.run` 文件更稳定。

---

要不我帮你判断一下是 **笔记本混合显卡问题** 还是 **台式机 PCIe 唤醒问题**？
请贴一下这条命令输出：

```bash
lspci | grep -E "VGA|3D"
```
