ä¸‹é¢æˆ‘å¸®ä½  **é€è¡Œæ·±å…¥åˆ†æ `build_project` å‡½æ•°**ï¼Œè§£é‡Šå®ƒçš„åŠŸèƒ½ã€æµç¨‹ã€è°ƒç”¨æ–¹å¼å’Œ CMake ç¼–è¯‘é€»è¾‘ã€‚çœ‹å®Œä¹‹åä½ å°±èƒ½å®Œå…¨ç†è§£æ•´ä¸ªæ„å»ºæ¡†æ¶ã€‚

---

# ğŸš€ **æ€»ä½“ä½œç”¨**

`build_project()` çš„ä½œç”¨æ˜¯ï¼š

> **æ ¹æ®æŒ‡å®š toolchainï¼Œæ‰§è¡Œ cmake é…ç½®ï¼Œç„¶åæ‰§è¡Œ make -jN æ„å»ºé¡¹ç›®ã€‚**

è¿™æ˜¯æ•´ä¸ªç¼–è¯‘æµç¨‹çš„æ ¸å¿ƒã€‚

---

# ğŸ§© **1. æ¥æ”¶å‚æ•°**

```bash
local readonly build_root_path="$1"
local readonly build_target_path="$2"
local readonly toolchain_path="$3"
local readonly build_type="$4"
local readonly module_name="$5"
```

å‚æ•°æ„ä¹‰ï¼š

| å‚æ•°                | è¯´æ˜                          |
| ----------------- | --------------------------- |
| build_root_path   | é¡¹ç›®æ ¹ç›®å½•ï¼ˆä¾‹å¦‚ project/ï¼‰          |
| build_target_path | ç¼–è¯‘è¾“å‡ºç›®å½•ï¼ˆä¾‹å¦‚ project/target/ï¼‰  |
| toolchain_path    | CMake å·¥å…·é“¾æ–‡ä»¶ï¼ˆä¾‹å¦‚ linux.cmakeï¼‰ |
| build_type        | DEBUG / RELEASE             |
| module_name       | æ„å»ºæ¨¡å—åï¼Œå¦‚ allã€æŸä¸ªå­æ¨¡å—           |

è¿™äº›å‚æ•°ç”± build.sh ä¼ å…¥ï¼š

---

# ğŸ§© **2. å‚æ•°æ ¡éªŒ**

### ğŸ“Œ æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨

```bash
if [ ! -d "$build_root_path" ]; then
    echo "${FUNCNAME}: cannot find project root '$build_root_path'" >&2
    return 1
fi
```

### ğŸ“Œ æ£€æŸ¥ toolchain æ–‡ä»¶æ˜¯å¦å­˜åœ¨

```bash
if [ ! -f "$toolchain_path" ]; then
    echo "${FUNCNAME}: toolchain '$toolchain_path' does not exist" >&2
    return 1
fi
```

ç¡®ä¿ä¸ä¼šé”™è¯¯è°ƒç”¨ cmakeã€‚

---

# ğŸ§© **3. åˆ›å»ºè¾“å‡ºç›®å½•**

```bash
create_directory "$build_target_path"
```

è¿™ä¸ªå‡½æ•°ä¸€èˆ¬æ‰§è¡Œï¼š

```
mkdir -p target
```

---

# ğŸ§© **4. æ‰§è¡Œ CMake é…ç½®ï¼ˆéå¸¸å…³é”®ï¼‰**

```bash
exec_command "$build_target_path" "$(which_cmake)                               \
                                    -DCMAKE_TOOLCHAIN_FILE="$toolchain_path"    \
                                    -DCMAKE_BUILD_TYPE="$build_type"            \
                                    -DCMAKE_MODULE_NAME="$module_name"          \
                                    -DCMAKE_VERBOSE_MAKEFILE=0                  \
                                    "$build_root_path"                          \
                                  "
```

ç­‰ä»·äºï¼š

```
cd target
cmake \
    -DCMAKE_TOOLCHAIN_FILE=xxx.cmake \
    -DCMAKE_BUILD_TYPE=DEBUG \
    -DCMAKE_MODULE_NAME=all \
    -DCMAKE_VERBOSE_MAKEFILE=0 \
    ../
cd å›åŸè·¯å¾„
```

### ğŸ“Œ è§£ææ¯ä¸ªå‚æ•°

| å‚æ•°                         | è¯´æ˜            |
| -------------------------- | ------------- |
| -DCMAKE_TOOLCHAIN_FILE     | æŒ‡å®šå·¥å…·é“¾ï¼ˆäº¤å‰ç¼–è¯‘å…³é”®ï¼‰ |
| -DCMAKE_BUILD_TYPE         | Debug/Release |
| -DCMAKE_MODULE_NAME        | é¡¹ç›®éœ€è¦æ„å»ºçš„æ¨¡å—åç§°   |
| -DCMAKE_VERBOSE_MAKEFILE=0 | å…³é—­è¯¦ç»†ç¼–è¯‘è¾“å‡º      |
| build_root_path            | é€šå¸¸æ˜¯é¡¹ç›®æ ¹ç›®å½•      |

---

# ğŸ§© **5. è°ƒç”¨ make å¹¶è‡ªåŠ¨é€‰æ‹© CPU æ•°é‡**

```bash
exec_command "$build_target_path" "make -j$(get_core_number)"
```

ç­‰ä»·äºï¼š

```
cd target
make -j8   # å‡è®¾ CPU 8 æ ¸
cd å›åŸè·¯å¾„
```

æ„å»ºçœŸæ­£å¼€å§‹ã€‚

---

# ğŸ§© **6. å¯é€‰å®‰è£…æ­¥éª¤ï¼ˆå·²æ³¨é‡Šï¼‰**

```bash
# if [ "$build_type" == "DEBUG" ]; then
#     make install
# else
#     make install/strip
# fi
```

è¯´æ˜æ¡†æ¶æ”¯æŒï¼š

* å®‰è£…åº“åˆ°è¿è¡Œç›®å½•
* strip å»é™¤ç¬¦å·è¡¨ï¼ˆç¼©å°ä½“ç§¯ï¼‰

---

# ğŸ§µ **7. exec_command æ˜¯å¦‚ä½•è¿è¡Œå‘½ä»¤çš„ï¼Ÿ**

ä½ ä¹‹å‰çœ‹è¿‡ï¼š

```bash
exec_command wd cmd
```

å†…éƒ¨æœºåˆ¶ï¼š

```
pushd wd
cmd
popd
```

æ‰€ä»¥ cmake å’Œ make éƒ½æ˜¯åœ¨ target ç›®å½•è¿è¡Œçš„ã€‚

---

# ğŸ”¥ **å®Œæ•´æ‰§è¡Œæµç¨‹æ€»ç»“**

```
build.sh
  â†“
main()
  â†“
build_project()
  â†“
æ£€æŸ¥è·¯å¾„å’Œå·¥å…·é“¾
  â†“
create_directory target/
  â†“
exec_command("target", "cmake ...")
  â†“
exec_command("target", "make -jN")
  â†“
Build finished
```

è¿™æ˜¯ä¸€ä¸ªå…¸å‹ã€å¤§å‹å·¥ä¸šé¡¹ç›®çš„æ„å»ºæµç¨‹ã€‚

---

# ğŸ¯ **ä¸€å¥è¯æ€»ç»“**

`build_project()` å°±æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„ï¼š

* è¿›å…¥ target ç›®å½•
* è¿è¡Œ cmake é…ç½®
* è¿è¡Œ make ç¼–è¯‘
* é€€å‡ºç›®å½•

çš„ç»Ÿä¸€æ„å»ºæµç¨‹ã€‚

---

# ğŸ“Œ æƒ³ç»§ç»­æ·±å…¥å—ï¼Ÿ

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜å¯ä»¥å¸®ä½ è§£æï¼š

* `which_cmake` æ˜¯æ€ä¹ˆå®šä½ cmake çš„
* toolchain.cmake çš„å†…å®¹ï¼ˆäº¤å‰ç¼–è¯‘å…³é”®ï¼‰
* CMAKE_MODULE_NAME åœ¨ CMakeLists.txt ä¸­å¦‚ä½•ä½¿ç”¨
* å¦‚ä½•æ‰©å±• build ç³»ç»Ÿè®©å®ƒæ”¯æŒ QNXã€Yoctoã€ARM cross ç­‰

ä½ æƒ³ç»§ç»­å­¦ä¹ å“ªä¸€éƒ¨åˆ†ï¼Ÿ
