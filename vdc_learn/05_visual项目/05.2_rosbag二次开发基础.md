ä¸‹é¢æˆ‘ä¼šç³»ç»Ÿåœ°æ•™ä½  **ROS bag çš„åŸç† + ä½¿ç”¨æ–¹æ³• + å¦‚ä½•é€šè¿‡ C++ è¿›è¡ŒäºŒæ¬¡å¼€å‘**ï¼Œé€‚åˆä½ è¿™æ ·æƒ³å®æ“ã€æƒ³å†™ä»£ç çš„äººå­¦ä¹ ã€‚

æˆ‘ä¼šåˆ†æˆä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š

1. **Rosbag æ˜¯ä»€ä¹ˆã€èƒ½å¹²ä»€ä¹ˆï¼ˆå¿«é€Ÿç†è§£ï¼‰**
2. **å¸¸ç”¨ rosbag å‘½ä»¤ï¼ˆå½•åˆ¶ / å›æ”¾ / è¿‡æ»¤ï¼‰**
3. **C++ APIï¼šå¦‚ä½•åœ¨ç¨‹åºä¸­è¯»å– bag æ–‡ä»¶**
4. **C++ APIï¼šå¦‚ä½•å†™å…¥ bag æ–‡ä»¶**
5. **å¸¸è§å‘ & å·¥ç¨‹å®è·µå»ºè®®**

---

# 1. Rosbag æ˜¯ä»€ä¹ˆï¼Ÿ

rosbag æ˜¯ ROS1 ä¸­æœ€å¸¸ç”¨çš„æ•°æ®è®°å½•å·¥å…·ï¼Œç”¨æ¥ï¼š

* **å½•åˆ¶è¯é¢˜ï¼ˆtopicsï¼‰æ•°æ®åˆ° .bag æ–‡ä»¶**
* **å›æ”¾å½•åˆ¶çš„æ•°æ®ï¼ˆåƒæ•°æ®æ’­æ”¾å™¨ä¸€æ ·ï¼‰**
* **ç”¨ C++/Python è¯»å– / å†™å…¥ bag æ–‡ä»¶ï¼ˆæ•°æ®äºŒæ¬¡å¤„ç†ï¼‰**

å¸¸è§ç”¨é€”ï¼š

* ç¦»çº¿è°ƒè¯•ç®—æ³•ï¼ˆSLAMã€æ„ŸçŸ¥ã€æ§åˆ¶ï¼‰
* æ•°æ®é›†åˆ¶ä½œ
* å›æ”¾ä»¿çœŸåœºæ™¯
* å°† bag è½¬æ¢æˆè‡ªå®šä¹‰æ ¼å¼ï¼ˆä½ è¯´çš„ C++ äºŒæ¬¡å¼€å‘ï¼‰

---

# 2. rosbag çš„å¸¸ç”¨å‘½ä»¤

### â–¶ å½•åˆ¶æ‰€æœ‰è¯é¢˜

```bash
rosbag record -a
```

### â–¶ å½•åˆ¶ç‰¹å®šè¯é¢˜

```bash
rosbag record /camera/image_raw /imu/data
```

### â–¶ é™åˆ¶å¤§å° & è‡ªåŠ¨åˆ‡åŒ…

```bash
rosbag record -o mybag --split --size=1024 /topic
```

### â–¶ å›æ”¾

```bash
rosbag play dataset.bag
```

### â–¶ åŠ é€Ÿ / æ”¾æ…¢æ’­æ”¾é€Ÿåº¦

```bash
rosbag play dataset.bag -r 0.5   # åŠé€Ÿ
rosbag play dataset.bag -r 2.0   # ä¸¤å€é€Ÿ
```

### â–¶ åªå›æ”¾æŸäº›è¯é¢˜

```bash
rosbag play dataset.bag /camera/image_raw
```

---

# 3. **C++ è¯»å– bag æ–‡ä»¶ï¼ˆæœ€å¸¸ç”¨çš„äºŒæ¬¡å¼€å‘åŠŸèƒ½ï¼‰**

ä½ éœ€è¦åŒ…å« rosbagã€roscppï¼š

```cpp
#include <rosbag/bag.h>
#include <rosbag/view.h>
#include <sensor_msgs/Image.h>
#include <boost/foreach.hpp>
#define foreach BOOST_FOREACH

int main(int argc, char** argv)
{
    rosbag::Bag bag;
    bag.open("test.bag", rosbag::bagmode::Read);

    // åªè¯»å– image è¯é¢˜
    std::vector<std::string> topics;
    topics.push_back(std::string("/camera/image_raw"));

    rosbag::View view(bag, rosbag::TopicQuery(topics));

    foreach(rosbag::MessageInstance const m, view)
    {
        sensor_msgs::ImageConstPtr img = m.instantiate<sensor_msgs::Image>();
        if (img != nullptr)
        {
            std::cout << "Got image, size=" 
                      << img->width << "x" << img->height << std::endl;
        }
    }

    bag.close();
}
```

### â­ æ ¸å¿ƒç‚¹è§£é‡Šï¼š

| ç±»                                   | ä½œç”¨              |
| ----------------------------------- | --------------- |
| `rosbag::Bag`                       | æ‰“å¼€ / å†™å…¥ bag     |
| `rosbag::View`                      | éå† bag æ–‡ä»¶       |
| `MessageInstance::instantiate<T>()` | æŠŠæ¶ˆæ¯è½¬æ¢æˆæŸä¸ª ROS ç±»å‹ |

è¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œç”¨äºï¼š

* æå–å›¾åƒã€æ¿€å…‰ã€IMUã€ç‚¹äº‘
* è½¬æ¢æˆè‡ªå®šä¹‰æ ¼å¼
* ç¦»çº¿è·‘ç®—æ³•

---

# 4. **C++ å†™å…¥ bag æ–‡ä»¶ï¼ˆè‡ªå®šä¹‰å½•åˆ¶ï¼‰**

å¦‚æœä½ åšæ•°æ®é›†ç”Ÿæˆæˆ–å®æ—¶æ”¶é›†ï¼Œç”¨ä¸‹é¢ä»£ç ï¼š

```cpp
#include <ros/ros.h>
#include <rosbag/bag.h>
#include <std_msgs/String.h>

int main(int argc, char** argv)
{
    ros::init(argc, argv, "bag_write");
    ros::NodeHandle nh;

    rosbag::Bag bag;
    bag.open("output.bag", rosbag::bagmode::Write);

    std_msgs::String msg;
    msg.data = "hello rosbag";

    bag.write("/chatter", ros::Time::now(), msg);

    bag.close();
    return 0;
}
```

ä½ ä¹Ÿå¯ä»¥å†™å…¥ä»»æ„è‡ªå®šä¹‰æ¶ˆæ¯ï¼š

```cpp
my_custom_pkg::MyMsg m;
bag.write("/custom_topic", time, m);
```

---

# 5. å¸¸è§å‘ & å·¥ç¨‹å®è·µå»ºè®®

## ğŸ§± 1) è¯»å–å›¾åƒå¤ªæ…¢ï¼Ÿ

æ”¹æˆ zero-copyï¼š

```cpp
sensor_msgs::ImageConstPtr img =
    m.instantiate<sensor_msgs::Image>();
```

ä¸è¦å¤åˆ¶æ•°æ®ã€‚

---

## ğŸ§± 2) ç‚¹äº‘è½¬æ¢å¤±è´¥ï¼Ÿ

ç¡®è®¤ä½ ä½¿ç”¨çš„æ˜¯ï¼š

```cpp
sensor_msgs::PointCloud2
```

å¦‚æœä½ éœ€è¦ PCL ç±»å‹ï¼š

```cpp
pcl::fromROSMsg(*cloud_msg, pcl_cloud);
```

---

## ğŸ§± 3) å¤š topic æ··åˆéå†æ—¶æ¶ˆæ¯æ—¶é—´é¡ºåºæ··ä¹±ï¼Ÿ

ä½¿ç”¨ï¼š

```cpp
rosbag::View view(bag, rosbag::TopicQuery(topics), 
                  bag.getBeginTime(), bag.getEndTime());
```

---

## ğŸ§± 4) å¤§ bag å¯¼è‡´è¯»å–å¤ªæ…¢ï¼Ÿ

å»ºè®®ï¼š

* ä½¿ç”¨è¿‡æ»¤å™¨ç”Ÿæˆå° bagï¼š

```bash
rosbag filter input.bag output.bag "topic == '/camera/image_raw'"
```

* ä½¿ç”¨ C++ æŒ‰æ—¶é—´åŒºé—´è¿‡æ»¤

---

# æƒ³ç»§ç»­å­¦ä¹ å“ªä¸ªéƒ¨åˆ†ï¼Ÿ

æˆ‘å¯ä»¥è¿›ä¸€æ­¥æ•™ä½ ï¼š

### âœ” æ•™ä½ ç¼–å†™ä¸€ä¸ªâ€œbag è½¬å›¾ç‰‡æ–‡ä»¶å¤¹â€çš„å°å·¥å…·

ï¼ˆå¾ˆå¸¸ç”¨ï¼Œç”¨ C++å¯¼å‡ºå›¾åƒï¼‰

### âœ” æ•™ä½ ä» bag ä¸­æå–ç‚¹äº‘ã€IMUã€GPS

### âœ” å†™ä¸€ä¸ªâ€œbag æ—¶é—´åŒæ­¥å™¨â€ï¼ˆç”¨äºä¼ æ„Ÿå™¨èåˆï¼‰

### âœ” å†™ä¸€ä¸ªå¤šçº¿ç¨‹ BAG æ’­æ”¾å™¨ï¼ˆç±»ä¼¼ rosbag playï¼‰

ä½ å‘Šè¯‰æˆ‘ä½ ä¸‹ä¸€æ­¥æƒ³åšå“ªä¸ªï¼Œæˆ‘ç»™ä½ å®Œæ•´çš„ C++ å·¥ç¨‹æ¨¡æ¿ã€‚
