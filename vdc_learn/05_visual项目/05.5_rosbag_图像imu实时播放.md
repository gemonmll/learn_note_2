ä¸‹é¢æˆ‘ä¼šç»™ä½ ä¸€ä¸ª**å®Œæ•´ã€å·¥ç¨‹çº§ã€å¯ç›´æ¥è¿è¡Œçš„ä¾‹å­**ï¼Œå®ç°ä½ è¦çš„ï¼š

# âœ… **ã€ç›®æ ‡ã€‘å›¾åƒ + IMU ç¦»çº¿ â†’ å®æ—¶åŒæ­¥æ’­æ”¾ï¼ˆæ¨¡æ‹ŸçœŸå®ä¼ æ„Ÿå™¨æ”¶å‘ï¼‰**

è¿™ä¸ªä¾‹å­ä¼šåšåˆ°ï¼š

* âš¡ **æŒ‰çœŸå®æ—¶é—´èŠ‚å¥æ’­æ”¾ï¼ˆæ¨¡æ‹ŸçœŸå®ç›¸æœº / IMU è¾“å‡ºï¼‰**
* â±ï¸ **æ ¹æ® header.stamp è‡ªåŠ¨æ—¶é—´åŒæ­¥**
* ğŸ¯ **æ’åºä¸åŒ topic çš„æ¶ˆæ¯å¹¶æŒ‰æ—¶é—´é¡ºåºå‘å¸ƒ**
* ğŸ”§ **å›¾åƒ 30Hzã€IMU 200Hz è‡ªåŠ¨å¼‚æ­¥å‘é€**
* ğŸ’¡ **å®Œå…¨ä»¿çœŸçœŸå®è®¾å¤‡æ”¶å‘è¡Œä¸º**

ä½ å¯ä»¥ç›´æ¥æ”¾åˆ°å·¥ç¨‹é‡Œè¿è¡Œã€‚

---

# ğŸ“Œ **ä¸€ã€æ€»ä½“è®¾è®¡å›¾**

```
        bag æ–‡ä»¶ï¼ˆç¦»çº¿ï¼‰
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ /camera/image  â”‚ 30Hz
     â”‚ /imu/data      â”‚ 200Hz
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
       ã€ç¦»çº¿è¯»å– + æ’åºã€‘
               â”‚
               â–¼
    ã€æŒ‰æ—¶é—´æˆ³ dt=stamp(i)-stamp(i-1) sleepã€‘
               â”‚
               â–¼
      å®æ—¶å‘é€ï¼ˆä¸çœŸè®¾å¤‡ä¸€è‡´ï¼‰
```

---

# ğŸ“Œ **äºŒã€æ ¸å¿ƒé€»è¾‘è¯´æ˜**

### âœ” 1. è¯»å–æ‰€æœ‰æ¶ˆæ¯

ä» bag ä¸­æŠŠ image å’Œ imu éƒ½è¯»å‡ºæ¥ã€‚

### âœ” 2. æŒ‰ header.stamp æ’åº

çœŸå®ç³»ç»Ÿæ¶ˆæ¯æ˜¯æŒ‰æ—¶é—´åˆ°è¾¾çš„ã€‚

### âœ” 3. é€æ¡æŒ‰çœŸå®æ—¶é—´é—´éš”æ’­æ”¾

å‡è®¾å½“å‰æ¶ˆæ¯æ—¶é—´æ˜¯ t1ï¼Œä¸‹ä¸€æ¡æ˜¯ t2ï¼š

```
sleep(t2 â€“ t1)
publish(next_msg)
```

è¿™æ ·**å®Œå…¨æ¨¡æ‹ŸçœŸå®é¢‘ç‡**ã€‚

---

# ğŸ“Œ **ä¸‰ã€å®Œæ•´ C++ ä»£ç ï¼ˆå¯ç›´æ¥è¿è¡Œï¼‰**

> æ–‡ä»¶åï¼š`real_time_replay.cpp`

```cpp
#include <ros/ros.h>
#include <rosbag/bag.h>
#include <rosbag/view.h>
#include <sensor_msgs/Image.h>
#include <sensor_msgs/Imu.h>
#include <boost/foreach.hpp>
#include <queue>

#define foreach BOOST_FOREACH

struct MsgWrap
{
    ros::Time stamp;
    rosbag::MessageInstance msg;
};

int main(int argc, char** argv)
{
    ros::init(argc, argv, "real_time_replay");
    ros::NodeHandle nh;

    ros::Publisher pub_img = nh.advertise<sensor_msgs::Image>("/camera", 10);
    ros::Publisher pub_imu = nh.advertise<sensor_msgs::Imu>("/imu", 100);

    std::string bag_path = "/home/user/data.bag";
    rosbag::Bag bag;
    bag.open(bag_path, rosbag::bagmode::Read);

    // è¦è¯»å–çš„ topic
    std::vector<std::string> topics;
    topics.push_back("/camera/image_raw");
    topics.push_back("/imu/data");

    rosbag::View view(bag, rosbag::TopicQuery(topics));

    // æ‰€æœ‰æ¶ˆæ¯ç¼“å­˜
    std::vector<MsgWrap> buffer;

    // 1) è¯»å‡ºæ‰€æœ‰æ•°æ®
    foreach (rosbag::MessageInstance const m, view)
    {
        MsgWrap w;
        w.msg = m;

        if (m.isType<sensor_msgs::Image>())
        {
            auto img = m.instantiate<sensor_msgs::Image>();
            w.stamp = img->header.stamp;
        }
        else if (m.isType<sensor_msgs::Imu>())
        {
            auto imu = m.instantiate<sensor_msgs::Imu>();
            w.stamp = imu->header.stamp;
        }
        buffer.push_back(w);
    }

    // 2) æŒ‰æ—¶é—´æˆ³æ’åº
    std::sort(buffer.begin(), buffer.end(),
        [](const MsgWrap& a, const MsgWrap& b){
            return a.stamp < b.stamp;
        });

    ROS_INFO("Loaded %lu messages, starting playback...", buffer.size());

    ros::Time last_stamp = buffer.front().stamp;

    // 3) é€æ¡æŒ‰çœŸå®æ—¶é—´å‘é€
    for (auto& w : buffer)
    {
        ros::Duration dt = w.stamp - last_stamp;

        if (dt.toSec() > 0)
            dt.sleep();   // å…³é”®ï¼šæ¨¡æ‹ŸçœŸå®è®¾å¤‡çš„æ—¶é—´é—´éš”

        last_stamp = w.stamp;

        // æ ¹æ®ç±»å‹å‘å¸ƒ
        if (w.msg.isType<sensor_msgs::Image>())
        {
            sensor_msgs::ImageConstPtr img = w.msg.instantiate<sensor_msgs::Image>();
            pub_img.publish(*img);
        }
        else if (w.msg.isType<sensor_msgs::Imu>())
        {
            sensor_msgs::ImuConstPtr imu = w.msg.instantiate<sensor_msgs::Imu>();
            pub_imu.publish(*imu);
        }

        ros::spinOnce();
    }

    bag.close();
    return 0;
}
```

---

# ğŸ“Œ å››ã€è¿™ä¸ªç¨‹åºèƒ½åšåˆ°ä»€ä¹ˆï¼Ÿ

### âœ” 1. å®Œæ•´æ¨¡æ‹ŸçœŸå®ç›¸æœº + IMU è¾“å‡º

å’ŒçœŸå®ç¡¬ä»¶å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œç®—æ³•å®Œå…¨æ„Ÿå—ä¸åˆ°å·®åˆ«ã€‚

### âœ” 2. æŒ‰ç…§ bag ä¸­çœŸå®æ—¶é—´æˆ³èŠ‚å¥å‘é€

* å¦‚æœå›¾åƒé—´éš”æ˜¯ 33ms â†’ æŒ‰ 33ms å‘é€
* IMU é—´éš” 5ms â†’ æŒ‰ 5ms å‘é€

### âœ” 3. å¤š topic çš„çœŸå®æ—¶é—´å…³ç³»å®Œå…¨ä¿æŒ

å¦‚æœ IMU æ—¶é—´æ—©äºå›¾åƒï¼Œå®ƒä¼šå…ˆå‘ã€‚
IMU é«˜é¢‘ä¾æ—§ä¿æŒé«˜é¢‘ç‰¹æ€§ã€‚

éå¸¸é€‚åˆï¼š

* SLAM
* VIOï¼ˆè§†è§‰æƒ¯æ€§ odometryï¼‰
* æ„ŸçŸ¥ç®—æ³•è°ƒè¯•
* å¤šä¼ æ„Ÿå™¨èåˆ

---

# ğŸ“Œ äº”ã€è¿è¡Œæ–¹æ³•

å‡è®¾ä½ å·²ç»æœ‰ä¸€ä¸ª bag æ–‡ä»¶ï¼š

```bash
rosrun my_pkg real_time_replay
```

ç„¶åç”¨ï¼š

```bash
rostopic echo /imu
rqt_image_view
```

ä½ ä¼šçœ‹åˆ°ä»¿ä½›ç¡¬ä»¶çœŸçš„åœ¨å®æ—¶è¾“å‡ºã€‚

---

# ğŸ“Œ å…­ã€å¯é€‰å¢å¼ºï¼ˆä½ æƒ³è¦æˆ‘å¯ä»¥ç»™ä½ ä»£ç ï¼‰

| åŠŸèƒ½              | æè¿°                                  |
| --------------- | ----------------------------------- |
| â• å¤šçº¿ç¨‹æ’­æ”¾         | æ¯ä¸ª topic ç‹¬ç«‹èŠ‚å¥ï¼Œé€¼çœŸåº¦æ›´é«˜                 |
| â• å€é€Ÿæ’­æ”¾          | ä¾‹å¦‚ 2x é€Ÿåº¦è°ƒè¯•                          |
| â• å®æ—¶ä»¿çœŸæ—¶é’Ÿ        | è®© ROS çš„ `ros::Time::now()` ä¸ bag åŒæ­¥ |
| â• è‡ªåŠ¨å¾ªç¯æ’­æ”¾        | æ•°æ®é›†æ— é™å¾ªç¯                             |
| â• æŒ‡å®šæ—¶é—´æ®µæ’­æ”¾       | åªæ’­æ”¾ bag çš„ä¸€éƒ¨åˆ†                        |
| â• å»¶æ—¶è¡¥å¿ / æ—¶é—´æ¼‚ç§»ä¿®æ­£ | é€‚åˆçœŸå®ç³»ç»Ÿæ¨¡æ‹Ÿ                            |

---

# ğŸ¯ ä½ æƒ³è®©æˆ‘ç»§ç»­æ‰©å±•å“ªä¸€éƒ¨åˆ†ï¼Ÿ

ä¾‹å¦‚ï¼š

* è¦ä¸è¦åš **å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼ˆæ›´çœŸå®ï¼Œç¡¬ä»¶ä¸€èˆ¬å¤šçº¿ç¨‹ï¼‰**ï¼Ÿ
* è¦ä¸è¦åš **å€é€Ÿæ’­æ”¾ / æš‚åœ / å¿«è¿›**ï¼Ÿ
* è¦ä¸è¦åš **æŒ‰æ—¶é—´çª—å£åŒæ­¥ï¼ˆIMU é¢„ç§¯åˆ†åœºæ™¯ï¼‰**ï¼Ÿ
* è¦ä¸è¦åš **component æ¨¡å—åŒ–ï¼ˆå°è£…æˆå¯å¤ç”¨åº“ï¼‰**ï¼Ÿ

å‘Šè¯‰æˆ‘ä½ çš„æ–¹å‘ï¼Œæˆ‘ç»™ä½ ä¸‹ä¸€æ­¥çš„å·¥ç¨‹ä»£ç ã€‚
