
ä½ é—®çš„ **â€œæ¨¡æ‹ŸçœŸå®æ—¶é—´æ”¶å‘â€** æ˜¯ ROS / ç¦»çº¿æ•°æ®å¤„ç†é‡Œéå¸¸æ ¸å¿ƒã€åˆéå¸¸å®¹æ˜“æé”™çš„ä¸€ä¸ªç‚¹ã€‚

ä½ æƒ³åšçš„åœºæ™¯ä¸€èˆ¬æ˜¯ï¼š

> è¯»å– rosbagï¼ˆæˆ–ç¦»çº¿æ–‡ä»¶ï¼‰ï¼Œä½†å¸Œæœ›åƒçœŸå®è®¾å¤‡ä¸€æ ·ä»¥ **å®æ—¶èŠ‚å¥** è¾“å‡ºæ•°æ®ï¼Œè€Œä¸æ˜¯è¯»æ–‡ä»¶æ—¶ä¸€ä¸‹å­å…¨éƒ¨è¯»å®Œã€‚

è¿™å¸¸ç”¨äºï¼š

* ç¦»çº¿æ•°æ® â†’ å®æ—¶ç®—æ³•è°ƒè¯•
* æ²¡æœ‰çœŸå®ä¼ æ„Ÿå™¨æ—¶ï¼Œç”¨ bag æ¨¡æ‹Ÿåœ¨çº¿è¿è¡Œ
* æ¨¡æ‹Ÿç¡¬ä»¶æ¥å…¥èŠ‚å¥ï¼ˆç›¸æœº 30Hzã€IMU 200Hzï¼‰
* å®æ—¶ä»¿çœŸ / å›æ”¾ç®—æ³•

æˆ‘ä¼šç»™ä½  **åŸºæœ¬æ¦‚å¿µã€æ—¶é—´æ§åˆ¶é€»è¾‘ã€C++ å®ç°ä»£ç **ã€‚

---

# ğŸ”¥ è¦ç‚¹æ€»ç»“ï¼šçœŸå®æ—¶é—´æ”¶å‘ = æ—¶é—´åŒæ­¥ + èŠ‚å¥æ§åˆ¶

ä¸€ä¸ªçœŸå®ä¼ æ„Ÿå™¨ç³»ç»Ÿæ»¡è¶³ï¼š

* **æŒ‰å›ºå®šé¢‘ç‡è¾“å‡º**ï¼ˆä¾‹å¦‚ IMU 200Hz = 5ms ä¸€å¸§ï¼‰
* **æœ‰æ—¶é—´æˆ³ stamp**
* **æ—¶é—´æ˜¯é€’å¢çš„**
* **ä¸èƒ½æ— é™å¿«è¾“å‡ºï¼Œå¦åˆ™ç®—æ³•ä¸çœŸå®**

è¦æ¨¡æ‹Ÿè¿™ä¸ªè¡Œä¸ºï¼Œä½ çš„ç¨‹åºå¿…é¡»åšåˆ°ä¸¤ä»¶äº‹ï¼š

---

# â­ 1. **ä½¿ç”¨æ¶ˆæ¯çš„ header.stamp ä½œä¸ºâ€œçœŸå®ä¸–ç•Œæ—¶é—´â€**

æ¯ä¸€æ¡æ•°æ®åŸæ¥å½•åˆ¶è¿› bag çš„æ—¶é—´æˆ³ï¼š

```
img->header.stamp = 1679382023.123456
```

è¿™ä¸ªæ—¶é—´æˆ³æ˜¯çœŸå®ç¡¬ä»¶çš„æ—¶é—´ï¼ˆsensor timeï¼‰ã€‚

æˆ‘ä»¬æ¨¡æ‹Ÿæ—¶åº”å½“æŒ‰ç…§è¿™ä¸ªæ—¶é—´é¡ºåºè¾“å‡ºã€‚

---

# â­ 2. **æ ¹æ®æ—¶é—´å·®ä¼‘çœ ï¼ˆsleepï¼‰â†’ è¿˜åŸçœŸå®èŠ‚å¥**

ä¾‹å¦‚ bag ä¸­ä¸¤å¸§å›¾åƒï¼š

```
t1 = 1.000s
t2 = 1.033s
```

é‚£ä¹ˆä½ è¦ç­‰å¾…ï¼š

```
sleep(t2 - t1) = 0.033s
```

è¿™æ ·è¾“å‡ºé¢‘ç‡å°±å’ŒçœŸå®è®¾å¤‡å®Œå…¨ä¸€è‡´ã€‚

---

# âœ¨ å®ç°æ€è·¯ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰

å‡è®¾æˆ‘ä»¬ç¦»çº¿è¯»å–æ¶ˆæ¯ï¼š

```
ä¸Šä¸€å¸§æ—¶é—´ last_time
å½“å‰å¸§æ—¶é—´ current_time
```

åˆ™çœŸå®æ—¶é—´ä¼‘çœ ï¼š

```cpp
double dt = (current_time - last_time).toSec();
ros::Duration(dt).sleep();
```

è¿™å°±æ˜¯æ¨¡æ‹ŸçœŸå®æ”¶å‘çš„æ ¸å¿ƒï¼

ä½ å¯ä»¥æŠŠè¿™ä¸ªé€»è¾‘ç”¨åœ¨ï¼š

* bag æ’­æ”¾ï¼ˆè‡ªå®šä¹‰ playerï¼‰
* IMU å›æ”¾
* å¤š topic åŒæ­¥æ’­æ”¾
* æ¨¡æ‹Ÿ CAN æ•°æ® / lidar æ•°æ®
* SLAMã€æ„ŸçŸ¥ç®—æ³•æµ‹è¯•

---

# â­ å®ç°è¦ç‚¹ï¼šä¸èƒ½ä½¿ç”¨ wall clock æ—¶é—´

çœŸå®æ—¶é—´æ¨¡æ‹Ÿåº”è¯¥åŸºäºï¼š

```
sensor_timestamp
```

è€Œä¸æ˜¯è®¡ç®—æœºå½“å‰æ—¶é—´ã€‚

---

# ğŸ’¡ C++ å®Œæ•´ç¤ºä¾‹ï¼šæ¨¡æ‹Ÿç›¸æœº 30Hz æ’­æ”¾

ä¸‹é¢ä»£ç è¯»å– bagï¼Œå¹¶â€œåƒçœŸå®ç›¸æœºä¸€æ ·â€å‘å‡ºå›¾åƒã€‚

```cpp
#include <ros/ros.h>
#include <rosbag/bag.h>
#include <rosbag/view.h>
#include <sensor_msgs/Image.h>

int main(int argc, char** argv)
{
    ros::init(argc, argv, "real_time_player");
    ros::NodeHandle nh;

    ros::Publisher pub_img = nh.advertise<sensor_msgs::Image>("/camera", 10);

    rosbag::Bag bag;
    bag.open("dataset.bag", rosbag::bagmode::Read);

    rosbag::View view(bag);

    ros::Time last_time = ros::TIME_MIN;

    for (const rosbag::MessageInstance &m : view)
    {
        sensor_msgs::ImageConstPtr img = m.instantiate<sensor_msgs::Image>();
        if (img == nullptr) continue;

        // ç¬¬ä¸€æ¬¡ä¸ sleep
        if (last_time.toSec() > 0) {
            ros::Duration(img->header.stamp - last_time).sleep();
        }

        last_time = img->header.stamp;

        pub_img.publish(*img);
        ros::spinOnce();
    }

    bag.close();
    return 0;
}
```

è¿™ä¸ªç¨‹åºå®ç°äº†ï¼š

âœ” æŒ‰ bag æ–‡ä»¶çœŸå®æ—¶é—´è¾“å‡º
âœ” æ¨¡æ‹Ÿç›¸æœºçœŸå®å¸§ç‡
âœ” å¯ç›´æ¥å–‚å…¥ä»»æ„éœ€è¦å®æ—¶è¾“å…¥çš„ç®—æ³•

å¦‚æœä½ æŠŠ bag æ”¹æˆ IMU topicï¼Œä¹Ÿä¸€æ ·ä¼šè‡ªç„¶æŒ‰ 200Hz æ’­æ”¾ã€‚

---

# â­ å¤šè¯é¢˜åŒæ­¥ + æ¨¡æ‹ŸçœŸå®æ—¶é—´ï¼ˆå®Œå…¨å·¥ç¨‹ç‰ˆï¼‰

å¦‚æœåŒæ—¶æ¨¡æ‹Ÿ IMU + Imageï¼š

* ä½ åº”è¯¥å°†æ‰€æœ‰æ¶ˆæ¯æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—
* æŒ‰ **header.stamp å‡åº** æ’åˆ—
* æ¯æ¬¡å¤„ç†ä¸‹ä¸€æ¡æœ€æ—©çš„
* æŒ‰æ—¶é—´å·® sleep

ä¼ªä»£ç å¦‚ä¸‹ï¼š

```cpp
std::vector<MessageWrapper> all_msgs;

// è¯»å–æ‰€æœ‰ topic
for img in bag: all_msgs.push(...)
for imu in bag: all_msgs.push(...)

// æ ¹æ®æ—¶é—´æˆ³æ’åº
sort(all_msgs.begin(), all_msgs.end(), by timestamp);

ros::Time last_t = all_msgs[0].stamp;

for msg in all_msgs:
    ros::Duration(msg.stamp - last_t).sleep();
    publish(msg);
    last_t = msg.stamp;
```

ä½œç”¨ï¼š

âœ” æ¨¡æ‹ŸçœŸå®ç³»ç»Ÿä¸­å¤šä¼ æ„Ÿå™¨çš„å¼‚æ­¥æ¶ˆæ¯æµ
âœ” å„ topic çš„ç›¸å¯¹æ—¶é—´å…³ç³»å®Œå…¨ä¿æŒ
âœ” ç”¨äºä»¿çœŸå¤šä¼ æ„Ÿå™¨ SLAM / æ„ŸçŸ¥ç®—æ³•éå¸¸å…³é”®

---

# ğŸ”¥ é«˜çº§å¢å¼ºï¼šå€é€Ÿæ’­æ”¾ï¼ˆæ¯” rosbag play æ›´çµæ´»ï¼‰

ä¾‹å¦‚ 2 å€é€Ÿï¼š

```cpp
double speed = 2.0;
ros::Duration((msg.stamp - last_t).toSec() / speed).sleep();
```

ä½ å¯ä»¥ï¼š

* åŠé€Ÿæ£€æŸ¥ debug
* 4xã€8x è·‘ SLAM å¤ç°
* 0.1x æ…¢æ”¾éªŒè¯æ—¶é—´åŒæ­¥

---

# ğŸ”¥ é«˜çº§å¢å¼ºï¼šçœŸå®ç¡¬ä»¶æ—¶é—´å¯¹é½

å¦‚æœä½ å¸Œæœ›å¼€å§‹æ’­æ”¾çš„â€œè™šæ‹Ÿæ—¶é—´â€å¯¹é½å½“å‰ç³»ç»Ÿæ—¶é—´ï¼š

```cpp
ros::Time base_real = ros::Time::now();
ros::Time base_bag  = first_msg.stamp;

ros::Duration((msg.stamp - base_bag) - (ros::Time::now() - base_real)).sleep();
```

è¿™èƒ½åšåˆ°ï¼š

âœ” bag æ’­æ”¾è¿‡ç¨‹ä¸­ï¼Œmsg.stamp ä¸ ros::Time::now() ä¿æŒä¸€è‡´
âœ” æ¨¡æ‹ŸçœŸæ­£çš„åœ¨çº¿ç³»ç»Ÿ
âœ” åƒ rosbag play ä¸€æ ·æ‹¥æœ‰â€œä»¿çœŸæ—¶é’Ÿâ€

---

# ğŸ¯ ä½ æ¥ä¸‹æ¥æƒ³å®ç°å“ªä¸€ç§ï¼Ÿ

æˆ‘å¯ä»¥ç»™ä½ å®Œæ•´çš„ C++ å·¥ç¨‹æ¨¡æ¿ï¼š

### 1ï¸âƒ£ å›¾åƒ + IMU ç¦»çº¿ â†’ å®æ—¶åŒæ­¥æ’­æ”¾å™¨ï¼ˆå¤šçº¿ç¨‹ï¼‰

### 2ï¸âƒ£ å¤š topic æ—¶é—´å½’ä¸€åŒ– + é‡æ”¾ç³»ç»Ÿï¼ˆåƒ rosbag playï¼‰

### 3ï¸âƒ£ æŠŠ bag è½¬æˆçœŸå®ç¡¬ä»¶çš„ socket/CAN æ¶ˆæ¯æµ

### 4ï¸âƒ£ çœŸæœºä¸Šå®æ—¶å›æ”¾æ„ŸçŸ¥æ•°æ®ï¼ˆç”¨äºç®—æ³•è°ƒè¯•ï¼‰

ä½ æƒ³åšå“ªç§ï¼Ÿæˆ‘å¯ä»¥ç»™ä½ å®Œæ•´ CMakeLists + ä»£ç ç›®å½• + å®ç°ç»†èŠ‚ã€‚
