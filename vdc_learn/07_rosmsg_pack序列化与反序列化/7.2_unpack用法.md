å¥½ï¼Œæˆ‘ä»¬è¿™æ¬¡å°±**åªè®¤çœŸè®² `msgpack::unpack`**ï¼ŒæŒ‰â€œèƒ½ç›´æ¥å†™è¿›å·¥ç¨‹é‡Œçš„æ•™ç¨‹â€æ¥è®²ä¸€éï¼Œå°½é‡ç³»ç»Ÿä¸€ç‚¹ã€‚

---

## 1. `msgpack::unpack` åˆ°åº•å¹²ä»€ä¹ˆï¼Ÿ

ä¸€å¥è¯ï¼š

> **`msgpack::unpack` = ä»ä¸€æ®µè¿ç»­çš„ MessagePack äºŒè¿›åˆ¶å†…å­˜é‡Œï¼Œè§£æå‡ºä¸€ä¸ª `msgpack::object_handle`ã€‚**

ç„¶åä½ å†æŠŠ `object_handle` é‡Œçš„ `object` è½¬æˆä½ çš„ C++ ç±»å‹ï¼ˆ`struct` / `std::vector` / `map` / åŸºæœ¬ç±»å‹ï¼‰ã€‚

å…¸å‹æµç¨‹ï¼š

```cpp
msgpack::object_handle oh = msgpack::unpack(data, len);
msgpack::object obj = oh.get();

YourType value;
obj.convert(value);   // æˆ– value = obj.as<YourType>();
```

---

## 2. å¸¸ç”¨é‡è½½ï¼šä½ å¹³æ—¶å°±ç”¨è¿™ä¸¤ç§å°±å¤Ÿäº†

### 2.1 æœ€ç®€å•ç‰ˆæœ¬ï¼šåªè§£æä¸€ä¸ªå¯¹è±¡

```cpp
msgpack::object_handle unpack(const char* data, std::size_t len);
```

ç”¨é€”ï¼š**buffer é‡Œé¢åªæœ‰ä¸€ä¸ªå®Œæ•´çš„ msgpack å¯¹è±¡**ã€‚

ç¤ºä¾‹ï¼š

```cpp
const char* buf = ...;  // æ”¶åˆ°çš„äºŒè¿›åˆ¶
std::size_t len = ...;

msgpack::object_handle oh = msgpack::unpack(buf, len);
msgpack::object obj = oh.get();

MyStruct s;
obj.convert(s);
```

---

### 2.2 å¸¦ `offset` çš„ç‰ˆæœ¬ï¼šä¸€ä¸ª buffer é‡Œæœ‰å¤šæ¡ msgpack

```cpp
msgpack::object_handle unpack(const char* data,
                              std::size_t len,
                              std::size_t& offset);
```

* `offset`ï¼šè¾“å…¥æ—¶æ˜¯â€œå½“å‰ä»å“ªé‡Œå¼€å§‹è§£æâ€ï¼Œè¾“å‡ºæ—¶â€œå·²ç»è§£æåˆ°å“ªé‡Œï¼ˆä¸‹ä¸€ä¸ªæ¶ˆæ¯èµ·å§‹ï¼‰â€
* å¸¸ç”¨åœ¨ï¼š**ä¸€ä¸ª buffer / æ–‡ä»¶ / å…±äº«å†…å­˜é‡Œä¸²äº†å¾ˆå¤šæ¡ msgpack æ¶ˆæ¯**

ç¤ºä¾‹ï¼šä» rosbag é‡Œè¯»å‡ºä¸€å¤§å— msgpack æ•°æ®ï¼Œé‡Œé¢è¿ç»­å¡äº†å¤šå¸§ï¼š

```cpp
const char* buf = ...;
std::size_t len = ...;

std::size_t offset = 0;
while (offset < len) {
    msgpack::object_handle oh = msgpack::unpack(buf, len, offset);
    msgpack::object obj = oh.get();

    Frame frame;
    obj.convert(frame);

    handle_frame(frame);
}
```

`offset` æ¯æ¬¡ä¼šå¾€åè·³ï¼Œç›´åˆ°ç­‰äº `len` ä¸ºæ­¢ã€‚

---

## 3. `unpack` ä¹‹åå¦‚ä½•å˜æˆ C++ å¯¹è±¡ï¼Ÿ

`unpack` è¿”å›çš„æ˜¯ `msgpack::object_handle`ï¼Œä½ è¦åšä¸¤æ­¥ï¼š

```cpp
msgpack::object_handle oh = msgpack::unpack(buf, len);
msgpack::object obj = oh.get();
```

ç„¶åæœ‰ä¸‰ç§å…¸å‹ç©æ³•ï¼š

### 3.1 æ¨èï¼š`convert(T&)`

è¦æ±‚ä½ çš„ç±»å‹æœ‰ `MSGPACK_DEFINE(...)` æˆ–ç‰¹åŒ– `msgpack::adaptor`ã€‚

```cpp
MyStruct s;
obj.convert(s);
```

### 3.2 ç®€æ´ä¸€ç‚¹ï¼š`as<T>()`

å†…éƒ¨å…¶å®ä¹Ÿæ˜¯ convertï¼Œä¸€èˆ¬åœºæ™¯å¤Ÿç”¨ï¼š

```cpp
MyStruct s = obj.as<MyStruct>();
```

### 3.3 æ‰‹åŠ¨æ‹†å­—æ®µï¼ˆæ€§èƒ½ / è°ƒè¯•ï¼‰

ä¾‹å¦‚ä½ çŸ¥é“å¤–é¢æ˜¯ä¸€ä¸ª arrayï¼š

```cpp
if (obj.type == msgpack::type::ARRAY) {
    auto& arr = obj.via.array;
    for (uint32_t i = 0; i < arr.size; ++i) {
        int v = arr.ptr[i].as<int>();
        ...
    }
}
```

---

## 4. å’Œä½ çš„ä¸šåŠ¡é æ‹¢ä¸€ç‚¹ï¼šè§£æ `std::vector<std::shared_ptr<RadarInjectInfo>>`

ä½ åˆšæ‰ pack çš„æ˜¯ï¼š

```cpp
std::vector<std::shared_ptr<RadarInjectInfo>> radar_inject_vector;
p.pack(radar_inject_vector);
```

æ¶ˆè´¹ç«¯ unpack å†™æ³•å°±æ˜¯ï¼š

### 4.1 å®šä¹‰ç±»å‹æ”¯æŒ msgpack

æ¯”è¾ƒå¸¸è§çš„å†™æ³•æ˜¯ï¼šå¯¹åº•å±‚ç»“æ„ä½“åš MSGPACK_DEFINEï¼Œå¯¹ `shared_ptr` ç”¨è‡ªå®šä¹‰é€‚é…å™¨æˆ–è€…è½¬æˆè£¸å¯¹è±¡å†å­˜ã€‚

ç®€å•ä¸€ç‚¹ï¼ˆç¤ºæ„ï¼‰ï¼š

```cpp
struct RadarInjectInfo {
    uint64_t gtc_tick;
    uint64_t utc_tick;
    perception::Radar info;

    MSGPACK_DEFINE(gtc_tick, utc_tick, info);
};
```

å¦‚æœä½  pack æ—¶ç”¨çš„æ˜¯ `std::shared_ptr<RadarInjectInfo>`ï¼Œé€šå¸¸ä¼šåœ¨å¤–é¢åŒ…ä¸€å±‚é€‚é…é€»è¾‘ï¼Œæ¯”å¦‚ï¼š

* pack æ—¶æŠŠ `shared_ptr` è§£å¼•ç”¨ï¼ˆå­˜æˆå¯¹è±¡ï¼‰
* unpack æ—¶å…ˆå¾—åˆ°å¯¹è±¡ï¼Œå†æ”¾è¿› `shared_ptr`

ä¾‹å¦‚ï¼š

```cpp
std::vector<RadarInjectInfo> radar_vec;
// 1. unpack å¾—åˆ° radar_vec
// 2. å†è½¬æˆ shared_ptr
std::vector<std::shared_ptr<RadarInjectInfo>> radar_ptr_vec;
for (auto& r : radar_vec) {
    radar_ptr_vec.push_back(std::make_shared<RadarInjectInfo>(std::move(r)));
}
```

### 4.2 å®é™… unpack ä»£ç ï¼š

```cpp
void on_msgpack(const char* data, std::size_t len) {
    msgpack::object_handle oh = msgpack::unpack(data, len);
    msgpack::object obj = oh.get();

    std::vector<RadarInjectInfo> tmp;
    obj.convert(tmp);

    std::vector<std::shared_ptr<RadarInjectInfo>> radar_inject_vector;
    for (auto& r : tmp) {
        radar_inject_vector.push_back(
            std::make_shared<RadarInjectInfo>(std::move(r)));
    }

    // è¿™é‡Œå°±æ‹¿åˆ°äº†å’Œä½  pack ä¹‹å‰åŒç»“æ„çš„æ•°æ®
}
```

å˜é•¿ arrayï¼ˆvectorï¼‰å®Œå…¨æ²¡é—®é¢˜ï¼Œmsgpack è‡ªåŠ¨å¤„ç†é•¿åº¦ã€‚

---

## 5. å˜é•¿æ•°ç»„ / vector çš„ unpack å†™æ³•

ä½ ä¹‹å‰æ‹…å¿ƒ proto é‡Œæœ‰ `array x[]` ä¹‹ç±»çš„ä¸å®šé•¿ã€‚

å…¶å®ç”¨ msgpack æ—¶å¾ˆç®€å•ï¼š**ç›´æ¥ç”¨ `std::vector` å°±è¡Œ**ã€‚

### 5.1 ç»“æ„ä½“å®šä¹‰

```cpp
struct Lane {
    int id;
    std::vector<float> center;  // å¯¹åº” proto çš„ array x[]
    MSGPACK_DEFINE(id, center);
};
```

### 5.2 unpack

```cpp
msgpack::object_handle oh = msgpack::unpack(buf, len);
Lane lane;
oh.get().convert(lane);

// lane.center.size() å°±æ˜¯ array é•¿åº¦
for (float c : lane.center) {
    ...
}
```

msgpack çš„äºŒè¿›åˆ¶é‡Œæœ¬èº«å°±è®°äº† â€œè¿™ä¸ª array æœ‰å¤šé•¿â€ï¼Œæ‰€ä»¥ä½ å®Œå…¨ä¸ç”¨è‡ªå·±å•ç‹¬ä¿å­˜é•¿åº¦ã€‚

---

## 6. `unpack` çš„å¼‚å¸¸ & é”™è¯¯å¤„ç†

`msgpack::unpack` å¯èƒ½æŠ›å‡ºçš„å…¸å‹å¼‚å¸¸ï¼š

* `msgpack::parse_error`ï¼šæ•°æ®ä¸å®Œæ•´ / æ ¼å¼æŸå
* `msgpack::type_error`ï¼š`obj.as<T>()` æˆ– `convert` æ—¶ç±»å‹ä¸åŒ¹é…
* `std::bad_alloc`ï¼šä¸€èˆ¬æ˜¯æ•°æ®é”™è¯¯å¯¼è‡´å°è¯•åˆ†é…è¶…å¤§å†…å­˜

å·¥ç¨‹åŒ–å†™æ³•ï¼š

```cpp
try {
    msgpack::object_handle oh = msgpack::unpack(buf, len);
    msgpack::object obj = oh.get();
    Frame frame;
    obj.convert(frame);
} catch (const msgpack::parse_error& e) {
    std::cerr << "parse_error: " << e.what() << std::endl;
} catch (const msgpack::type_error& e) {
    std::cerr << "type_error: " << e.what() << std::endl;
} catch (const std::bad_alloc& e) {
    std::cerr << "bad_alloc (maybe data corrupted): " << e.what() << std::endl;
}
```

**ä½ ä¹‹å‰é‡åˆ°çš„ bad_allocï¼Œå¤§å¤šæ˜¯å› ä¸ºï¼šå–‚ç»™ `unpack` çš„ data æ ¹æœ¬ä¸æ˜¯åˆæ³• msgpackï¼Œæˆ–è€…é•¿åº¦ä¸å¯¹ã€‚**

---

## 7. æµå¼æ•°æ®æ—¶ï¼Œ`unpack` çš„â€œè¿›é˜¶ç”¨æ³•â€ï¼šé…åˆ `msgpack::unpacker`

ä¸¥æ ¼æ¥è¯´è¿™æ˜¯ `unpacker` çš„ APIï¼Œä½†èƒŒåæ˜¯ä¸æ–­åœ¨å†…éƒ¨è°ƒç”¨ `unpack`ï¼Œåœ¨å·¥ç¨‹é‡Œå¾ˆå¸¸ç”¨ã€‚

åœºæ™¯ï¼š**ä½ ä» socket / rosbag æµé‡Œä¸€ç‚¹ä¸€ç‚¹æ”¶åˆ°æ•°æ®ï¼Œæ¯æ¬¡æ”¶åˆ°çš„éƒ½å¯èƒ½æ˜¯åŠæ¡ msgpackï¼Œä¸å®Œæ•´ã€‚**

å†™æ³•ï¼š

```cpp
msgpack::unpacker pac;

for (;;) {
    // 1. ç”³è¯·ç¼“å†²åŒº
    std::size_t buf_size = 4096;
    pac.reserve_buffer(buf_size);

    // 2. ä» fd/stream è¯»æ•°æ®
    std::size_t n = read(fd, pac.buffer(), buf_size);
    if (n == 0) break;         // EOF
    pac.buffer_consumed(n);    // å‘Šè¯‰ unpacker è¯»äº†å¤šå°‘

    // 3. åå¤å–å‡ºå®Œæ•´çš„å¯¹è±¡
    msgpack::object_handle oh;
    while (pac.next(oh)) {
        auto obj = oh.get();

        Frame f;
        obj.convert(f);
        handle_frame(f);
    }
}
```

ä½ å¯ä»¥ç†è§£ä¸ºï¼š**`unpacker` å¸®ä½ ç®¡ç†å†…éƒ¨ buffer + ä¸å®Œæ•´æ¶ˆæ¯ï¼›çœŸæ­£è§£æçš„æ ¸å¿ƒä»ç„¶æ˜¯ `unpack` çš„é€»è¾‘ã€‚**

---

## 8. å°ç»“ï¼šå·¥ç¨‹é‡Œä½¿ç”¨ `unpack` çš„å‡ ä¸ªåŸåˆ™

1. **æ˜ç¡®æ•°æ®æ¥æºï¼š**

   * ç¡®ä¿ `data,len` å¯¹åº”çš„æ˜¯**å®Œæ•´åˆæ³•çš„ msgpack å¯¹è±¡**
   * å¦‚æœæ˜¯æµå¼ï¼Œä¼˜å…ˆç”¨ `msgpack::unpacker`

2. **ç”¨ `convert()` / `as<T>()` å¯¹åº”å¥½ä½ è‡ªå·±çš„ struct / vector / map**

   * structï¼šç”¨ `MSGPACK_DEFINE`
   * åŠ¨æ€æ•°ç»„ï¼šç”¨ `std::vector<T>`

3. **ä¸€ä¸ª buffer å¤šå¯¹è±¡ => ç”¨å¸¦ offset çš„ `unpack`**

   ```cpp
   std::size_t offset = 0;
   while (offset < len) {
       auto oh = msgpack::unpack(buf, len, offset);
       ...
   }
   ```

4. **å¼‚å¸¸å¿…é¡»æ•è·ï¼Œå°¤å…¶æ˜¯æ¥è‡ªä¸å¯ä¿¡æ•°æ®ï¼ˆæ—¥å¿—å›æ”¾ã€ç½‘ç»œç­‰ï¼‰**

5. **å¦‚æœä½ è‡ªå·± pack å‡ºæ¥çš„ï¼Œå†ç”¨ unpackï¼Œå‡ ä¹ä¸ä¼šå‡ºé—®é¢˜ï¼›ä¸€å‡ºé—®é¢˜å°±è¯´æ˜ä¸­é—´æœ‰äººåŠ¨è¿‡æ•°æ® / æˆªæ–­ / ç±»å‹æ”¹äº†ã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥å¸®ä½ åšä¸€ä»¶éå¸¸å…·ä½“çš„äº‹ï¼š

ğŸ‘‰ **åŸºäºä½ ç°åœ¨çš„ `RadarTopicParser::parse` çš„æ‰“åŒ…æ ¼å¼ï¼Œå†™ä¸€ä»½å®Œæ•´çš„ â€œåå‘ unpack + è¿˜åŸ `RadarInjectInfo` + æ‰“å°å†…å®¹â€ çš„ demoï¼š**

* `pack` ç«¯ï¼šå°±æ˜¯ä½ ç°åœ¨çš„ parse ä»£ç 
* `unpack` ç«¯ï¼šæˆ‘ç»™ä½ è¡¥ä¸€æ®µå¯ä»¥ç›´æ¥è·‘çš„ä¾‹å­ï¼Œå¸®ä½ åœ¨ PC ä¸ŠæŠŠ msgpack å†…å®¹æ‰“å°å‡ºæ¥ï¼Œæ–¹ä¾¿ä½ è°ƒè¯•æ•´ä¸ªé“¾è·¯

å¦‚æœä½ æƒ³è¦ï¼Œæˆ‘å°±ç›´æ¥ç»™ä½ å†™å®Œæ•´ç¤ºä¾‹ä»£ç ç‰ˆæœ¬ã€‚
