ä¸‹é¢æˆ‘ç»™ä½ ä¸€å¥— **æœ€é€‚åˆå·¥ç¨‹ä½¿ç”¨ï¼ˆç‰¹åˆ«æ˜¯ä½ ç°åœ¨çš„ Radar / APInject é¡¹ç›®ï¼‰** çš„
ğŸ‘‰ **jsoncons æ¶ˆæ¯æ‰“åŒ…ï¼ˆencodeï¼‰+ è§£åŒ…ï¼ˆdecodeï¼‰å®Œæ•´æ•™ç¨‹**ã€‚

å…¨éƒ¨ç¤ºä¾‹éƒ½ä½¿ç”¨ MsgPackï¼ˆä½ ç°åœ¨æœ€éœ€è¦çš„ï¼‰ï¼Œå¹¶ä¸”åŒ…å« JSON â†” MsgPack çš„äº’è½¬ã€‚

è®²è§£ç»“æ„ï¼š

1. jsoncons çš„åŸºæœ¬æ¦‚å¿µ
2. å¦‚ä½• packï¼ˆencodeï¼‰C++ å¯¹è±¡
3. å¦‚ä½• unpackï¼ˆdecodeï¼‰åˆ° C++ å¯¹è±¡
4. å¦‚ä½•å¤„ç† std::vector / åµŒå¥—ç»“æ„
5. å¦‚ä½•å°† JSON â†” MsgPack è½¬æ¢
6. å¦‚ä½•è°ƒè¯•ï¼ˆå°† MsgPack æ‰“å°æˆäººç±»å¯è¯» JSONï¼‰
7. ç»™ä½  RadarInjectInfo çš„å®Œæ•´ç¤ºä¾‹

çœ‹å®Œå³å¯ç›´æ¥åœ¨ä½ çš„å·¥ç¨‹é‡Œä½¿ç”¨ã€‚

---

# 1ï¸âƒ£ jsoncons çš„åºåˆ—åŒ–ï¼ˆæ‰“åŒ…ï¼‰ä¸ MsgPack ç¼–ç  API

jsoncons çš„ MsgPack API ä¸»è¦æœ‰ä¸¤ä¸ªï¼š

### **æ‰“åŒ…ï¼ˆencodeï¼‰**

```cpp
jsoncons::msgpack::encode_msgpack(value);
```

### **è§£åŒ…ï¼ˆdecodeï¼‰**

```cpp
jsoncons::msgpack::decode_msgpack<T>(data);
```

æ”¯æŒçš„ `T` ç±»å‹ï¼š

* jsoncons::jsonï¼ˆåŠ¨æ€ JSONï¼‰
* ç”¨æˆ·å®šä¹‰ structï¼ˆéœ€è¦ JSONCONS_ALL_MEMBER_TRAITSï¼‰
* åŸºç¡€ç±»å‹
* vector/map ç­‰ STL å®¹å™¨

---

# 2ï¸âƒ£ å®šä¹‰ C++ ç»“æ„ä½“ï¼ˆè‡ªåŠ¨æ”¯æŒ pack/unpack å¿…é¡»ï¼‰

å‡è®¾ä½ æœ‰ Radar å¯¹è±¡ï¼š

```cpp
struct RadarObject {
    int id;
    float dist_long;
    float dist_lat;
};

struct RadarFrame {
    uint64_t tick;
    std::vector<RadarObject> objects;
};
```

jsoncons éœ€è¦å®šä¹‰ **ç»“æ„ä½“æˆå‘˜æ˜ å°„**ï¼š

### ğŸ”¹å…³é”®å®ï¼š`JSONCONS_ALL_MEMBER_TRAITS`

```cpp
JSONCONS_ALL_MEMBER_TRAITS(RadarObject, id, dist_long, dist_lat)
JSONCONS_ALL_MEMBER_TRAITS(RadarFrame, tick, objects)
```

è¿™ä¸€æ­¥å°±æ˜¯ msgpack-c é‡Œçš„ `MSGPACK_DEFINE` å¯¹åº”åŠŸèƒ½ã€‚

---

# 3ï¸âƒ£ jsoncons MsgPack æ‰“åŒ…ï¼ˆencodeï¼‰

## 3.1 æ‰“åŒ…åˆ° `std::vector<uint8_t>`

```cpp
RadarFrame frame;
frame.tick = 12345;
frame.objects.push_back({1, 10.0f, 1.5f});
frame.objects.push_back({2, 20.0f, -3.0f});

std::vector<uint8_t> output;
jsoncons::msgpack::encode_msgpack(frame, output);
```

ç°åœ¨ `output` å°±æ˜¯ MsgPack äºŒè¿›åˆ¶ï¼Œå¯ä»¥ï¼š

* å†™å…¥æ–‡ä»¶
* èµ°ç½‘ç»œ
* æ”¾è¿› rosbagï¼ˆstd_msgs::String.dataï¼‰

---

## 3.2 æ‰“åŒ…æˆ std::stringï¼ˆäºŒè¿›åˆ¶ï¼‰

```cpp
std::string bin = jsoncons::msgpack::encode_msgpack(frame);
```

ä½ å¯ä»¥å°†å®ƒå¡å…¥ rosbag çš„ Stringï¼š

```cpp
std_msgs::String s;
s.data = bin;  // äºŒè¿›åˆ¶å®‰å…¨
bag.write("/inject", time, s);
```

---

# 4ï¸âƒ£ jsoncons MsgPack è§£åŒ…ï¼ˆdecodeï¼‰

## 4.1 è§£ç ä¸º C++ structï¼ˆæœ€å¸¸ç”¨ï¼‰

```cpp
auto frame2 = jsoncons::msgpack::decode_msgpack<RadarFrame>(bin);
```

ä½¿ç”¨ç¤ºä¾‹ï¼š

```cpp
std::cout << frame2.tick << std::endl;
for (auto& obj : frame2.objects) {
    std::cout << obj.id << " " << obj.dist_long << std::endl;
}
```

jsoncons è‡ªåŠ¨å®Œæˆï¼š

* array â†’ vector
* map â†’ struct
* float/int â†’ æˆå‘˜å˜é‡

ä½ ä¸éœ€è¦å†™ unpack ç»†èŠ‚ã€‚

---

## 4.2 è§£ç ä¸º `jsoncons::json`ï¼ˆç”¨äºè°ƒè¯•ï¼‰

```cpp
jsoncons::json j = jsoncons::msgpack::decode_msgpack<jsoncons::json>(bin);
std::cout << pretty_print(j) << std::endl;
```

è¾“å‡ºç±»ä¼¼ï¼š

```json
{
  "tick": 12345,
  "objects": [
    { "id": 1, "dist_long": 10.0, "dist_lat": 1.5 },
    { "id": 2, "dist_long": 20.0, "dist_lat": -3.0 }
  ]
}
```

éå¸¸é€‚åˆä½ è°ƒè¯•æ•°æ®æµã€‚

---

# 5ï¸âƒ£ JSON â†” MsgPack äº’è½¬

jsoncons æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯æ ¼å¼ä¹‹é—´éšä¾¿è½¬æ¢ã€‚

## 5.1 JSON â†’ MsgPack

```cpp
jsoncons::json j = jsoncons::json::parse(R"({"a":1,"b":2})");
std::vector<uint8_t> bin;
jsoncons::msgpack::encode_msgpack(j, bin);
```

---

## 5.2 MsgPack â†’ JSON

```cpp
jsoncons::json j = jsoncons::msgpack::decode_msgpack<jsoncons::json>(bin);
std::cout << pretty_print(j);
```

è¿™å¯ä»¥ç›´æ¥æŠŠ rosbag çš„ msgpack å†…å®¹å˜æˆäººç±»å¯è¯» JSONï¼
è¿™æ˜¯è°ƒè¯• APInjectã€é›·è¾¾ã€èåˆéå¸¸å¥½ç”¨çš„å·¥å…·ã€‚

---

# 6ï¸âƒ£ å¦‚ä½•åˆ¤æ–­ MsgPack æ˜¯å¦æœ‰æ•ˆï¼Ÿï¼ˆé¿å… bad_allocï¼‰

ä½ ä¹‹å‰ msgpack-c ç»å¸¸ bad_allocã€‚

jsoncons æ›´å®‰å…¨ï¼šå¦‚æœ MsgPack æ ¼å¼é”™è¯¯ï¼Œå®ƒä¼šæŠ›å¼‚å¸¸ï¼Œä¸ä¼šä¹±ç”³è¯·å†…å­˜ã€‚

ä½ å¯ä»¥è¿™æ ·å†™ï¼š

```cpp
try {
    auto j = jsoncons::msgpack::decode_msgpack<jsoncons::json>(data);
} catch (const std::exception& e) {
    std::cerr << "Invalid msgpack: " << e.what() << std::endl;
}
```

jsoncons å†…éƒ¨æ£€æŸ¥ä¼šå‘Šè¯‰ä½ ï¼š

* ä¸å®Œæ•´
* map é•¿åº¦é”™è¯¯
* array è¶Šç•Œ
* type mismatch

æ¯” msgpack-c å®¹é”™å¼ºå¾ˆå¤šã€‚

---

# 7ï¸âƒ£ é’ˆå¯¹ä½ çš„å·¥ç¨‹ï¼šRadarInjectInfo å®Œæ•´æ‰“åŒ…ä¸è§£åŒ…ç¤ºä¾‹

å‡è®¾ä½ çš„ inject æ•°æ®æ˜¯ï¼š

```cpp
struct RadarInjectInfo {
    uint64_t gtc_tick;
    uint64_t utc_tick;
    RadarFrame info;
};
JSONCONS_ALL_MEMBER_TRAITS(RadarInjectInfo, gtc_tick, utc_tick, info);
```

æ‰“åŒ…ï¼š

```cpp
RadarInjectInfo ri;
ri.gtc_tick = ri.utc_tick = 123456;

jsoncons::msgpack::encode_msgpack(ri, output);
```

è§£åŒ…ï¼š

```cpp
RadarInjectInfo ri2 = jsoncons::msgpack::decode_msgpack<RadarInjectInfo>(output);
```

è°ƒè¯•ï¼š

```cpp
json j = jsoncons::msgpack::decode_msgpack<json>(output);
std::cout << pretty_print(j);
```

---

# 8ï¸âƒ£ ä¸ºä»€ä¹ˆ jsoncons æ¯” msgpack-c æ›´é€‚åˆä½ çš„éœ€æ±‚ï¼Ÿ

| èƒ½åŠ›                | msgpack-c             | jsoncons                     |
| ----------------- | --------------------- | ---------------------------- |
| è‡ªåŠ¨ struct æ˜ å°„      | âŒ è¦è‡ªå·±å†™ MSGPACK_DEFINE | âœ” JSONCONS_ALL_MEMBER_TRAITS |
| åŠ¨æ€è§£åŒ…æˆ JSON        | âŒ ä¸æ”¯æŒ                 | âœ” æ”¯æŒï¼ˆå¾ˆå¥½ç”¨ï¼‰                    |
| JSON â†” MsgPack äº’è½¬ | âŒ                     | âœ”                            |
| é”™è¯¯å¤„ç†              | å¼±ï¼Œæ˜“ bad_alloc         | å¼ºï¼Œå®‰å…¨                         |
| å¤šæ ¼å¼æ”¯æŒ             | åª MsgPack             | JSON/CBOR/BSON/UBJSON/YAML   |

å¯¹ä½ çš„å·¥ç¨‹ï¼ˆé›·è¾¾æ³¨å…¥ / AP å›æ”¾ / é‡‡é›†ç³»ç»Ÿè§£æï¼‰éå¸¸å‹å¥½ã€‚

---

# ğŸ¯ 9ï¸âƒ£ å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»™ä½ åšï¼š

### âœ” 1. ä½ æ‰€æœ‰ inject structï¼ˆAPInjectFrameã€Vehicleã€Laneã€Radarï¼‰ â†’ jsoncons traits è‡ªåŠ¨ç”Ÿæˆ

### âœ” 2. ä¸€ä¸ª MsgPack dump å·¥å…·ï¼ˆæŠŠ rosbag å†…çš„ MsgPack è½¬æˆ JSON æ‰“å°ï¼‰

### âœ” 3. ä½ çš„ pack/unpack æ¡†æ¶é‡å†™ä¸º jsoncons ç‰ˆæœ¬

### âœ” 4. æ•™ä½ å¦‚ä½•æ··åˆ protobuf + jsoncons + rosbag

åªè¦ä½ ç»™æˆ‘ï¼š

* ä¸€ä¸ª inject struct çš„ C++ å¤´æ–‡ä»¶
* æˆ–è€…ä½ å‘Šè¯‰æˆ‘æœ‰å“ªäº›å­—æ®µ

æˆ‘å°±èƒ½ç”Ÿæˆå®Œæ•´ä»£ç ã€‚

---

å¦‚æœä½ æƒ³ç»§ç»­å­¦ä¹ ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘å¯ä»¥æ·±å…¥è®²ï¼š

ğŸ‘‰ **jsoncons çš„ struct æ˜ å°„é«˜çº§ç”¨æ³•ï¼ˆenumã€optionalã€vectorã€mapã€åµŒå¥— structï¼‰**
ğŸ‘‰ **å¦‚ä½•å’Œ rosbag ç»“åˆï¼Œä» rosbag ä¸­è¯» msgpack å†…å®¹**
ğŸ‘‰ **å¦‚ä½•å®ç°åœ¨çº¿ msgpack â†’ JSON å¯è§†åŒ–å·¥å…·**

ä½ æƒ³ç»§ç»­å“ªä¸ªæ–¹å‘ï¼Ÿ
