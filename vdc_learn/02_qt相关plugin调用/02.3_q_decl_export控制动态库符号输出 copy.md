ä¸‹é¢æˆ‘ç»™ä½ ä¸€ä¸ª**æœ€ç®€å•ã€æœ€å®Œæ•´ã€å¯ç¼–è¯‘è¿è¡Œçš„ Qt/C++ åŠ¨æ€åº“å¯¼å‡ºå®ä¾‹å­**ã€‚
ä½ ä¼šçœ‹åˆ°ï¼š

* åŠ¨æ€åº“å¦‚ä½•**å¯¼å‡º**ä¸€ä¸ªç±»
* åº”ç”¨ç¨‹åºå¦‚ä½•**å¯¼å…¥**è¿™ä¸ªç±»
* `Q_DECL_EXPORT` / `Q_DECL_IMPORT` å¦‚ä½•å‘æŒ¥ä½œç”¨
* **ä¸€å¥—å¤´æ–‡ä»¶ï¼Œä¸¤ç§ç”¨æ³•**

ä¾‹å­éå¸¸å°ï¼Œé€‚åˆåˆå­¦è€…ã€‚

---

# âœ… ç›®å½•ç»“æ„

```
PluginTest/
 â”œâ”€ PluginLib/        # åŠ¨æ€åº“å·¥ç¨‹
 â”‚   â”œâ”€ plugin_global.h
 â”‚   â”œâ”€ myplugin.h
 â”‚   â””â”€ myplugin.cpp
 â””â”€ App/              # ä¸»ç¨‹åºå·¥ç¨‹
     â””â”€ main.cpp
```

è¿™ä¸ªä¾‹å­å¯ä»¥ç”¨ Qt Creator / QMake / CMake éšä¾¿ç¼–è¯‘ã€‚

---

# ğŸ§±ï¼ˆä¸€ï¼‰åŠ¨æ€åº“ PluginLib

## 1. plugin_global.h â€”â€” å¯¼å‡ºå®æ–‡ä»¶

```cpp
#ifndef PLUGIN_GLOBAL_H
#define PLUGIN_GLOBAL_H

#include <QtCore/qglobal.h>

#if defined(PLUGINLIB_LIBRARY)
#  define PLUGIN_EXPORT Q_DECL_EXPORT
#else
#  define PLUGIN_EXPORT Q_DECL_IMPORT
#endif

#endif // PLUGIN_GLOBAL_H
```

ğŸ“Œ å…³é”®ç‚¹ï¼š

* ç¼–è¯‘åº“æ—¶ï¼Œå®šä¹‰ï¼š`PLUGINLIB_LIBRARY`
* å¯¼å‡ºç±»ç”¨ï¼š`PLUGIN_EXPORT`

---

## 2. myplugin.h â€”â€” åŠ¨æ€åº“è¦å¯¼å‡ºçš„ç±»

```cpp
#ifndef MYPLUGIN_H
#define MYPLUGIN_H

#include "plugin_global.h"
#include <QString>

class PLUGIN_EXPORT MyPlugin
{
public:
    MyPlugin();

    QString message() const;
};

#endif // MYPLUGIN_H
```

ğŸ“Œ å…³é”®ç‚¹ï¼š

```cpp
class PLUGIN_EXPORT MyPlugin
```

åœ¨ä¸åŒå·¥ç¨‹ä¸­ä¼šå˜æˆï¼š

* **åŠ¨æ€åº“å·¥ç¨‹**ï¼š`__declspec(dllexport)`
* **ä¸»ç¨‹åºå·¥ç¨‹**ï¼š`__declspec(dllimport)`

---

## 3. myplugin.cpp â€”â€” å®ç°æ–‡ä»¶

```cpp
#include "myplugin.h"

MyPlugin::MyPlugin()
{
}

QString MyPlugin::message() const
{
    return "Hello from plugin!";
}
```

---

# ğŸ“¦ï¼ˆäºŒï¼‰ä¸»ç¨‹åº App

## main.cpp â€”â€” ä½¿ç”¨åŠ¨æ€åº“ä¸­çš„ç±»

```cpp
#include <QCoreApplication>
#include <QDebug>
#include "myplugin.h"   // ç›´æ¥ include åº“çš„å¤´æ–‡ä»¶

int main(int argc, char *argv[])
{
    QCoreApplication a(argc, argv);

    MyPlugin p;
    qDebug() << p.message();

    return a.exec();
}
```

è¿è¡Œè¾“å‡ºï¼š

```
Hello from plugin!
```

---

# âš™ï¼ˆä¸‰ï¼‰ç¼–è¯‘è®¾ç½®

### Qt Creator / QMakeï¼ˆåº“é¡¹ç›®ï¼‰

pluginlib.proï¼š

```qmake
TEMPLATE = lib
CONFIG += dll
DEFINES += PLUGINLIB_LIBRARY

SOURCES += myplugin.cpp
HEADERS += myplugin.h plugin_global.h
```

### Qt Creator / QMakeï¼ˆåº”ç”¨ç¨‹åºï¼‰

app.proï¼š

```qmake
SOURCES += main.cpp
HEADERS += ../PluginLib/myplugin.h ../PluginLib/plugin_global.h

LIBS += -L../PluginLib/debug -lPluginLib
```

---

# ğŸ‰ å®Œæ•´è¿è¡Œæµç¨‹

### 1. ç¼–è¯‘åŠ¨æ€åº“ï¼ˆ.dll / .soï¼‰

`PLUGINLIB_LIBRARY` è¢«è‡ªåŠ¨å®šä¹‰
`PLUGIN_EXPORT â†’ Q_DECL_EXPORT`

åŠ¨æ€åº“å¯¼å‡ºç±» `MyPlugin`

---

### 2. ç¼–è¯‘åº”ç”¨ç¨‹åº

`PLUGINLIB_LIBRARY` æ²¡å®šä¹‰
`PLUGIN_EXPORT â†’ Q_DECL_IMPORT`

ä¸»ç¨‹åºä»åŠ¨æ€åº“**å¯¼å…¥** MyPlugin

---

# ğŸ§  ä½ å­¦åˆ°çš„æ ¸å¿ƒç‚¹ï¼š

* åŒä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œåœ¨åº“ & åº”ç”¨ä¸­è¡¨ç°ä¸åŒ
* å®æ ¹æ®ç¼–è¯‘ç¯å¢ƒåˆ‡æ¢å¯¼å‡º/å¯¼å…¥
* Qt æä¾›è·¨å¹³å°å°è£… (`Q_DECL_EXPORT` / `Q_DECL_IMPORT`)
* æœ€ç»ˆæ•ˆæœï¼šç±»åœ¨åŠ¨æ€åº“ä¸­å¯¼å‡ºï¼Œè¢«å¤–éƒ¨åº”ç”¨ä½¿ç”¨

---

# ğŸ“Œ å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜èƒ½ç»§ç»­ç»™ä½ ï¼š

âœ” **å¸¦å·¥å‚å‡½æ•° CreatePlugin() çš„æ’ä»¶ç¤ºä¾‹**
âœ” **ç±»ä¼¼ä½ çš„é¡¹ç›®ä¸­é‚£ç§ resolve("CreatePlugin") çš„å®Œæ•´ä¾‹å­**
âœ” **å¤šæ’ä»¶ç®¡ç†ç³»ç»Ÿï¼ˆManager + map + åŠ¨æ€åŠ è½½ï¼‰**
âœ” **shared_mutex + unique_lock ä¿æŠ¤æ’ä»¶è¡¨çš„ç¤ºä¾‹**

ä½ æƒ³è¦å“ªä¸€ç§ï¼Ÿ
