éå¸¸å¥½çš„é—®é¢˜ ğŸ‘
`std::thread` å’Œ `std::feature`ï¼ˆæˆ‘çŒœä½ æ˜¯æŒ‡ **`std::future`**ï¼Ÿï¼‰ç¡®å®éƒ½æ¶‰åŠåˆ° **å¤šçº¿ç¨‹å¹¶å‘**ï¼Œä½†å®ƒä»¬åœ¨åº•å±‚å®ç°ã€ä½¿ç”¨æ¨¡å‹å’ŒæŠ½è±¡å±‚æ¬¡ä¸Šæœ‰æ˜æ˜¾çš„åŒºåˆ«ã€‚
æˆ‘æ¥å¸®ä½ ç³»ç»Ÿåœ°æ¢³ç†ä¸€ä¸‹ä¸¤è€…çš„åº•å±‚å·®å¼‚ï¼ˆä»¥ C++17/C++20 ä¸ºä¸»ï¼‰ï¼š

---

## ä¸€ã€ä¸¤è€…çš„è§’è‰²åŒºåˆ«

| å¯¹è±¡            | ä¸»è¦ç”¨é€”                 | æŠ½è±¡å±‚æ¬¡       |
| ------------- | -------------------- | ---------- |
| `std::thread` | ç›´æ¥åˆ›å»ºå¹¶ç®¡ç†çº¿ç¨‹            | **ä½çº§çº¿ç¨‹åŸè¯­** |
| `std::future` | ç”¨äºçº¿ç¨‹é—´**è¿”å›ç»“æœ**å’Œ**åŒæ­¥** | **é«˜çº§ä»»åŠ¡æŠ½è±¡** |

---

## äºŒã€åº•å±‚å®ç°æœºåˆ¶

### 1ï¸âƒ£ `std::thread` çš„åº•å±‚å®ç°

`std::thread` æ˜¯å¯¹ç³»ç»ŸåŸç”Ÿçº¿ç¨‹ APIï¼ˆå¦‚ POSIX threads / Windows threadsï¼‰çš„ä¸€ä¸ª **è½»é‡å°è£…**ã€‚

åœ¨ä¸åŒå¹³å°ä¸Šï¼š

| å¹³å°            | åº•å±‚å®ç°                                         |
| ------------- | -------------------------------------------- |
| Linux / macOS | åŸºäº **`pthread_create()`**ï¼ˆPOSIX Threadsï¼‰     |
| Windows       | åŸºäº **`CreateThread()` / `_beginthreadex()`** |

ğŸ”¹ æ ¸å¿ƒç‰¹ç‚¹ï¼š

* `std::thread` å¯¹è±¡å†…éƒ¨ä¿å­˜ä¸€ä¸ªç³»ç»Ÿçº§ **çº¿ç¨‹å¥æŸ„**ï¼›
* çº¿ç¨‹å¯åŠ¨åç‹¬ç«‹è¿è¡Œï¼Œ**ä¸ä¸ä¸»çº¿ç¨‹å…±äº«æ§åˆ¶æµ**ï¼›
* `join()` / `detach()` å¯¹åº”åº•å±‚çš„ `pthread_join()` / `pthread_detach()`ï¼›
* ä¸å…³å¿ƒå‡½æ•°è¿”å›å€¼ï¼Œçº¯ç²¹æ‰§è¡Œä»»åŠ¡ã€‚

ğŸ’¡ ç¤ºä¾‹ï¼š

```cpp
std::thread t([] {
    std::cout << "Hello from thread\n";
});
t.join();
```

â¡ï¸ ç¼–è¯‘å™¨å¤§è‡´ä¼šç”Ÿæˆå¯¹ `pthread_create` çš„è°ƒç”¨ï¼š

```cpp
pthread_create(&native_handle, nullptr, [](void*) -> void* {
    func();
    return nullptr;
}, nullptr);
```

---

### 2ï¸âƒ£ `std::future` çš„åº•å±‚å®ç°

`std::future` å¹¶**ä¸ç›´æ¥åˆ›å»ºçº¿ç¨‹**ï¼Œè€Œæ˜¯å’Œ `std::promise` æˆ– `std::async` ä¸€èµ·å·¥ä½œã€‚

#### 2.1 `std::promise` + `std::future`

* `std::promise` æŒæœ‰ä¸€ä¸ªå…±äº«çŠ¶æ€ï¼ˆshared stateï¼‰ï¼›
* `std::future` é€šè¿‡è¯¥çŠ¶æ€å¼‚æ­¥è·å–ç»“æœï¼›
* åº•å±‚é€šè¿‡ **å…±äº«çŠ¶æ€å¯¹è±¡**ï¼ˆé€šå¸¸æ˜¯ `std::__shared_state_base`ï¼‰å®ç°çº¿ç¨‹å®‰å…¨åŒæ­¥ã€‚

ğŸ’¡ ä¸¾ä¾‹ï¼š

```cpp
std::promise<int> p;
std::future<int> f = p.get_future();

std::thread t([&p] {
    p.set_value(42);
});
std::cout << f.get();  // é˜»å¡ç›´åˆ° set_value()
t.join();
```

åº•å±‚é€»è¾‘ï¼š

* åˆ›å»ºä¸€ä¸ªå…±äº«çŠ¶æ€ `shared_state`ï¼ˆé€šå¸¸ç”¨ `std::shared_ptr` ç®¡ç†ï¼‰ï¼›
* `promise.set_value()` ä¿®æ”¹çŠ¶æ€å¹¶å”¤é†’ç­‰å¾…çº¿ç¨‹ï¼›
* `future.get()` ç­‰å¾…æ¡ä»¶å˜é‡é€šçŸ¥ï¼Œå®‰å…¨å–å‡ºç»“æœã€‚

ğŸ”§ ä¾èµ–çš„åŒæ­¥æœºåˆ¶ï¼š

* äº’æ–¥é”ï¼ˆ`std::mutex`ï¼‰
* æ¡ä»¶å˜é‡ï¼ˆ`std::condition_variable`ï¼‰
* åŸå­å¼•ç”¨è®¡æ•°ï¼ˆç®¡ç†å…±äº«çŠ¶æ€ç”Ÿå‘½å‘¨æœŸï¼‰

---

#### 2.2 `std::async` + `std::future`

`std::async` æ˜¯ä¸€ä¸ªæ›´é«˜çº§åˆ«çš„æ¥å£ï¼Œå®ƒ**å¯èƒ½ä¼šè‡ªåŠ¨åˆ›å»ºçº¿ç¨‹**ï¼ˆæˆ–å»¶è¿Ÿæ‰§è¡Œï¼‰ï¼Œå–å†³äºç­–ç•¥ï¼š

```cpp
auto f = std::async(std::launch::async, [] { return 42; });
std::cout << f.get();  // è‡ªåŠ¨ join
```

åº•å±‚ï¼š

* `std::async` å†…éƒ¨å¯èƒ½ä½¿ç”¨ `std::thread` æ¥å¯åŠ¨ä»»åŠ¡ï¼›
* åŒæ—¶æ„é€ ä¸€ä¸ªå†…éƒ¨çš„ `std::promise` / `std::future`ï¼›
* çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åè‡ªåŠ¨ `set_value()`ã€‚

ğŸŒ¿ æ‰€ä»¥ï¼š

> `std::async` æ˜¯åœ¨ `std::thread` ä¹‹ä¸ŠåŒ…äº†ä¸€å±‚è‡ªåŠ¨ç®¡ç†å’Œç»“æœåŒæ­¥çš„æœºåˆ¶ã€‚

---

## ä¸‰ã€åº•å±‚ç»“æ„å›¾å¯¹æ¯”

```
std::thread:
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   user fn   â”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
 pthread_create()
        â”‚
  OS kernel thread
```

```
std::future / std::async:
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ shared_state â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                        â”‚
 std::promise.set_value()   std::future.get()
       â”‚                        â”‚
   çº¿ç¨‹ Aï¼ˆç”Ÿäº§è€…ï¼‰         çº¿ç¨‹ Bï¼ˆæ¶ˆè´¹è€…ï¼‰
```

---

## å››ã€æ€§èƒ½ & ä½¿ç”¨å·®å¼‚

| å¯¹æ¯”é¡¹    | `std::thread`          | `std::future` / `std::async` |
| ------ | ---------------------- | ---------------------------- |
| æ§åˆ¶ç²’åº¦   | å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶çº¿ç¨‹åˆ›å»º/é”€æ¯         | è‡ªåŠ¨ç®¡ç†ä»»åŠ¡å’Œè¿”å›å€¼                   |
| çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ | æ‰‹åŠ¨ `join/detach`       | è‡ªåŠ¨åœ¨ `get()` æ—¶ join           |
| è¿”å›å€¼    | æ— è¿”å›å€¼ï¼Œéœ€è‡ªå®šä¹‰åŒæ­¥            | å†…å»ºåŒæ­¥ä¸è¿”å›æœºåˆ¶                    |
| é€‚åˆåœºæ™¯   | å¯¹åº•å±‚æ€§èƒ½ã€çº¿ç¨‹ç®¡ç†è¦æ±‚é«˜          | ä»¥ä»»åŠ¡ä¸ºä¸­å¿ƒçš„å¹¶å‘è®¡ç®—                  |
| åº•å±‚å®ç°   | pthread / CreateThread | å†…éƒ¨å°è£… thread + promise/future |

---

## äº”ã€æ€»ç»“ä¸€å¥è¯

> ğŸ”¹ `std::thread` æ˜¯ **â€œçº¿ç¨‹çš„å¤–å£³â€**ï¼›
> ğŸ”¹ `std::future` æ˜¯ **â€œç»“æœçš„é€šé“â€**ï¼›
> ğŸ”¹ `std::async` åˆ™æ˜¯ä¸¤è€…çš„ç»“åˆï¼Œ**å¸®ä½ è‡ªåŠ¨å¼€çº¿ç¨‹å¹¶è¿”å› future**ã€‚

---

å¦‚æœä½ å¸Œæœ›æˆ‘ç»§ç»­å¾€ä¸‹è®²ï¼ˆæ¯”å¦‚åˆ†æ GCC/libstdc++ é‡Œ `std::future` çš„å…·ä½“å®ç°æºç ï¼Œæ¯”å¦‚ `_State_baseV2`ã€`__future_base::_Result` ç­‰ï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»å‡ºåº•å±‚ç±»å›¾å’Œæ‰§è¡Œæµç¨‹ï¼ˆå¾ˆé€‚åˆåšç³»ç»Ÿçº§ç†è§£ï¼‰ã€‚
è¦ç»§ç»­çœ‹å—ï¼Ÿ
