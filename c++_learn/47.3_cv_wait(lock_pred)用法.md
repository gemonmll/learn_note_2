ä½ è¯´å¾—å¾ˆå¥½ï¼Œæˆ‘æ¥ç²¾ç¡®æ¾„æ¸…ä¸€ä¸‹ **wait(lock, pred)** çš„çœŸå®è¯­ä¹‰ï¼Œä¿è¯ä½ å½»åº•ä¸å†æ··æ·†ã€‚

---

# âœ… ä½ è§‰å¾—çŸ›ç›¾çš„ä¸¤å¥è¯

ä½ ç†è§£çš„æ˜¯ï¼š

1. **æ²¡æœ‰ notify â†’ wait ä¸ä¼šé†’ â†’ ä¸ä¼šè¿è¡Œ pred**
2. **pred ä¸º true æ‰èƒ½ç»§ç»­æ‰§è¡Œ**

çœ‹èµ·æ¥å¥½åƒå†²çªï¼š
â€œpred ä¸º true ä¹Ÿè¦ç­‰ cv å”¤é†’ã€é‚£ pred true ä¸æ˜¯ç™½æ­å—ï¼Ÿâ€

å…¶å®ä¸å†²çªï¼ŒåŸå› åœ¨äºï¼š

---

# â­ **wait(lock, pred) çš„çœŸæ­£è¯­ä¹‰ä¸æ˜¯â€œè¦ç­‰ notify æ‰æ‰§è¡Œ predâ€ï¼Œè€Œæ˜¯ï¼š**

### âœ” ç¬¬ä¸€æ¬¡è¿›å…¥ wait â†’ ç«‹å³æ£€æŸ¥ pred

### âœ” å¦‚æœ pred = true â†’ **ç›´æ¥è¿”å›ï¼Œä¸é˜»å¡ï¼Œä¸ç­‰å¾… notify**

### âœ” å¦‚æœ pred = false â†’ **å¼€å§‹é˜»å¡ç­‰å¾… cv**

### âœ” é†’æ¥åç»§ç»­æ£€æŸ¥ pred

### âœ” pred ä¸º false â†’ ç»§ç»­ wait

### âœ” pred ä¸º true â†’ è¿”å›

---

# ğŸš¨ å…³é”®ç‚¹ï¼š**pred åœ¨è¿›å…¥ wait æ—¶å°±ä¼šå…ˆæ£€æŸ¥**

**è¿™ç‚¹æ˜¯ä½ åˆšåˆšå¿½ç•¥çš„åœ°æ–¹ã€‚**

ä¹Ÿå°±æ˜¯è¯´ï¼Œä»£ç ï¼š

```cpp
wait(lock, pred);
```

æœ¬è´¨æ˜¯ï¼š

```cpp
if (!pred()) {
    do {
        wait(lock);        // é˜»å¡
    } while (!pred());
}
```

---

# ğŸ“Œ æ‰€ä»¥ä½ çš„å½“å‰ä»£ç è¡Œä¸ºæ€»ç»“å¦‚ä¸‹ï¼š

### **Case 1ï¼špred ä¸€å¼€å§‹å°±ä¸º true**

â†’ wait() **ä¸ä¼šé˜»å¡**ï¼Œä¸ä¼šç­‰å¾… notifyï¼Œç›´æ¥è¿”å›ã€‚
ï¼ˆæ¯”å¦‚ä½  push ä¸¤æ¬¡ï¼Œä½† only æ¶ˆè´¹ä¸€æ¬¡ï¼Œç„¶ååˆè°ƒç”¨ waitData â†’ ä¸ä¼šé˜»å¡ï¼‰

### **Case 2ï¼špred ä¸º false æ‰ä¼šè¿›å…¥é˜»å¡ç­‰å¾…**

â†’ æ‰éœ€è¦ notify å”¤é†’ã€‚

---

# ğŸ”¥ ç”¨ä½ çš„ä¾‹å­ç²¾ç¡®æ¼”ç¤ºåŠ¨ä½œä¸ºè¯

å‡è®¾ï¼š

```
pushIndex = 2
popIndex  = 1
pred = (2 != 1) = true
```

æ¶ˆè´¹çº¿ç¨‹è°ƒç”¨ï¼š

```cpp
wait(lock, pred);
```

æµç¨‹ï¼š

* ä¸Šé”
* æ£€æŸ¥ pred â†’ true
* **ç«‹å³è¿”å›ï¼Œä¸ waitï¼Œä¸é˜»å¡ï¼Œä¸éœ€è¦ notify**

ä½ çœ‹ï¼Œè¿™å®Œå…¨æ˜¯æ­£ç¡®è¡Œä¸ºã€‚

---

# ğŸ¯ æ‰€ä»¥æˆ‘ç»™ä½ çš„æœ€ç»ˆç»“è®ºï¼š

# â­ pred ä¸º true â†’ ä¸éœ€è¦ç­‰å¾…æ¡ä»¶å˜é‡

# â­ pred ä¸º false â†’ æ‰éœ€è¦ç­‰å¾… cv

è¿™ä¸¤ä¸ªéƒ½æˆç«‹ï¼Œæ²¡æœ‰çŸ›ç›¾ã€‚

---

# ğŸ”” å†è§£é‡Šä½ è§‰å¾—çŸ›ç›¾çš„åœ°æ–¹

ä½ ä¹‹å‰ç†è§£æˆï¼š

â€œpred ä¸º true ä¹Ÿå¿…é¡»ç­‰å¾… cv æ‰ä¼šåˆ¤æ–­ predâ€

è¿™æ˜¯é”™çš„ã€‚

æ­£ç¡®çš„é€»è¾‘é¡ºåºæ˜¯ï¼š

### è¿›å…¥ wait â†’ å…ˆåˆ¤æ–­ pred

* true â†’ **ç›´æ¥è¿”å›**
* false â†’ é˜»å¡ç­‰å¾… cv

### è¢«å”¤é†’ â†’ å†åˆ¤æ–­ pred

* false â†’ å†ç¡
* true â†’ è¿”å›

è¿™å°±æ˜¯å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

---

# ğŸ§  ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆï¼š

> **wait(lock, pred) ä¸ä¼šä¸ºäº† pred ä¸º true è€Œä¸»åŠ¨ç­‰å¾…ä»»ä½•ä¸œè¥¿ã€‚
> å®ƒåªåœ¨ pred ä¸º false æ—¶æ‰ç­‰å¾…æ¡ä»¶å˜é‡ã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼ æµç¨‹å›¾ï¼Œè®©ä½  5 ç§’çœ‹æ‡‚æ•´ä¸ª wait-predicate çŠ¶æ€æœºã€‚
```cpp
#pragma once
#include <condition_variable>
#include <mutex>
#include <queue>
#include <memory>

template <class T>
class DataCachePool
{
public:
    DataCachePool(unsigned int size = 2) : poolsize(size), currentPushIndex(0), currentPopIndex(0)
    {
        if (poolsize <= 0)
        {
            poolsize = 2;
        }
        data = new T[poolsize];
        memset(data, 0, sizeof(T) * poolsize);
    }

    template <class Element>

    void Push(Element &&element)
    {
        currentPushIndex = currentPushIndex % poolsize;
        data[currentPushIndex] = std::forward<Element>(element);
        // std::cout << "Push : " << currentPushIndex << std::endl;
        currentPushIndex++;
        not_empty_cv_.notify_one();
    }
    bool waitData(T &t)
    {
        std::unique_lock<std::mutex> lock(mutex_);
        not_empty_cv_.wait(lock, [this]()
                           { return this->currentPushIndex != this->currentPopIndex; });
        currentPopIndex = currentPopIndex % poolsize;
        // std::cout << "waitData : " << currentPopIndex << std::endl;
        t = data[currentPopIndex];
        currentPopIndex++;
        return true;
    }

private:
    T *data;
    int currentPushIndex;
    int currentPopIndex;
    unsigned int poolsize;
    std::condition_variable not_empty_cv_;
    mutable std::mutex mutex_;
};

```