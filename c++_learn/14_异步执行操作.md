éå¸¸å¥½ ğŸ‘ï¼Œä½ æåˆ°çš„ `async_send_request` å’Œ `future` æ­£å¥½æ˜¯ **C++ æ ‡å‡†åº“å¼‚æ­¥æœºåˆ¶ (`std::async` / `std::future`)** çš„æ ¸å¿ƒæ€æƒ³åœ¨ ROS 2 ä¸­çš„åº”ç”¨ã€‚æˆ‘ä»¬å…ˆä»æ ‡å‡†åº“å¼€å§‹ç†è§£ã€‚

---

## ğŸ§© ä¸€ã€C++ æ ‡å‡†åº“ä¸­çš„å¼‚æ­¥æ“ä½œï¼š`std::async`ã€`std::future`

### 1ï¸âƒ£ å…³é”®ç»„ä»¶ä»‹ç»

| åç§°                       | ä½œç”¨                               |
| ------------------------ | -------------------------------- |
| **`std::async`**         | å¼‚æ­¥å¯åŠ¨ä¸€ä¸ªä»»åŠ¡ï¼ˆç±»ä¼¼å¼€ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œå‡½æ•°ï¼‰           |
| **`std::future`**        | ç”¨äº**è·å–å¼‚æ­¥ä»»åŠ¡çš„è¿”å›ç»“æœ**ï¼ˆç›¸å½“äºä¸€ä¸ªâ€œç»“æœçš„å ä½ç¬¦â€ï¼‰ |
| **`std::promise`**       | æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª future çš„ç»“æœï¼ˆæ¯” async æ›´åº•å±‚ï¼‰   |
| **`std::packaged_task`** | åŒ…è£…ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œä½¿å…¶å¼‚æ­¥è¿”å› `future`        |

---

### 2ï¸âƒ£ åŸºæœ¬ç”¨æ³•ï¼š`std::async` + `std::future`

```cpp
#include <iostream>
#include <future>
#include <thread>
#include <chrono>

int slow_add(int a, int b) {
  std::this_thread::sleep_for(std::chrono::seconds(2)); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
  return a + b;
}

int main() {
  std::cout << "Main thread start\n";

  // å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
  std::future<int> result = std::async(std::launch::async, slow_add, 10, 20);

  std::cout << "Doing other work...\n";

  // è·å–ç»“æœï¼ˆé˜»å¡ç­‰å¾…ï¼‰
  int sum = result.get();

  std::cout << "Result = " << sum << "\n";
}
```

ğŸ§  **è§£é‡Šï¼š**

* `std::async` å¼‚æ­¥å¯åŠ¨ `slow_add(10, 20)`ã€‚
* è¿”å›çš„ `std::future<int>` æ˜¯â€œæœªæ¥çš„ç»“æœâ€ã€‚
* å½“è°ƒç”¨ `.get()` æ—¶ï¼Œ**é˜»å¡ç­‰å¾…ç»“æœ**ã€‚
* å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œ`get()` ç«‹å³è¿”å›ç»“æœã€‚

---

### 3ï¸âƒ£ å¼‚æ­¥ vs åŒæ­¥åŒºåˆ«

| æ¨¡å¼     | ç‰¹å¾                  | ä»£ç                                            |
| ------ | ------------------- | -------------------------------------------- |
| **åŒæ­¥** | è°ƒç”¨ç«‹å³é˜»å¡ç›´åˆ°è¿”å›          | `int r = slow_add(10,20);`                   |
| **å¼‚æ­¥** | ç«‹å³è¿”å›ä¸€ä¸ª futureï¼Œç¨åå–ç»“æœ | `auto f = std::async(...); int r = f.get();` |

---

## âš™ï¸ äºŒã€ROS 2 ä¸­çš„å¼‚æ­¥è°ƒç”¨ï¼š`async_send_request`

åœ¨ ROS 2 ä¸­ï¼ŒæœåŠ¡å®¢æˆ·ç«¯ä¹Ÿä½¿ç”¨ç±»ä¼¼æœºåˆ¶ï¼š

```cpp
auto result_future = client->async_send_request(request);
```

### ğŸ§© å®é™…ä¾‹å­

```cpp
#include "rclcpp/rclcpp.hpp"
#include "example_interfaces/srv/add_two_ints.hpp"

using namespace std::chrono_literals;

int main(int argc, char **argv)
{
  rclcpp::init(argc, argv);
  auto node = rclcpp::Node::make_shared("add_two_ints_client");
  auto client = node->create_client<example_interfaces::srv::AddTwoInts>("add_two_ints");

  auto request = std::make_shared<example_interfaces::srv::AddTwoInts::Request>();
  request->a = 3;
  request->b = 7;

  // å¼‚æ­¥è¯·æ±‚
  auto future_result = client->async_send_request(request);

  // ç­‰å¾…å“åº”ï¼ˆé˜»å¡ï¼‰
  if (rclcpp::spin_until_future_complete(node, future_result) ==
      rclcpp::FutureReturnCode::SUCCESS)
  {
    RCLCPP_INFO(node->get_logger(), "Result: %ld", future_result.get()->sum);
  } else {
    RCLCPP_ERROR(node->get_logger(), "Failed to call service");
  }

  rclcpp::shutdown();
  return 0;
}
```

ğŸ” **å¯¹åº”å…³ç³»ï¼š**

| ROS 2                          | C++ æ ‡å‡†åº“                   |
| ------------------------------ | ------------------------- |
| `async_send_request()`         | `std::async()` å¯åŠ¨å¼‚æ­¥ä»»åŠ¡     |
| è¿”å›çš„ `future`                   | `std::future<Response>`   |
| `spin_until_future_complete()` | ç­‰å¾…ä»»åŠ¡å®Œæˆï¼ˆç±»ä¼¼ `future.get()`ï¼‰ |

---

## ğŸ§© ä¸‰ã€æ€»ç»“å¯¹æ¯”

| é¡¹ç›®     | æ ‡å‡† C++                | ROS 2                                  |
| ------ | --------------------- | -------------------------------------- |
| å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ | `std::async()`        | `client->async_send_request()`         |
| ä»»åŠ¡ç»“æœå¯¹è±¡ | `std::future<T>`      | `rclcpp::Client<T>::SharedFuture`      |
| ç­‰å¾…ä»»åŠ¡å®Œæˆ | `future.get()`        | `rclcpp::spin_until_future_complete()` |
| å¼‚æ­¥å›è°ƒæ–¹å¼ | `.then()`ï¼ˆC++20ï¼‰æˆ–çº¿ç¨‹è½®è¯¢ | `spin()` è‡ªåŠ¨è§¦å‘å›è°ƒ                        |

---

å¦‚æœä½ æƒ³ï¼Œæˆ‘å¯ä»¥æ¥ç€å¸®ä½ å†™ä¸€ä¸ª **åŒæ—¶å‘é€å¤šä¸ªå¼‚æ­¥è¯·æ±‚å¹¶ç­‰å¾…ç»“æœï¼ˆä½¿ç”¨ future.get() / spin_until_future_completeï¼‰** çš„å®Œæ•´ ROS2 C++ ç¤ºä¾‹ï¼Œå¯¹æ¯”å¹¶å‘è°ƒç”¨çš„æ•ˆæœï¼Œè¦æˆ‘å¸®ä½ å†™è¿™ä¸ªä¾‹å­å—ï¼Ÿ
