éå¸¸å¥½ ğŸ‘
è¿™æ˜¯ C++ å¹¶å‘çš„åŸºç¡€ä¹‹ä¸€â€”â€”æŒæ¡ `std::thread` çš„ä½¿ç”¨ï¼Œä½ å°±èƒ½çµæ´»åœ°æ§åˆ¶å¤šçº¿ç¨‹æ‰§è¡Œã€‚æˆ‘ä»¬ä»**æœ€åŸºç¡€åˆ°å®è·µåº”ç”¨**ï¼Œé€æ­¥è®²è§£ã€‚

---

## ğŸ§© ä¸€ã€`std::thread` æ˜¯ä»€ä¹ˆ

`std::thread` æ˜¯ C++11 å¼•å…¥çš„æ ‡å‡†çº¿ç¨‹ç±»ï¼Œç”¨æ¥ï¼š

* å¯åŠ¨ä¸€ä¸ªæ–°çš„æ‰§è¡Œçº¿ç¨‹ï¼›
* åœ¨è¯¥çº¿ç¨‹ä¸­æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼›
* æä¾›æ§åˆ¶æ¥å£ï¼ˆ`join`ã€`detach`ã€`joinable` ç­‰ï¼‰ï¼›
* åº•å±‚åŸºäºç³»ç»Ÿçº¿ç¨‹ï¼ˆå¦‚ POSIX pthreads æˆ– Windows threadsï¼‰ã€‚

---

## ğŸš€ äºŒã€åˆ›å»ºçº¿ç¨‹çš„å‡ ç§æ–¹å¼

### âœ… 1. ä¼ å…¥æ™®é€šå‡½æ•°

```cpp
#include <iostream>
#include <thread>

void worker() {
    std::cout << "Thread running\n";
}

int main() {
    std::thread t(worker);  // åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
    t.join();               // ç­‰å¾…çº¿ç¨‹ç»“æŸ
}
```

è¾“å‡ºï¼š

```
Thread running
```

### âœ… 2. ä¼ å…¥ Lambda

```cpp
std::thread t([] {
    std::cout << "Hello from lambda thread\n";
});
t.join();
```

### âœ… 3. ä¼ å…¥ç±»æˆå‘˜å‡½æ•°

```cpp
#include <thread>
#include <iostream>

class Task {
public:
    void run(int id) {
        std::cout << "Task running " << id << "\n";
    }
};

int main() {
    Task task;
    std::thread t(&Task::run, &task, 42);  // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆå‘˜å‡½æ•°æŒ‡é’ˆ
    t.join();
}
```

---

## ğŸª¢ ä¸‰ã€join / detach / joinable çš„åŒºåˆ«

### ğŸ”¹ `join()`

> ç­‰å¾…è¯¥çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼ˆé˜»å¡ä¸»çº¿ç¨‹ï¼‰ï¼Œå¹¶å›æ”¶ç³»ç»Ÿèµ„æºã€‚

```cpp
std::thread t([] { std::cout << "working...\n"; });
t.join();  // ç­‰å¾…çº¿ç¨‹ç»“æŸ
```

* çº¿ç¨‹è¿è¡Œå®Œä¹‹åï¼Œå¿…é¡»è°ƒç”¨ `join()` æˆ– `detach()`ï¼›
* å¦åˆ™åœ¨çº¿ç¨‹å¯¹è±¡ææ„æ—¶ä¼šæŠ›å¼‚å¸¸ï¼ˆå› ä¸ºçº¿ç¨‹ä»åœ¨è¿è¡Œï¼‰ã€‚

### ğŸ”¹ `detach()`

> å°†çº¿ç¨‹ä¸ `std::thread` å¯¹è±¡åˆ†ç¦»ï¼Œè®©å®ƒâ€œåå°è¿è¡Œâ€ã€‚

```cpp
std::thread t([] {
    std::this_thread::sleep_for(std::chrono::seconds(2));
    std::cout << "detached thread done\n";
});
t.detach(); // ä¸å†èƒ½ join()ï¼Œç‹¬ç«‹è¿è¡Œ
```

ä¸»çº¿ç¨‹ç»“æŸåï¼Œè‹¥ detached çº¿ç¨‹è¿˜æ²¡ç»“æŸï¼Œä¼š**ç»§ç»­è¿è¡Œç›´åˆ°å®Œæˆ**ã€‚

âš ï¸ æ³¨æ„ï¼š

* ä¸€æ—¦ `detach()`ï¼Œä½ å°±**æ— æ³•å†æ§åˆ¶çº¿ç¨‹**ï¼›
* å¦‚æœä¸»ç¨‹åºæå‰é€€å‡ºï¼Œçº¿ç¨‹ä¸­çš„è¾“å‡ºå¯èƒ½è¿˜æ²¡æ‰§è¡Œå®Œï¼›
* å¸¸ç”¨äºåå°ä»»åŠ¡ï¼ˆæ—¥å¿—ã€ç½‘ç»œç›‘å¬ç­‰ï¼‰ã€‚

### ğŸ”¹ `joinable()`

> åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯è¢« `join()`ã€‚

```cpp
std::thread t([]{});
if (t.joinable()) {
    t.join();
}
```

é¿å…é‡å¤ joinï¼ˆå¦åˆ™ä¼šæŠ›å¼‚å¸¸ï¼‰ã€‚

---

## ğŸ§  å››ã€çº¿ç¨‹ä¼ å‚

### âœ… å€¼ä¼ é€’

```cpp
void func(int x) {
    std::cout << x << "\n";
}
std::thread t(func, 10);
t.join();
```

### âœ… å¼•ç”¨ä¼ é€’

éœ€è¦ç”¨ `std::ref()` åŒ…è£…ï¼Œå¦åˆ™ä¼šè¢«æ‹·è´ï¼š

```cpp
void func(int& x) {
    x++;
}
int num = 5;
std::thread t(func, std::ref(num));
t.join();
std::cout << num;  // è¾“å‡º 6
```

---

## ğŸ”„ äº”ã€çº¿ç¨‹ä¼‘çœ ä¸å½“å‰çº¿ç¨‹æ“ä½œ

| å‡½æ•°                                          | åŠŸèƒ½          |
| ------------------------------------------- | ----------- |
| `std::this_thread::sleep_for(duration)`     | è®©å½“å‰çº¿ç¨‹ç¡çœ æŒ‡å®šæ—¶é—´ |
| `std::this_thread::sleep_until(time_point)` | ç¡çœ åˆ°æŒ‡å®šæ—¶é—´     |
| `std::this_thread::get_id()`                | è·å–çº¿ç¨‹ ID     |

```cpp
std::this_thread::sleep_for(std::chrono::milliseconds(500));
```

---

## ğŸ§© å…­ã€å…¸å‹ç”¨æ³•ç¤ºä¾‹

### âœ… å¤šçº¿ç¨‹å¹¶è¡Œè®¡ç®—

```cpp
#include <thread>
#include <vector>
#include <iostream>

void work(int id) {
    std::cout << "Thread " << id << " start\n";
    std::this_thread::sleep_for(std::chrono::milliseconds(500));
    std::cout << "Thread " << id << " done\n";
}

int main() {
    std::vector<std::thread> threads;
    for (int i = 0; i < 4; ++i)
        threads.emplace_back(work, i);

    for (auto& t : threads)
        t.join();

    std::cout << "All threads finished\n";
}
```

---

## ğŸ§¹ ä¸ƒã€å¸¸è§é”™è¯¯ âš ï¸

| é”™è¯¯                    | åŸå›                       |
| --------------------- | ----------------------- |
| âŒ æœª join æˆ– detach å°±ææ„ | ç¨‹åºæŠ›å‡º `std::terminate()` |
| âŒ detach åè®¿é—®å±€éƒ¨å˜é‡      | æ‚¬ç©ºå¼•ç”¨ã€æœªå®šä¹‰è¡Œä¸º              |
| âŒ é‡å¤ join             | æŠ›å¼‚å¸¸                     |
| âŒ çº¿ç¨‹è®¿é—®å…±äº«å˜é‡            | æ•°æ®ç«äº‰ï¼ˆéœ€åŠ é”ï¼‰               |

---

## ğŸ§° å…«ã€æ€»ç»“è®°å¿†è¡¨

| æ–¹æ³•                              | ä½œç”¨           | æ³¨æ„äº‹é¡¹       |
| ------------------------------- | ------------ | ---------- |
| `join()`                        | ç­‰å¾…çº¿ç¨‹ç»“æŸ       | é˜»å¡å½“å‰çº¿ç¨‹     |
| `detach()`                      | åˆ†ç¦»çº¿ç¨‹ï¼Œåå°æ‰§è¡Œ    | æ— æ³•æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ |
| `joinable()`                    | åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯ join | é˜²æ­¢é‡å¤ join  |
| `std::ref()`                    | å¼•ç”¨ä¼ å‚         | å¦åˆ™å‚æ•°ä¼šè¢«æ‹·è´   |
| `std::this_thread::sleep_for()` | å½“å‰çº¿ç¨‹ä¼‘çœ        | å¸¸ç”¨äºé™é€Ÿ/è°ƒåº¦   |

---

## ğŸ”§ ä¸‹ä¸€æ­¥å»ºè®®

ä½ å¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

1. **çº¿ç¨‹åŒæ­¥**ï¼ˆ`std::mutex`ã€`std::lock_guard`ã€`std::unique_lock`ï¼‰
2. **çº¿ç¨‹æ± å°è£…**ï¼ˆ`std::vector<std::thread>` + ä»»åŠ¡é˜Ÿåˆ—ï¼‰
3. **æ¡ä»¶å˜é‡ / future / promise**ï¼ˆçº¿ç¨‹é—´é€šä¿¡ï¼‰

---

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ªå®Œæ•´çš„å°ä¾‹å­ï¼Œæ¯”å¦‚ç”¨çº¿ç¨‹æ± åŒæ—¶ä¸‹è½½å¤šä¸ªæ–‡ä»¶ã€æˆ–è€…å¹¶è¡Œå¤„ç† ROS çš„ä»»åŠ¡ï¼Œç„¶åå±•ç¤º `join`ã€`detach`ã€`mutex` çš„å®é™…ç”¨æ³•ï¼Ÿ
é‚£æ ·ç»“åˆå®æˆ˜æ›´å®¹æ˜“ç†è§£ã€‚

----

## ç¬¬äºŒéƒ¨åˆ† join æ–¹æ³•

ä½ çš„ç†è§£éœ€è¦ä¸€ç‚¹æ¾„æ¸… ğŸ˜‰

> `std::thread t(&Task::run, &task, 42);`
> å¦‚æœä¸ `join()`ï¼Œçº¿ç¨‹æ˜¯ä¸æ˜¯ä¸ä¼šæ‰§è¡Œï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š**çº¿ç¨‹ä¸€æ—¦åˆ›å»ºå°±ä¼šç«‹å³å¼€å§‹æ‰§è¡Œ**ï¼Œ`join()` å¹¶ä¸æ˜¯è®©çº¿ç¨‹å¼€å§‹ï¼Œè€Œæ˜¯ç”¨æ¥ **åŒæ­¥** çš„ã€‚

---

## 1ï¸âƒ£ çº¿ç¨‹æ‰§è¡Œä¸ join çš„å…³ç³»

```cpp
std::thread t(&Task::run, &task, 42); // çº¿ç¨‹åˆ›å»ºå¹¶ç«‹å³å¯åŠ¨
// t.join();  // å¦‚æœä¸ join
```

* `t` å¯¹è±¡åˆ›å»ºåï¼Œçº¿ç¨‹å°±å·²ç»å¼€å§‹æ‰§è¡Œäº†ã€‚
* å¦‚æœä½ ä¸ `join()` æˆ– `detach()`ï¼Œçº¿ç¨‹ä»ç„¶è¿è¡Œï¼Œä½†æ˜¯ï¼š

  * å½“ `t` å¯¹è±¡ææ„æ—¶ï¼Œç¨‹åºä¼šæŠ›å‡º **std::terminate()**ï¼Œå› ä¸º C++ ä¸å…è®¸ä¸€ä¸ªæœªå¤„ç†çš„çº¿ç¨‹å¯¹è±¡ææ„ã€‚
* `join()` åªæ˜¯ **é˜»å¡å½“å‰çº¿ç¨‹ï¼ˆé€šå¸¸æ˜¯ä¸»çº¿ç¨‹ï¼‰ç›´åˆ° t çº¿ç¨‹ç»“æŸ**ã€‚

---

## 2ï¸âƒ£ çº¿ç¨‹ä¸ join æ—¶çš„è¡Œä¸º

| æƒ…å†µ               | çº¿ç¨‹æ‰§è¡Œ               | èµ„æºé‡Šæ”¾                |
| ---------------- | ------------------ | ------------------- |
| ä¸ join ä¹Ÿä¸ detach | çº¿ç¨‹ä»ç„¶æ‰§è¡Œï¼Œä½†çº¿ç¨‹å¯¹è±¡ææ„ä¼šæŠ›å¼‚å¸¸ | OS èµ„æºæœªå›æ”¶ â†’ ç¨‹åºå´©æºƒ     |
| join()           | é˜»å¡ç­‰å¾…çº¿ç¨‹ç»“æŸ           | çº¿ç¨‹ç»“æŸåå›æ”¶èµ„æº           |
| detach()         | çº¿ç¨‹åå°æ‰§è¡Œ             | çº¿ç¨‹ç»“æŸåç³»ç»Ÿè‡ªåŠ¨å›æ”¶èµ„æºï¼Œç¨‹åºä¸é˜»å¡ |

æ‰€ä»¥ **join çš„ä½œç”¨æ˜¯åŒæ­¥å’Œå›æ”¶çº¿ç¨‹èµ„æº**ï¼Œè€Œä¸æ˜¯å¯åŠ¨çº¿ç¨‹ã€‚

---

## 3ï¸âƒ£ å°ç¤ºä¾‹éªŒè¯

```cpp
#include <iostream>
#include <thread>
#include <chrono>

void run(int id) {
    std::cout << "Thread " << id << " started\n";
    std::this_thread::sleep_for(std::chrono::seconds(1));
    std::cout << "Thread " << id << " finished\n";
}

int main() {
    std::thread t(run, 1);

    std::cout << "Main thread continues\n";

    // t.join();  // å¦‚æœæ³¨é‡Šæ‰ä¼šæŠ¥ terminate
    t.detach();   // åˆ†ç¦»çº¿ç¨‹
    std::this_thread::sleep_for(std::chrono::seconds(2));
}
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
Thread 1 started
Main thread continues
Thread 1 finished
```

* å¯ä»¥çœ‹åˆ°çº¿ç¨‹å·²ç»æ‰§è¡Œäº†ï¼›
* `detach()` åä¸»çº¿ç¨‹ç»§ç»­è¿è¡Œï¼Œä¸é˜»å¡ï¼›
* å¦‚æœæ—¢ä¸ join ä¹Ÿä¸ detachï¼Œä¼šå´©æºƒã€‚

---

## âœ… ç»“è®º

1. **çº¿ç¨‹åˆ›å»ºå³å¼€å§‹æ‰§è¡Œ**
2. **join() æ˜¯åŒæ­¥å’Œå›æ”¶èµ„æºçš„æœºåˆ¶**
3. **detach() è®©çº¿ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œè‡ªåŠ¨å›æ”¶èµ„æº**
4. **å¿…é¡»åœ¨çº¿ç¨‹å¯¹è±¡ææ„å‰å¤„ç†**ï¼Œå¦åˆ™ç¨‹åºä¼š terminate

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç”»ä¸€å¼  **çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå›¾**ï¼Œç›´è§‚æ˜¾ç¤º `join`ã€`detach`ã€ä¸»çº¿ç¨‹é€€å‡ºæ—¶çš„å…³ç³»ï¼Œè¿™æ ·ä½ ä¸€çœ‹å°±æ‡‚ä»€ä¹ˆæ—¶å€™çº¿ç¨‹åœ¨è¿è¡Œã€ä»€ä¹ˆæ—¶å€™åœ¨ç­‰å¾…ã€‚

ä½ æƒ³è¦æˆ‘ç”»å—ï¼Ÿ
