
éå¸¸å¥½çš„é—®é¢˜ ğŸ‘
è¿™æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­æœ€æ ¸å¿ƒã€ä¹Ÿæ˜¯æœ€å®¹æ˜“â€œè¸©å‘â€çš„ä¸€éƒ¨åˆ†ã€‚
æˆ‘ä»¬æ¥ç³»ç»Ÿè®²æ¸…æ¥šï¼š

> **åœ¨çº¿ç¨‹æ± ä¸­ï¼Œä»»åŠ¡æ‰§è¡Œçš„â€œå®é™…é¡ºåºâ€å’Œä»»åŠ¡ç»“æœçš„â€œè¿”å›é¡ºåºâ€å¦‚ä½•æ§åˆ¶ä¸ä¿æŒä¸€è‡´ã€‚**

---

## ğŸ§© ä¸€ã€çº¿ç¨‹æ± ä¸­ä»»åŠ¡æ‰§è¡Œçš„åŸºæœ¬åŸç†

çº¿ç¨‹æ± ï¼ˆThread Poolï¼‰ä¸€èˆ¬ç»“æ„å¦‚ä¸‹ï¼š

```cpp
[ä»»åŠ¡æäº¤çº¿ç¨‹]  --->  [ä»»åŠ¡é˜Ÿåˆ—]  --->  [å¤šä¸ªå·¥ä½œçº¿ç¨‹]
```

* ä¸»çº¿ç¨‹è°ƒç”¨ `submit(task)`ï¼›
* ä»»åŠ¡è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä¸€èˆ¬æ˜¯ FIFO é˜Ÿåˆ—ï¼‰ï¼›
* å·¥ä½œçº¿ç¨‹ä¸æ–­ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ‰§è¡Œã€‚

ä½† âš ï¸ **â€œå–ä»»åŠ¡çš„é¡ºåºâ€å¹¶ä¸ä»£è¡¨â€œå®Œæˆçš„é¡ºåºâ€**ã€‚

> å³ä½¿ä»»åŠ¡æ˜¯æŒ‰é¡ºåºå…¥é˜Ÿï¼ˆTask1, Task2, Task3ï¼‰ï¼Œ
> çº¿ç¨‹æ± ä¸­çš„ Task3 å¯èƒ½å…ˆæ‰§è¡Œå®Œã€‚

---

## ğŸ§  äºŒã€ä»»åŠ¡æ‰§è¡Œé¡ºåº vs ç»“æœè¿”å›é¡ºåº

| é¡¹ç›®         | æè¿°                        |
| ---------- | ------------------------- |
| **ä»»åŠ¡æ‰§è¡Œé¡ºåº** | å†³å®šäºé˜Ÿåˆ—è°ƒåº¦ + CPU ç«äº‰ + æ¯ä¸ªä»»åŠ¡è€—æ—¶ |
| **ç»“æœè¿”å›é¡ºåº** | å¯ç”±ä¸»çº¿ç¨‹æ”¶é›† future çš„é¡ºåºæ§åˆ¶      |

---

### ğŸ”¸ ä¾‹å­ï¼šé¡ºåºæ‰§è¡Œä½†æ— åºè¿”å›

```cpp
#include <iostream>
#include <future>
#include <vector>
#include <thread>
#include <chrono>

int task(int id, int delay) {
    std::this_thread::sleep_for(std::chrono::milliseconds(delay));
    return id;
}

int main() {
    std::vector<std::future<int>> futures;
    for (int i = 0; i < 3; ++i)
        futures.push_back(std::async(std::launch::async, task, i, 100 * (3 - i)));

    for (auto& f : futures)
        std::cout << f.get() << " ";  // è¿”å›é¡ºåº == æäº¤é¡ºåº
}
```

è™½ç„¶æ‰§è¡Œå¿«çš„ä»»åŠ¡å…ˆå®Œæˆï¼Œä½†ï¼š

* å› ä¸ºæˆ‘ä»¬**æŒ‰ futures çš„æ’å…¥é¡ºåº**å» `.get()`ï¼›
* æ‰€ä»¥æœ€ç»ˆè¾“å‡ºä»æ˜¯ **0 1 2**ã€‚

---

## ğŸ§© ä¸‰ã€çº¿ç¨‹æ± ä¸­å¦‚ä½•æ§åˆ¶â€œæ‰§è¡Œé¡ºåºâ€

çº¿ç¨‹æ± é»˜è®¤æ˜¯**å¹¶å‘æ‰§è¡Œã€æ— åºå®Œæˆ**çš„ã€‚
è‹¥è¦æ§åˆ¶â€œä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œâ€ï¼Œå¸¸è§æœ‰ä¸‰ç§æ–¹æ³•ï¼š

---

### âœ… æ–¹æ³• 1ï¼šå•çº¿ç¨‹æ‰§è¡Œï¼ˆé¡ºåºé˜Ÿåˆ—ï¼‰

å¦‚æœä»»åŠ¡å¿…é¡»**ä¸¥æ ¼é¡ºåºæ‰§è¡Œ**ï¼ˆå¦‚æ—¥å¿—ã€ä¸²è¡Œä¾èµ–ï¼‰ï¼Œ
å¯ä»¥åˆ›å»ºä¸€ä¸ª **å•çº¿ç¨‹çº¿ç¨‹æ± **ï¼š

```cpp
std::thread worker;
std::queue<std::function<void()>> queue;
std::mutex mtx;
std::condition_variable cv;
bool stop = false;

void start() {
    worker = std::thread([] {
        while (true) {
            std::function<void()> task;
            {
                std::unique_lock<std::mutex> lock(mtx);
                cv.wait(lock, [] { return stop || !queue.empty(); });
                if (stop && queue.empty()) return;
                task = std::move(queue.front());
                queue.pop();
            }
            task(); // ä¸²è¡Œæ‰§è¡Œ
        }
    });
}

void submit(std::function<void()> f) {
    {
        std::lock_guard<std::mutex> lock(mtx);
        queue.push(std::move(f));
    }
    cv.notify_one();
}
```

ğŸ“˜ **ç‰¹ç‚¹ï¼š**

* æ‰€æœ‰ä»»åŠ¡æ’é˜ŸæŒ‰é¡ºåºæ‰§è¡Œï¼›
* ä½†åªèƒ½å•çº¿ç¨‹ï¼ˆæ²¡æœ‰å¹¶å‘ï¼‰ã€‚

---

### âœ… æ–¹æ³• 2ï¼šåœ¨ä»»åŠ¡å†…éƒ¨ç”¨ future é“¾æ¥é¡ºåºä¾èµ–

å¦‚æœæƒ³å¹¶å‘æ‰§è¡Œä½†ä¿æŒâ€œé€»è¾‘é¡ºåºâ€ï¼Œ
å¯ä»¥è®©ä»»åŠ¡ä¾èµ–å‰ä¸€ä¸ªä»»åŠ¡çš„ `future`ï¼š

```cpp
std::future<void> f1 = pool.submit([] { std::cout << "A\n"; });
std::future<void> f2 = pool.submit([&] { f1.wait(); std::cout << "B\n"; });
std::future<void> f3 = pool.submit([&] { f2.wait(); std::cout << "C\n"; });
```

ğŸ“˜ **ç‰¹ç‚¹ï¼š**

* å„ä»»åŠ¡ä»åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼›
* ä½†é€šè¿‡ç­‰å¾…å‰ç½®ä»»åŠ¡ `future` æ¥ä¿è¯é€»è¾‘é¡ºåºã€‚

---

### âœ… æ–¹æ³• 3ï¼šåœ¨æäº¤ç«¯æ§åˆ¶ï¼ˆæŒ‰åºæäº¤ã€æŒ‰åºè·å–ï¼‰

çº¿ç¨‹æ± æ˜¯å¹¶å‘çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼š

* **æŒ‰é¡ºåºæäº¤ä»»åŠ¡ï¼›**
* **æŒ‰é¡ºåºç­‰å¾…ç»“æœï¼ˆfutureï¼‰**ï¼›

æ¥ä¿æŒç»“æœé¡ºåºä¸€è‡´ï¼š

```cpp
std::vector<std::future<int>> results;
for (int i = 0; i < 10; ++i)
    results.push_back(pool.submit([i]{ return i*i; }));

// é¡ºåºæ”¶é›†ç»“æœ
for (auto& r : results)
    std::cout << r.get() << " ";
```

ğŸ“˜ **ç»“æœæ˜¯æŒ‰æäº¤é¡ºåºè¿”å›çš„**ï¼Œ
å³ä¾¿æ‰§è¡Œé¡ºåºæ— åºï¼Œå› ä¸º `.get()` æŒ‰åºå–å€¼ã€‚

---

## ğŸ§© å››ã€çº¿ç¨‹æ± ä¸­å¦‚ä½•æ§åˆ¶â€œç»“æœè¿”å›é¡ºåºâ€

å³ä¾¿çº¿ç¨‹æ± å†…ä»»åŠ¡ä¹±åºå®Œæˆï¼Œä¹Ÿå¯ä»¥ï¼š

1. **åœ¨ä¸»çº¿ç¨‹ç»´æŠ¤ future é¡ºåºè¡¨ï¼›**
2. **éå† future æ—¶æŒ‰ä»»åŠ¡æäº¤é¡ºåº get()ã€‚**

è¿™æ ·ç»“æœé¡ºåº = æäº¤é¡ºåº âœ…

---

### ğŸ”¸ ç¤ºä¾‹ï¼šä»»åŠ¡ä¹±åºå®Œæˆï¼Œä½†ç»“æœæŒ‰é¡ºåºè¿”å›

```cpp
#include <iostream>
#include <future>
#include <thread>
#include <vector>
#include <chrono>

int work(int id, int delay) {
    std::this_thread::sleep_for(std::chrono::milliseconds(delay));
    return id;
}

int main() {
    std::vector<std::future<int>> futures;
    for (int i = 0; i < 5; ++i)
        futures.push_back(std::async(std::launch::async, work, i, 100 * (5 - i)));

    // é¡ºåºè·å–ç»“æœ
    for (auto& f : futures)
        std::cout << f.get() << " ";
}
```

è¾“å‡ºï¼š`0 1 2 3 4`
å³ä½¿ä»»åŠ¡ 4 æœ€å¿«å®Œæˆï¼Œä¹Ÿä¿æŒé¡ºåºè¾“å‡ºã€‚

---

## âš™ï¸ äº”ã€çº¿ç¨‹æ± ä¸­çš„é«˜çº§æ§åˆ¶æŠ€å·§

| åœºæ™¯                 | æ§åˆ¶æ‰‹æ®µ                                          |
| ------------------ | --------------------------------------------- |
| **ä»»åŠ¡æŒ‰æäº¤é¡ºåºæ‰§è¡Œ**      | å•çº¿ç¨‹æ±  / é¡ºåºé˜Ÿåˆ—                                   |
| **ä»»åŠ¡ä¹±åºæ‰§è¡Œä½†ç»“æœæŒ‰åºè¿”å›**  | futures æŒ‰æäº¤é¡ºåºå­˜å‚¨                               |
| **ä»»åŠ¡å­˜åœ¨ä¾èµ–å…³ç³»**       | `future.wait()` é“¾æ¥ä¾èµ–                          |
| **å¿…é¡»æŒ‰ä»»åŠ¡ä¾èµ– DAG æ‰§è¡Œ** | ç”¨ `std::promise` / `std::shared_future` ä½œä¸ºåŒæ­¥ç‚¹ |

---

### ğŸ”¸ ç¤ºä¾‹ï¼šåŸºäº `shared_future` çš„ä¾èµ–æ§åˆ¶

```cpp
std::shared_future<void> prev = std::async(std::launch::async, []{
    std::cout << "Task 1\n";
}).share();

for (int i = 2; i <= 4; ++i) {
    prev = std::async(std::launch::async, [i, prev]() {
        prev.wait();
        std::cout << "Task " << i << "\n";
    }).share();
}
```

è¾“å‡ºå›ºå®šï¼š

```
Task 1
Task 2
Task 3
Task 4
```

---

## ğŸ§© å…­ã€å®é™…å·¥ç¨‹ä¸­å¸¸è§åšæ³•ï¼ˆæ€»ç»“ï¼‰

| ç›®æ ‡          | å¸¸ç”¨æ–¹æ³•                                     |
| ----------- | ---------------------------------------- |
| ä¸¥æ ¼é¡ºåºæ‰§è¡Œ      | å•çº¿ç¨‹æ±  / ä»»åŠ¡ä¸²è¡ŒåŒ–                             |
| å¤šçº¿ç¨‹å¹¶å‘ä½†é¡ºåºè¾“å‡º  | ä¿å­˜ `future` é¡ºåºåˆ—è¡¨ï¼ŒæŒ‰åº `get()`              |
| ä»»åŠ¡ä¾èµ–ï¼ˆå¦‚æµæ°´çº¿ï¼‰  | ç”¨ `future.wait()` æˆ– `shared_future` é“¾æ¥ä¾èµ– |
| åŒæ­¥å®Œæˆç­‰å¾…æ‰€æœ‰ä»»åŠ¡  | `std::when_all()` æˆ–è®¡æ•°å™¨ barrier           |
| ç»“æœæŒ‰æ‰§è¡Œå®Œæˆé¡ºåºè¾“å‡º | ä½¿ç”¨ `std::future::wait_for` + ä¼˜å…ˆé˜Ÿåˆ—æ”¶é›†å®Œæˆä»»åŠ¡  |

---

## âœ… ä¸ƒã€æ€»ç»“ä¸€å¥è¯

> åœ¨çº¿ç¨‹æ± ä¸­ï¼š
>
> * **æ‰§è¡Œé¡ºåº** ç”±ä»»åŠ¡è°ƒåº¦å’Œçº¿ç¨‹ç«äº‰å†³å®šï¼›
> * **ç»“æœé¡ºåº** ç”±ä½ æ”¶é›† `future` çš„é¡ºåºå†³å®šï¼›
> * è‹¥è¦ä¿æŒé€»è¾‘é¡ºåºï¼Œéœ€ç”¨ **ä¾èµ–é“¾ï¼ˆfuture.waitï¼‰æˆ–å•çº¿ç¨‹æ± ** æ§åˆ¶ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ªå®Œæ•´çš„ **C++17 çº¿ç¨‹æ± ç±»**ï¼Œ
æ”¯æŒï¼š

* å¼‚æ­¥ä»»åŠ¡æäº¤ï¼ˆ`submit()`ï¼‰ï¼›
* ä¿æŒç»“æœé¡ºåºï¼›
* æ”¯æŒä¾èµ–ï¼ˆ`shared_future` é“¾æ¥ï¼‰ï¼›
* å¸¦çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—å®ç°ã€‚

è¦æˆ‘å¸®ä½ å†™è¿™ä¸ªç¤ºä¾‹å—ï¼Ÿ
