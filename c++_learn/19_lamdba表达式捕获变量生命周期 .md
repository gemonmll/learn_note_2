
---
# æ•è·å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ

---

éå¸¸å¥½çš„é—®é¢˜ğŸ‘ï¼Œä½ è¿™å¥é—®å¾—éå¸¸å…³é”®ï¼Œè¯´æ˜ä½ å·²ç»æ³¨æ„åˆ°äº† **å¤šçº¿ç¨‹ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ** çš„æ ¸å¿ƒé—®é¢˜ã€‚

æˆ‘ä»¬æ¥å®Œæ•´è§£é‡Šä¸‹ï¼š

> â€œåœ¨ä¸»çº¿ç¨‹æ•è·çš„ `node`ï¼Œå¦‚ä½•ä¿è¯åœ¨å­çº¿ç¨‹ä¸­è¿è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«é”€æ¯ï¼Ÿâ€

---

## ğŸ§© ä¸€ã€`node` æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ

åœ¨ ROS 2 C++ ä¸­ï¼Œåˆ›å»ºèŠ‚ç‚¹é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š

```cpp
auto node = rclcpp::Node::make_shared("my_node");
```

è¿™ä¸ªå‡½æ•°è¿”å›ç±»å‹æ˜¯ï¼š

```cpp
std::shared_ptr<rclcpp::Node>
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`node` æ˜¯ä¸€ä¸ª **æ™ºèƒ½æŒ‡é’ˆï¼ˆ`shared_ptr`ï¼‰**ï¼Œ
ç”¨äºè‡ªåŠ¨ç®¡ç† `rclcpp::Node` å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚

---

## ğŸ§  äºŒã€shared_ptr çš„æ ¸å¿ƒæœºåˆ¶

`std::shared_ptr` çš„æœ¬è´¨æ˜¯ä¸€ä¸ª **å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆ**ã€‚
å®ƒè®°å½•æœ‰å¤šå°‘ä¸ªåœ°æ–¹æŒæœ‰è¯¥å¯¹è±¡çš„â€œå…±äº«æ‰€æœ‰æƒâ€ã€‚

ä¾‹å¦‚ï¼š

```cpp
auto a = std::make_shared<int>(10);
auto b = a;  // å¼•ç”¨è®¡æ•° +1
```

å½“æœ€åä¸€ä¸ª `shared_ptr` é”€æ¯æ—¶ï¼Œå¯¹è±¡æ‰ä¼šé‡Šæ”¾ã€‚

---

## ğŸ§µ ä¸‰ã€åœ¨ä½ çš„ä¾‹å­ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸæ˜¯è¿™æ ·çš„ï¼š

ä»£ç ç‰‡æ®µï¼š

```cpp
std::promise<void> stop_async_spinner;
std::thread async_spinner_thread(
  [stop_token = stop_async_spinner.get_future(), node]() {
      rclcpp::executors::SingleThreadedExecutor executor;
      executor.add_node(node);
      executor.spin_until_future_complete(stop_token);
  });
```

æˆ‘ä»¬é‡ç‚¹çœ‹ **æ•è· `[ ..., node ]` è¿™ä¸€éƒ¨åˆ†**ï¼š

å½“ä½ å†™ä¸‹ï¼š

```cpp
[node]
```

ç›¸å½“äº **æŒ‰å€¼æ•è·** `node`ã€‚

âš™ï¸ å³ï¼š

* ä¸»çº¿ç¨‹ä¸­æœ‰ä¸€ä¸ª `std::shared_ptr<rclcpp::Node> node`
* æ•è·æ—¶ï¼Œä¼š**æ‹·è´ä¸€ä»½** `shared_ptr`ï¼ˆè€Œä¸æ˜¯æ‹·è´æ•´ä¸ª Nodeï¼‰
* æ‰€ä»¥å¼•ç”¨è®¡æ•° +1

---

## ğŸ” å››ã€ç”Ÿå‘½å‘¨æœŸçš„å…·ä½“è¿‡ç¨‹

1ï¸âƒ£ ä¸»çº¿ç¨‹åˆ›å»ºèŠ‚ç‚¹ï¼š

```cpp
auto node = rclcpp::Node::make_shared("my_node");
```

æ­¤æ—¶å¼•ç”¨è®¡æ•°ä¸º `1`ã€‚

2ï¸âƒ£ å¯åŠ¨å­çº¿ç¨‹å¹¶æ•è·ï¼š

```cpp
std::thread t([node]() { ... });
```

æ­¤æ—¶æ•è·çš„ `node`ï¼ˆå‰¯æœ¬ï¼‰ä½¿å¼•ç”¨è®¡æ•°å˜ä¸º `2`ã€‚

3ï¸âƒ£ ä¸»çº¿ç¨‹å¯èƒ½ç»§ç»­åšäº‹ï¼Œç”šè‡³é”€æ¯åŸå§‹å˜é‡ï¼š

```cpp
node.reset();  // å¼•ç”¨è®¡æ•° -1ï¼Œä½†å¯¹è±¡ä»ç„¶æ´»ç€
```

åªè¦å­çº¿ç¨‹è¿˜æŒæœ‰ `node`ï¼Œå¯¹è±¡ä»ç„¶å­˜åœ¨ã€‚

4ï¸âƒ£ å­çº¿ç¨‹ç»“æŸåï¼Œæ•è·çš„ `node` ç¦»å¼€ä½œç”¨åŸŸï¼š

```cpp
t.join();  // å­çº¿ç¨‹é€€å‡º
```

å­çº¿ç¨‹ä¸­çš„ `node` è¢«é”€æ¯ï¼Œå¼•ç”¨è®¡æ•° -1ï¼Œå˜ä¸º 0 â†’ å¯¹è±¡ææ„ã€‚

âœ… **æ‰€ä»¥ï¼Œåªè¦å­çº¿ç¨‹çš„ lambda æ•è·äº† node çš„ shared_ptrï¼Œ
Node å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸€å®šèƒ½å»¶ç»­åˆ°çº¿ç¨‹ç»“æŸã€‚**

---

## ğŸ”’ äº”ã€å¦‚æœä½ æ•è·çš„æ˜¯è£¸æŒ‡é’ˆï¼Œä¼šå‡ºäº‹

æ¯”å¦‚è¿™æ ·ï¼š

```cpp
auto node = rclcpp::Node::make_shared("my_node");
std::thread t([node_ptr = node.get()]() {
    node_ptr->do_something();
});
```

è¿™ç§æ•è·æ–¹å¼æ˜¯å±é™©çš„ï¼š

* æ•è·çš„æ˜¯è£¸æŒ‡é’ˆï¼›
* å¦‚æœä¸»çº¿ç¨‹ `node.reset()` æå‰é‡Šæ”¾ï¼›
* å­çº¿ç¨‹å†è®¿é—® `node_ptr` å°±æ˜¯ **æ‚¬å‚æŒ‡é’ˆï¼ˆdangling pointerï¼‰**ã€‚

ğŸ’€â†’ å…¸å‹çš„å¤šçº¿ç¨‹å´©æºƒåœºæ™¯ã€‚

---

## ğŸ§± å…­ã€æ­£ç¡®ä½¿ç”¨ shared_ptr çš„ç†ç”±

| æ•è·æ–¹å¼                  | ç”Ÿå‘½å‘¨æœŸå®‰å…¨æ€§  | è¯´æ˜                    |
| --------------------- | -------- | --------------------- |
| `[node]`              | âœ… å®‰å…¨     | æ•è· shared_ptr çš„å‰¯æœ¬     |
| `[&node]`             | âš ï¸ å¯èƒ½ä¸å®‰å…¨ | æ•è·å¼•ç”¨ï¼Œè‹¥ä¸»çº¿ç¨‹ reset() å°±æ‚¬ç©º |
| `[node = node.get()]` | âŒ ä¸å®‰å…¨    | æ•è·è£¸æŒ‡é’ˆï¼Œå¯èƒ½æ‚¬ç©º            |

---

## âœ… ä¸ƒã€æ€»ç»“ä¸€å¥è¯

> `node` æ˜¯ä¸€ä¸ª `std::shared_ptr`ï¼Œlambda æ•è·å®ƒæ—¶ä¼šå¤åˆ¶è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œä»è€Œå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¿è¯èŠ‚ç‚¹å¯¹è±¡åœ¨å­çº¿ç¨‹è¿è¡ŒæœŸé—´ä¸ä¼šè¢«é”€æ¯ã€‚

---

## ğŸ” å»¶ä¼¸ï¼ˆé¢å¤–æŠ€å·§ï¼‰

æœ‰æ—¶å€™æˆ‘ä»¬ä¼šæ˜¾å¼ä½¿ç”¨ `std::weak_ptr` æ¥é¿å…å¾ªç¯å¼•ç”¨ï¼Œæ¯”å¦‚ï¼š

```cpp
std::weak_ptr<rclcpp::Node> weak_node = node;
std::thread t([weak_node]() {
    if (auto n = weak_node.lock()) {
        // node è¿˜æ´»ç€
        n->get_logger();
    } else {
        // node å·²é”€æ¯
    }
});
```

è¿™ç§æ–¹å¼é€‚åˆé•¿æœŸåå°çº¿ç¨‹ï¼Œé˜²æ­¢ node æ°¸è¿œä¸è¢«é”€æ¯ã€‚

---

æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ ç”»ä¸€å¼ å›¾ï¼ˆå¼•ç”¨è®¡æ•°éšæ•è·/é‡Šæ”¾å˜åŒ–çš„æµç¨‹å›¾ï¼‰ï¼Œè®©è¿™ä¸ªç”Ÿå‘½å‘¨æœŸæ›´æ¸…æ¥šï¼Ÿ

---
# æ ·ä¾‹å­¦ä¹ 

éå¸¸å¥½çš„é—®é¢˜ï¼ğŸ‘
ä½ è¿™ä¸€æ®µä»£ç å…¶å®å±•ç¤ºäº† **ROS 2 å¼‚æ­¥ spin æ¨¡å¼** çš„é«˜çº§å†™æ³• â€”â€”
è®©ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹å» spinï¼ˆæ‰§è¡Œå›è°ƒï¼‰ï¼Œè€Œä¸»çº¿ç¨‹å¯ä»¥è‡ªç”±åšåˆ«çš„äº‹ã€‚

æˆ‘ä»¬æ¥é€è¡Œæ·±åº¦è§£æè¿™ä¸€æ®µ ğŸ‘‡

---

## ğŸ”¹å®Œæ•´ä»£ç 

```cpp
std::promise<void> stop_async_spinner;
std::thread async_spinner_thread(
  [stop_token = stop_async_spinner.get_future(), node]() {
    rclcpp::executors::SingleThreadedExecutor executor;
    executor.add_node(node);
    executor.spin_until_future_complete(stop_token);
  });
```

---

## ğŸ§© 1ï¸âƒ£ `std::promise<void>` ä¸ `std::future<void>`

è¿™ä¸¤ä¸ªæ˜¯ **C++ æ ‡å‡†åº“çš„åŒæ­¥é€šä¿¡å·¥å…·**ã€‚
å¯ä»¥ç†è§£æˆä¸€ä¸ªã€Œçº¿ç¨‹é—´çš„ä¿¡å·æœºåˆ¶ã€ï¼š

| å¯¹è±¡                   | è°æŒæœ‰ | ä½œç”¨             |
| -------------------- | --- | -------------- |
| `std::promise<void>` | ä¸»çº¿ç¨‹ | æœªæ¥æŸä¸ªæ—¶åˆ»å¯ä»¥â€œå‘å‡ºä¿¡å·â€ |
| `std::future<void>`  | å­çº¿ç¨‹ | å¯ä»¥ç­‰å¾…ä¿¡å·è¢«è§¦å‘      |

è°ƒç”¨å…³ç³»ï¼š

```cpp
auto fut = promise.get_future();  // è·å–å…³è”çš„ future
// ä¹‹ååœ¨åˆ«çš„çº¿ç¨‹ï¼š
promise.set_value();  // å‘ä¿¡å·
// å¯¹åº”çš„ future ä¼šâ€œå®Œæˆâ€ï¼ˆå³ readyï¼‰
```

åœ¨è¿™é‡Œï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡è¢«ç”¨æ¥**ä¼˜é›…åœ°åœæ­¢ spin å¾ªç¯**ã€‚

---

## ğŸ§© 2ï¸âƒ£ lambda æ•è·éƒ¨åˆ†

```cpp
[stop_token = stop_async_spinner.get_future(), node]()
```

ğŸ”¸ æ•è·äº†ï¼š

* ä¸€ä¸ª `stop_token`ï¼ˆä¹Ÿå°±æ˜¯ `std::future<void>`ï¼‰
* ä¸€ä¸ª `node`ï¼ˆå…±äº«æŒ‡é’ˆï¼‰

> æ³¨æ„è¿™æ˜¯**æŒ‰å€¼æ•è·**ï¼ˆæ‹·è´è¿›å…¥ lambda ä¸­ï¼‰ï¼Œ
> ç¡®ä¿çº¿ç¨‹å†…éƒ¨æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼Œä¸å—å¤–éƒ¨ä½œç”¨åŸŸå½±å“ã€‚

---

## ğŸ§© 3ï¸âƒ£ `rclcpp::executors::SingleThreadedExecutor executor;`

åœ¨ ROS 2 ä¸­ï¼Œ`Executor` æ˜¯è´Ÿè´£æ‰§è¡Œå›è°ƒçš„æ ¸å¿ƒæœºåˆ¶ã€‚
`SingleThreadedExecutor` è¡¨ç¤ºï¼š

* æ‰€æœ‰å›è°ƒéƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­é¡ºåºæ‰§è¡Œã€‚
* ä¸€èˆ¬ç”¨äºç®€å•æƒ…å†µæˆ–è°ƒè¯•ï¼ˆå¤æ‚åº”ç”¨ä¸­ä¹Ÿæœ‰ `MultiThreadedExecutor`ï¼‰ã€‚

---

## ğŸ§© 4ï¸âƒ£ `executor.add_node(node);`

æŠŠå½“å‰èŠ‚ç‚¹åŠ å…¥åˆ°è¿™ä¸ª executor çš„ç®¡ç†åˆ—è¡¨ä¸­ã€‚

æ¢å¥è¯è¯´ï¼š
ã€Œè¿™ä¸ª executor è´Ÿè´£ç›‘æ§ node çš„å®šæ—¶å™¨ã€è®¢é˜…è€…ã€æœåŠ¡ç­‰äº‹ä»¶ã€‚ã€

---

## ğŸ§© 5ï¸âƒ£ `executor.spin_until_future_complete(stop_token);`

è¿™è¡Œéå¸¸å…³é”® ğŸ‘‡

### ğŸ§  æ™®é€š `spin()` æ˜¯ï¼š

```cpp
executor.spin();
```

â¡ï¸ ä¼š**ä¸€ç›´å¾ªç¯ç­‰å¾…äº‹ä»¶**ï¼Œç›´åˆ°èŠ‚ç‚¹è¢«é”€æ¯æˆ–è¢«ä¸­æ–­ï¼ˆCtrl+Cï¼‰ã€‚

### ğŸ§  è€Œ `spin_until_future_complete(future)` æ˜¯ï¼š

```cpp
executor.spin_until_future_complete(future);
```

â¡ï¸ å®ƒä¼š**æŒç»­å¤„ç†å›è°ƒäº‹ä»¶**ï¼Œ
ç›´åˆ°è¿™ä¸ª `future` å¯¹è±¡è¢«â€œæ ‡è®°ä¸ºå®Œæˆâ€ï¼ˆ`promise.set_value()` è¢«è°ƒç”¨ï¼‰ã€‚

ç­‰ä»·é€»è¾‘å¦‚ä¸‹ï¼š

```cpp
while (!future.ready()) {
  æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†å›è°ƒ;
}
```

å› æ­¤ï¼Œä½ å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­è¿™æ ·åœæ­¢å¼‚æ­¥ spinï¼š

```cpp
stop_async_spinner.set_value();  // é€šçŸ¥ future å®Œæˆ
async_spinner_thread.join();     // ç­‰å¾…çº¿ç¨‹é€€å‡º
```

è¿™å°±æ¯”ç›´æ¥è°ƒç”¨ `executor.cancel()` æ›´å®‰å…¨ã€æ›´ä¼˜é›…ã€‚

---

## ğŸ§© 6ï¸âƒ£ `std::thread async_spinner_thread(...)`

è¿™ä¸€è¡Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚
é‡Œé¢æ‰§è¡Œçš„ lambda é€»è¾‘æ˜¯ï¼š

> â€œåœ¨è¿™ä¸ªçº¿ç¨‹é‡Œåˆ›å»º executorï¼Œè¿è¡Œ node çš„æ‰€æœ‰å›è°ƒäº‹ä»¶ï¼Œç›´åˆ°æ¥åˆ° stop ä¿¡å·ã€‚â€

è¿™æ ·ï¼Œ**spin ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹**ã€‚
ä¸»çº¿ç¨‹å°±å¯ä»¥è‡ªç”±æ‰§è¡Œå…¶å®ƒé€»è¾‘ï¼ˆä¾‹å¦‚ç­‰å¾…è¾“å…¥ã€å‘å¸ƒå‘½ä»¤ã€è°ƒç”¨ service ç­‰ï¼‰ã€‚

---

## âš™ï¸ ä¸¾ä¸ªå®Œæ•´çš„ä¾‹å­

```cpp
auto node = std::make_shared<MyNode>();
std::promise<void> stop_async_spinner;

// å¯åŠ¨å¼‚æ­¥ spin
std::thread async_spinner_thread(
  [stop_token = stop_async_spinner.get_future(), node]() {
    rclcpp::executors::SingleThreadedExecutor executor;
    executor.add_node(node);
    executor.spin_until_future_complete(stop_token);
  });

// ä¸»çº¿ç¨‹å¯ä»¥åšè‡ªå·±çš„äº‹
std::this_thread::sleep_for(std::chrono::seconds(5));
RCLCPP_INFO(node->get_logger(), "Stopping spin...");

// é€šçŸ¥å¼‚æ­¥çº¿ç¨‹é€€å‡º
stop_async_spinner.set_value();
async_spinner_thread.join();
RCLCPP_INFO(node->get_logger(), "Stopped cleanly");
```

âœ… è¾“å‡ºï¼š

```
[INFO] [main]: Stopping spin...
[INFO] [main]: Stopped cleanly
```

---

## ğŸ§© æ€»ç»“

| æ¦‚å¿µ                             | å«ä¹‰                               |
| ------------------------------ | -------------------------------- |
| `std::promise` / `std::future` | çº¿ç¨‹é—´çš„ä¿¡å·æœºåˆ¶                         |
| `executor`                     | ROS 2 å›è°ƒè°ƒåº¦å™¨                      |
| `spin_until_future_complete()` | ä¸€ç›´ spinï¼Œç›´åˆ°æŒ‡å®šçš„ future å®Œæˆ          |
| å¼‚æ­¥ spin çš„å¥½å¤„                    | ä¸»çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥è‡ªç”±æ‰§è¡Œé€»è¾‘                |
| åœæ­¢æ–¹æ³•                           | `stop_async_spinner.set_value()` |

---

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ªå®Œæ•´çš„ã€Œå¼‚æ­¥ spin + æœåŠ¡è°ƒç”¨ + ä¼˜é›…é€€å‡ºã€çš„å¯è°ƒè¯•ç¤ºä¾‹ï¼Ÿ
å¯ä»¥ç›´æ¥æ”¾è¿›ä½ çš„ VSCode ç¯å¢ƒé‡Œè°ƒè¯•ã€‚

