好的，我们来系统讲 **旋转矩阵的离散化（离散时间积分）推导**，这是 IMU 预积分、VIO/LIO-SAM 中非常重要的一步。
我会从连续时间公式出发，推导出离散更新形式，并解释其中的指数映射、skew矩阵和小角近似。

---

# 1️⃣ 连续时间旋转矩阵微分方程

假设旋转矩阵 (R(t)\in SO(3)) 将机体坐标系 B 转换到世界坐标系 W，连续时间动力学方程为：

[
$$\dot R(t) = R(t) [\omega_B(t)]_\times$$
]

* $(\omega_B(t))$ 是机体坐标系下的角速度（IMU 测量减去偏置后的值）
* $([\cdot]_\times)$ 表示反对称矩阵，叉乘的矩阵形式

这是我们要离散化的起点。

---

# 2️⃣ 离散化目标

给定采样时间$ (\Delta t)$，我们希望求得：

[
$$R_{k+1} \approx R_k \cdot ?$$
]

其中 $(R_k = R(t_k)) ,(R_{k+1} = R(t_k + \Delta t)$)。

---

# 3️⃣ 利用矩阵指数映射（精确离散化）

连续微分方程 $(\dot R = R[\omega_B]_\times)$ 的解析解为：

[
$$R(t+\Delta t) = R(t) \exp\big([\theta]_\times\big)$$
]

其中

[
$$\theta = \int_{t}^{t+\Delta t} \omega_B(\tau)  d\tau$$
]

* $(\theta \in \mathbb{R}^3) $ 表示这段时间的总旋转向量（绕某轴旋转的角度和方向）
* $(\exp([\theta]_\times))$ 是旋转矩阵指数映射（Rodrigues 公式）

---

# 4️⃣ Rodrigues 公式（计算 $(\exp([\theta]_\times))$）

如果 $(|\theta|\neq 0)$：

[
$\exp([\theta]\times) = I + \frac{\sin|\theta|}{|\theta|} [\theta]\times + \frac{1-\cos|\theta|}{|\theta|^2} [\theta]_\times^2$
]

* 这是矩阵指数的闭式解
* 当 $(|\theta|\to 0)$ 时，可用一阶近似：

[
$$\exp([\theta]\times) \approx I + [\theta]\times$$
]

---

# 5️⃣ 小角近似（IMU 高频率常用）

如果 IMU 频率很高（$(\Delta t)$ 很小），则角度变化 $(\theta = \omega_B \Delta t)$ 很小：

[
$$R_{k+1} \approx R_k \cdot (I + [\omega_B \Delta t]_\times)$$
]

这种形式简单、效率高，但累积误差比指数映射大。

---

# 6️⃣ 离散化总结

* **精确公式（指数映射）**：

[
$$\boxed{R_{k+1} = R_k \exp([\theta]_ \times), \quad \theta = \int_{t_k}^{t_{k+1}} \omega_B(\tau)d\tau}$$
]

* **小角近似（高频 IMU）**：

[
$$\boxed{R_{k+1} \approx R_k \big(I + [\omega_B \Delta t]_\times \big)}$$
]

* $(\exp([\theta]_\times)) $ 可以用 Rodrigues 公式计算。

---

# 7️⃣ 离散化与四元数的对应

* 对应四元数离散化：

[
$$q_{k+1} = q_k \otimes \delta q, \quad \delta q = \begin{bmatrix}\cos(|\theta|/2)\ (\theta/|\theta|) \sin(|\theta|/2) \end{bmatrix}$$
]

* 四元数与旋转矩阵离散化结果严格等价，数值上四元数更适合避免奇点。

---

# 8️⃣ IMU 离散积分的实现步骤

1. 读陀螺测量 $(\tilde \omega)$ 并减去偏置：$(\omega_B = \tilde \omega - b_g)$
2. 计算小时间步角度增量：$(\theta = \omega_B \Delta t)$
3. 使用 Rodrigues 公式或小角近似得到 $(\Delta R = \exp([\theta]_\times))$
4. 更新旋转矩阵：$(R_{k+1} = R_k \Delta R)$
5. 若使用四元数，将 $(\theta)$ 转为 $(\delta q)$ 并右乘更新

---

如果你愿意，我可以帮你画一张 **连续时间旋转到离散时间更新的几何示意图**，让你直观看到$ (\dot R = R[\omega]*\times \to R*{k+1} = R_k \exp([\theta]_\times)) $ 的过程。

你想看这个图吗？
