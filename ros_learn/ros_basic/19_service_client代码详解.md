éå¸¸å¥½çš„é—®é¢˜ ğŸ‘
ä½ ç»™çš„è¿™æ®µä»£ç æ˜¯ä¸€ä¸ª **ROS 2 C++ æœåŠ¡ç«¯ï¼ˆService Serverï¼‰ç¤ºä¾‹**ï¼ŒåŠŸèƒ½æ˜¯å®ç°ä¸€ä¸ª `add_two_ints` æœåŠ¡ï¼š
å®¢æˆ·ç«¯å‘æ¥ä¸¤ä¸ªæ•´æ•° `a` å’Œ `b`ï¼ŒæœåŠ¡ç«¯è¿”å›å®ƒä»¬çš„å’Œã€‚

---

## ğŸŒŸ æˆ‘ä»¬å…ˆæ•´ä½“è¿‡ä¸€éé€»è¾‘ï¼Œå†é‡ç‚¹è®² `handle_service`ã€‚

### ğŸ§© æ•´ä½“ç»“æ„

```cpp
#include <cinttypes>  // å®‰å…¨æ‰“å°æ•´æ•°
#include <memory>     // std::shared_ptr

#include "example_interfaces/srv/add_two_ints.hpp"  // æœåŠ¡æ¶ˆæ¯ç±»å‹å®šä¹‰
#include "rclcpp/rclcpp.hpp"  // ROS2æ ¸å¿ƒAPI

using AddTwoInts = example_interfaces::srv::AddTwoInts;  // ç±»å‹åˆ«å
rclcpp::Node::SharedPtr g_node = nullptr;  // å…¨å±€NodeæŒ‡é’ˆ
```

è¿™é‡Œ `example_interfaces/srv/add_two_ints.hpp` å®šä¹‰äº†æœåŠ¡æ¥å£ç»“æ„ä½“ï¼š

```cpp
struct AddTwoInts
{
  struct Request { int64_t a; int64_t b; };
  struct Response { int64_t sum; };
};
```

---

## ğŸ§  é‡ç‚¹ï¼š`handle_service` çš„å®šä¹‰ä¸åŸç†

### å‡½æ•°å£°æ˜

```cpp
void handle_service(
  const std::shared_ptr<rmw_request_id_t> request_header,
  const std::shared_ptr<AddTwoInts::Request> request,
  const std::shared_ptr<AddTwoInts::Response> response)
```

è¿™æ˜¯ ROS 2 è§„å®šçš„ **æœåŠ¡å›è°ƒå‡½æ•°ç­¾åï¼ˆservice callback signatureï¼‰**ã€‚
å½“å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚æ—¶ï¼Œ`rclcpp` ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¼ å…¥ 3 ä¸ªå‚æ•°ã€‚

---

### ğŸ§© å‚æ•°è¯¦è§£

| å‚æ•°               | ç±»å‹                                      | å«ä¹‰                      | æ˜¯å¦å¿…é¡»ä½¿ç”¨ |
| ---------------- | --------------------------------------- | ----------------------- | ------ |
| `request_header` | `std::shared_ptr<rmw_request_id_t>`     | è¯·æ±‚çš„å…ƒä¿¡æ¯ï¼ˆå®¢æˆ·ç«¯IDã€åºå·ç­‰åº•å±‚é€šä¿¡ä¿¡æ¯ï¼‰ | ä¸€èˆ¬ä¸ç”¨   |
| `request`        | `std::shared_ptr<AddTwoInts::Request>`  | å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®ï¼ˆå«å­—æ®µ aã€bï¼‰       | å¿…ç”¨     |
| `response`       | `std::shared_ptr<AddTwoInts::Response>` | æœåŠ¡ç«¯è¿”å›çš„å“åº”æ•°æ®ï¼ˆè¦å¡« sumï¼‰      | å¿…ç”¨     |

---

### ğŸ§© å‡½æ•°ä½“è®²è§£

```cpp
(void)request_header;
```

è¿™è¡Œä»£ç æ˜¯ **æŠ‘åˆ¶æœªä½¿ç”¨å˜é‡è­¦å‘Š**ã€‚
å› ä¸ºæˆ‘ä»¬æ²¡ç”¨åˆ° `request_header`ï¼Œæ‰€ä»¥æ˜¾å¼åœ°å‘Šè¯‰ç¼–è¯‘å™¨â€œæˆ‘çŸ¥é“æ²¡ç”¨å®ƒï¼Œè¯·ä¸è¦è­¦å‘Šâ€ã€‚

---

```cpp
RCLCPP_INFO(
  g_node->get_logger(),
  "request: %" PRId64 " + %" PRId64, request->a, request->b);
```

* `RCLCPP_INFO()` æ˜¯ ROS 2 çš„æ—¥å¿—å®ï¼Œç”¨äºæ‰“å°æ—¥å¿—ã€‚
* è¿™é‡Œç”¨åˆ° `<cinttypes>` çš„ `PRId64` å®ï¼Œæ˜¯å› ä¸º `request->a` å’Œ `b` æ˜¯ `int64_t` ç±»å‹ã€‚

  * `%` `PRId64` å±•å¼€åç­‰ä»·äº `%ld` æˆ– `%lld`ï¼Œå–å†³äºå¹³å°ã€‚
  * è¿™æ˜¯è·¨å¹³å°æ‰“å° 64 ä½æ•´æ•°çš„æ­£ç¡®å†™æ³•ã€‚

---

```cpp
response->sum = request->a + request->b;
```

è¿™æ˜¯æœåŠ¡ç«¯çš„æ ¸å¿ƒé€»è¾‘ï¼š
è®¡ç®—ä¸¤ä¸ªè¾“å…¥æ•´æ•°çš„å’Œï¼Œå¹¶å¡«å…¥å“åº”ç»“æ„ä½“ `response`ã€‚
ä¸€æ—¦å›è°ƒå‡½æ•°è¿”å›ï¼ŒROS 2 æ¡†æ¶ä¼šè‡ªåŠ¨æŠŠ `response` å‘é€ç»™å®¢æˆ·ç«¯ã€‚

---

### ğŸ§© ä¸ºä»€ä¹ˆå‚æ•°å‰é¢åŠ äº† `const`ï¼Ÿ

#### 1ï¸âƒ£ å¯¹äº `std::shared_ptr<T>` è€Œè¨€

* `const std::shared_ptr<T>` è¡¨ç¤ºï¼š
  â€œ**è¿™æŒ‡é’ˆæœ¬èº«ä¸å¯ä¿®æ”¹ï¼ˆä¸èƒ½é‡æ–°æŒ‡å‘åˆ«çš„å¯¹è±¡ï¼‰**ï¼Œä½†å®ƒæŒ‡å‘çš„å¯¹è±¡æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚â€

  ä¸¾ä¾‹ï¼š

  ```cpp
  const std::shared_ptr<int> p = std::make_shared<int>(5);
  *p = 10;       // âœ… OKï¼Œä¿®æ”¹å†…éƒ¨å€¼
  p = nullptr;   // âŒ ä¸è¡Œï¼ŒæŒ‡é’ˆæœ¬èº«æ˜¯ const
  ```

#### 2ï¸âƒ£ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

* ROS 2 æ¡†æ¶ **è´Ÿè´£åˆ†é…å¹¶ç®¡ç†è¿™äº› shared_ptr çš„ç”Ÿå‘½å‘¨æœŸ**ï¼›
* å›è°ƒå‡½æ•°åªåº”è¯¥ **è¯»å–è¯·æ±‚ï¼ˆrequestï¼‰**ã€**å†™å…¥å“åº”ï¼ˆresponseï¼‰**ï¼›
* æˆ‘ä»¬ **ä¸åº”è¯¥æ”¹å˜æŒ‡é’ˆæœ¬èº«çš„æŒ‡å‘**ã€‚

æ‰€ä»¥è¿™æ ·å†™æ˜¯ä¸€ä¸ªå®‰å…¨çš„çº¦å®šï¼š

```cpp
const std::shared_ptr<AddTwoInts::Request> request,
const std::shared_ptr<AddTwoInts::Response> response
```

è¡¨ç¤ºä½ ä¸ä¼šè®©è¿™äº›æŒ‡é’ˆå†æŒ‡å‘åˆ«çš„å¯¹è±¡ï¼ˆä½†å¯ä»¥è®¿é—®æˆ–å†™å…¥å†…å®¹ï¼‰ã€‚

---

### ğŸ§© ä¸ºä»€ä¹ˆä¸ç”¨å¼•ç”¨ `&`ï¼Ÿ

å› ä¸ºè¿™äº›å‚æ•°çš„æ‰€æœ‰æƒç”± ROS æ¡†æ¶ç®¡ç†ï¼Œå®ƒå¯èƒ½æ¥è‡ªå¼‚æ­¥çº¿ç¨‹ã€å†…éƒ¨å¯¹è±¡æ± ç­‰ã€‚
å¦‚æœç›´æ¥ç”¨å¼•ç”¨ä¼ é€’ï¼ˆä¾‹å¦‚ `AddTwoInts::Request&`ï¼‰ï¼Œä¼šæ¶‰åŠç”Ÿå‘½å‘¨æœŸç®¡ç†é£é™©ã€‚

è€Œç”¨ `std::shared_ptr` å¯ä»¥å®‰å…¨åœ°å…±äº«åº•å±‚å¯¹è±¡ã€è‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼Œä¸ä¼šæ‚¬ç©ºã€‚

**æ€»ç»“ä¸€ä¸‹åŒºåˆ«ï¼š**

| æ–¹å¼                     | ç‰¹ç‚¹           | æ˜¯å¦é€‚åˆå›è°ƒå‡½æ•°  |
| ---------------------- | ------------ | --------- |
| ä¼ å€¼                     | æ‹·è´ä¸€ä»½å¯¹è±¡       | âŒ å¤ªæ…¢ï¼Œæµªè´¹å†…å­˜ |
| å¼•ç”¨ `&`                 | æ— æ‹·è´ï¼Œä½†ç”Ÿå‘½å‘¨æœŸä¸ç¡®å®š | âš ï¸ å®¹æ˜“æ‚¬ç©º   |
| æ™ºèƒ½æŒ‡é’ˆ `std::shared_ptr` | å®‰å…¨å…±äº«æ‰€æœ‰æƒ      | âœ… æ¨è      |

---

### ğŸ§© æ•´ä¸ªå›è°ƒæµç¨‹æ€»ç»“

1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚ `{a, b}`ï¼›
2. ROS 2 æ¡†æ¶æ”¶åˆ°è¯·æ±‚ â†’ è°ƒç”¨ `handle_service()`ï¼›
3. ä½ çš„ä»£ç è®¡ç®—ç»“æœ â†’ å¡«å…¥ `response->sum`ï¼›
4. å‡½æ•°è¿”å› â†’ æ¡†æ¶è‡ªåŠ¨å‘é€å“åº”ï¼›
5. ç”Ÿå‘½å‘¨æœŸç»“æŸåï¼Œ`shared_ptr` è‡ªåŠ¨é‡Šæ”¾ã€‚

---

## âœ… æ€»ç»“ä¸€å¥è¯

`handle_service()` æ˜¯æœåŠ¡ç«¯å›è°ƒå‡½æ•°ï¼š

* ROS2 è‡ªåŠ¨ä¼ å…¥è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼›
* ä½ åªéœ€è¯»å–è¯·æ±‚ã€å†™å…¥å“åº”ï¼›
* `const std::shared_ptr` ç¡®ä¿å®‰å…¨å…±äº«ï¼Œä¸ä¼šä¹±æ”¹æŒ‡é’ˆï¼›
* `PRId64` ç¡®ä¿è·¨å¹³å°æ‰“å° 64 ä½æ•´æ•°ï¼›
* æ¡†æ¶è´Ÿè´£é€šä¿¡ä¸å†…å­˜ç®¡ç†ã€‚

---

å¦‚æœä½ æƒ³æ›´æ·±å…¥ç†è§£ï¼Œå¯ä»¥è®©æˆ‘ç»™ä½ ç”»ä¸€å¼ å›¾ï¼Œå±•ç¤ºï¼š
ğŸ“Š â€œå®¢æˆ·ç«¯å‘é€ â†’ ROS2ä¸­é—´å±‚ä¼ é€’ â†’ æœåŠ¡ç«¯å›è°ƒæ‰§è¡Œ â†’ å“åº”è¿”å›â€çš„å®Œæ•´è°ƒç”¨æµç¨‹å›¾ã€‚
è¦æˆ‘å¸®ä½ ç”»é‚£å¼ å›¾å—ï¼Ÿ

---

# client ä»£ç è®²è§£

éå¸¸æ£’çš„é—®é¢˜ ğŸ‘ï¼Œä½ è¿™æ¬¡æçš„ç‚¹å…¶å®æ­£å¥½è§¦åŠäº† **ROS 2 Client çš„æ ¸å¿ƒæœºåˆ¶**â€”â€”ä¹Ÿå°±æ˜¯â€œå¼‚æ­¥è¯·æ±‚ + äº‹ä»¶å¾ªç¯ï¼ˆspinï¼‰â€çš„åº•å±‚é€»è¾‘ã€‚
æˆ‘ä»¬æ¥ä¸€ç‚¹ç‚¹æ‹†è§£è¿™æ®µä»£ç ï¼Œå°¤å…¶æ˜¯ä½ æåˆ°çš„ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼š
`rclcpp::ok()` å’Œ `rclcpp::spin_until_future_complete(node, result_future)`ã€‚

---

## ğŸ§© æ•´ä½“é€»è¾‘å…ˆçœ‹ä¸€çœ¼

è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ª ROS 2 æœåŠ¡ **å®¢æˆ·ç«¯ (Service Client)**ã€‚
å®ƒçš„å·¥ä½œæµç¨‹ï¼š

1. åˆ›å»ºèŠ‚ç‚¹ï¼›
2. è¿æ¥æœåŠ¡ç«¯ï¼›
3. æ„é€ è¯·æ±‚ï¼›
4. å¼‚æ­¥å‘é€ï¼›
5. ç­‰å¾…å“åº”ï¼›
6. æ‰“å°ç»“æœï¼›
7. å…³é—­ ROSã€‚

---

## ä¸€ã€å…ˆè®² `rclcpp::ok()`

### ğŸ§  å®šä¹‰

```cpp
bool rclcpp::ok();
```

å®ƒçš„ä½œç”¨æ˜¯ï¼š

> æ£€æŸ¥å½“å‰ ROS è¿è¡Œç¯å¢ƒæ˜¯å¦è¿˜â€œæ­£å¸¸â€è¿è¡Œä¸­ã€‚

---

### âœ… ä»€ä¹ˆæ—¶å€™è¿”å› falseï¼Ÿ

`rclcpp::ok()` ä¼šåœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µè¿”å› `false`ï¼š

| æƒ…å†µ                       | æ„ä¹‰             |
| ------------------------ | -------------- |
| è°ƒç”¨äº† `rclcpp::shutdown()` | ROS æ­£åœ¨å…³é—­       |
| ç¨‹åºæ”¶åˆ° `Ctrl+C` ä¿¡å·ï¼ˆSIGINTï¼‰ | ç”¨æˆ·ä¸­æ–­ç¨‹åº         |
| å†…éƒ¨é€šä¿¡å±‚å‡ºç°ä¸¥é‡é”™è¯¯              | ROS runtime å´©æºƒ |
| èŠ‚ç‚¹å·²è¢«é”€æ¯                   | æ— æ•ˆèŠ‚ç‚¹           |

---

### ğŸ§© ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥è°ƒç”¨ï¼Ÿ

`rclcpp::ok()` æ˜¯ä¸€ä¸ª **å…¨å±€å‡½æ•°**ï¼ˆä¸æ˜¯èŠ‚ç‚¹æˆå‘˜å‡½æ•°ï¼‰ã€‚
å®ƒæŸ¥è¯¢çš„æ˜¯ **æ•´ä¸ª ROS2 ç³»ç»Ÿçš„çŠ¶æ€**ï¼ˆå…¨å±€ä¸Šä¸‹æ–‡ `rclcpp::Context`ï¼‰ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå“ªæ€•ä½ æ²¡æœ‰èŠ‚ç‚¹å¯¹è±¡ï¼Œä¹Ÿèƒ½é—®ç³»ç»Ÿä¸€å¥ï¼šâ€œROS è¿˜æ´»ç€å—ï¼Ÿâ€

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½ å¯ä»¥ç›´æ¥å†™ï¼š

```cpp
if (!rclcpp::ok()) {
  RCLCPP_ERROR(...);
}
```

è€Œä¸ç”¨å†™ `node->ok()`ã€‚

---

### ğŸ§  åœ¨è¿™æ®µä»£ç é‡Œçš„ç”¨é€”

```cpp
while (!client->wait_for_service(std::chrono::seconds(1))) {
  if (!rclcpp::ok()) {
    RCLCPP_ERROR(node->get_logger(), "client interrupted while waiting for service to appear.");
    return 1;
  }
  RCLCPP_INFO(node->get_logger(), "waiting for service to appear...");
}
```

è¿™ä¸ªå¾ªç¯æ¯ç§’æ£€æµ‹ä¸€æ¬¡æœåŠ¡æ˜¯å¦å‡ºç°ã€‚
å¦‚æœ ROS è¢«ä¸­æ–­ï¼ˆä¾‹å¦‚ç”¨æˆ· `Ctrl+C`ï¼‰ï¼Œ`rclcpp::ok()` å˜æˆ falseï¼Œå®¢æˆ·ç«¯å°±ä¸»åŠ¨é€€å‡ºã€‚
ğŸ‘‰ é˜²æ­¢ç¨‹åºæ­»ç­‰ã€‚

---

## äºŒã€é‡ç‚¹è®² `rclcpp::spin_until_future_complete(node, result_future)`

è¿™æ˜¯ ROS 2 **å¼‚æ­¥å®¢æˆ·ç«¯ç­‰å¾…æœåŠ¡å“åº”**çš„æ ¸å¿ƒå‡½æ•°ã€‚

---

### ğŸ§  å‡½æ•°åŸå‹

```cpp
template<typename NodeT, typename FutureT>
FutureReturnCode spin_until_future_complete(
  std::shared_ptr<NodeT> node,
  FutureT & future,
  std::chrono::duration... timeout = ...)
```

---

### ğŸ” ä½œç”¨

å®ƒçš„ä½œç”¨æ˜¯ï¼š

> å¯åŠ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆspinï¼‰ï¼Œè®©èŠ‚ç‚¹ç»§ç»­æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯ï¼ˆåŒ…æ‹¬æœåŠ¡å“åº”ï¼‰ï¼Œç›´åˆ°ï¼š
>
> * `future` å®Œæˆï¼ˆæœåŠ¡å“åº”è¿”å›ï¼‰ï¼Œæˆ–
> * è¶…æ—¶ï¼Œæˆ–
> * ROS è¢«ä¸­æ–­ï¼ˆshutdownï¼‰ã€‚

---

### ğŸ§© ä¸ºä»€ä¹ˆè¦ä¼ ä¸€ä¸ª `node` è¿›å»ï¼Ÿ

è¿™ç‚¹å¾ˆå…³é”®ã€‚
`spin_until_future_complete` å¿…é¡»çŸ¥é“â€œå“ªä¸ªèŠ‚ç‚¹â€æ­£åœ¨ç›‘å¬äº‹ä»¶å¾ªç¯ã€‚

å› ä¸ºï¼š

* **èŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤é€šä¿¡å¯¹è±¡**ï¼ˆåŒ…æ‹¬è®¢é˜…ã€æœåŠ¡ã€å®¢æˆ·ç«¯ç­‰ï¼‰ï¼›
* **spin** çš„æœ¬è´¨å°±æ˜¯ä¸æ–­è°ƒç”¨ï¼š

  ```cpp
  node->wait_for_work();
  node->execute_callbacks();
  ```

  ä¹Ÿå°±æ˜¯â€œè½®è¯¢èŠ‚ç‚¹çš„äº‹ä»¶é˜Ÿåˆ—â€ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ï¼š

  * æ–°æ¶ˆæ¯ï¼ˆtopicï¼‰
  * æœåŠ¡å“åº”ï¼ˆserviceï¼‰
  * å®šæ—¶å™¨è§¦å‘ï¼ˆtimerï¼‰

ğŸ‘‰ æ‰€ä»¥è¦å‘Šè¯‰å®ƒè¦ spin å“ªä¸ªèŠ‚ç‚¹ã€‚

---

### âš™ï¸ å¦‚æœä¸ä¼  nodeï¼Œä¼šæ€æ ·ï¼Ÿ

`rclcpp` æ— æ³•çŸ¥é“ä»å“ªä¸ª executorï¼ˆæ‰§è¡Œå™¨ï¼‰å–äº‹ä»¶ã€‚
é‚£ä½ çš„ `future` æ°¸è¿œä¸ä¼šè¢«è§¦å‘å®Œæˆã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼š

```cpp
auto result_future = client->async_send_request(request);
```

è¿™ä¸ªè¯·æ±‚è™½ç„¶å‘å‡ºå»äº†ï¼Œ
ä½†å“åº”åˆ°äº†ä½ è¿™è¾¹æ—¶ï¼Œå¦‚æœæ²¡äºº `spin()`ï¼Œå°±æ²¡äººæ¥æ”¶ã€‚

äºæ˜¯ `result_future` æ°¸è¿œå¡ç€ä¸å˜ã€‚

---

### ğŸ§© spin_until_future_complete çš„åº•å±‚æœºåˆ¶ç®€åŒ–

å¯ä»¥æƒ³è±¡å®ƒå†…éƒ¨åšäº†ç±»ä¼¼è¿™æ ·çš„äº‹ï¼š

```cpp
while (rclcpp::ok()) {
  if (future.is_ready()) {
    return rclcpp::FutureReturnCode::SUCCESS;
  }
  rclcpp::spin_some(node);  // å¤„ç†äº‹ä»¶
  std::this_thread::sleep_for(1ms);
}
return rclcpp::FutureReturnCode::INTERRUPTED;
```

æ‰€ä»¥ï¼š

* å®ƒæ˜¯ **é˜»å¡å¼ç­‰å¾…**ï¼›
* ä½†å†…éƒ¨ä»ç„¶ä¿æŒ ROS çš„äº‹ä»¶å¾ªç¯ï¼›
* ç›´åˆ° future å˜ä¸º readyï¼ˆå³æœåŠ¡å“åº”å›æ¥äº†ï¼‰ã€‚

---

## ä¸‰ã€ä¸¤è€…å…³ç³»æ€»ç»“

| å‡½æ•°                                                 | ä½œç”¨                | ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡               |
| -------------------------------------------------- | ----------------- | --------------------- |
| `rclcpp::ok()`                                     | æ£€æŸ¥ ROS æ˜¯å¦ä»åœ¨è¿è¡Œ     | å…¨å±€çŠ¶æ€æ£€æŸ¥ï¼Œä¸ä¾èµ–èŠ‚ç‚¹          |
| `rclcpp::spin_until_future_complete(node, future)` | è®©èŠ‚ç‚¹è¿è¡Œäº‹ä»¶å¾ªç¯ç›´åˆ°æœåŠ¡å“åº”åˆ°è¾¾ | å®¢æˆ·ç«¯è¯·æ±‚æ˜¯å¼‚æ­¥çš„ï¼Œå¿…é¡»é äº‹ä»¶å¾ªç¯å¤„ç†å“åº” |

---

## ğŸ§© æ•´ä¸ªé€»è¾‘ä¸²èµ·æ¥çœ‹

```cpp
while (!client->wait_for_service(...)) {
  if (!rclcpp::ok()) return;  // ROS å·²ä¸­æ–­ -> æå‰é€€å‡º
}

auto result_future = client->async_send_request(request);

// ç­‰å¾…ç»“æœè¿”å›
if (rclcpp::spin_until_future_complete(node, result_future)
    != rclcpp::FutureReturnCode::SUCCESS)
{
  RCLCPP_ERROR(...);
  return 1;
}

auto result = result_future.get();
RCLCPP_INFO(node->get_logger(), "sum = %d", result->sum);
```

æµç¨‹å›¾ç†è§£ï¼š

```
client.send_request() â†’ (ROSä¸­é—´å±‚å¼‚æ­¥å‘é€)
             â†“
spin_until_future_complete(node, future)
             â†“
[æ‰§è¡Œäº‹ä»¶å¾ªç¯ï¼Œç›´åˆ° future å®Œæˆ]
             â†“
result_future.get()  // è¿”å›å“åº”ç»“æœ
```

---

## âœ… æ€»ç»“ä¸€å¥è¯

* `rclcpp::ok()` æ£€æŸ¥ ROS ç³»ç»Ÿæ˜¯å¦è¿˜åœ¨è¿è¡Œï¼›
* `rclcpp::spin_until_future_complete(node, future)` å¯åŠ¨äº‹ä»¶å¾ªç¯ï¼Œè®©èŠ‚ç‚¹èƒ½æ¥æ”¶æœåŠ¡å“åº”ï¼›
* å¿…é¡»ä¼ å…¥ `node`ï¼Œå› ä¸ºäº‹ä»¶å¾ªç¯æ˜¯èŠ‚ç‚¹çº§çš„ï¼›
* è¿™æ˜¯ ROS 2 å¼‚æ­¥é€šä¿¡çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ã€‚

---

å¦‚æœä½ æƒ³æ›´é€å½»åœ°ç†è§£è¿™ä¸€æ®µï¼Œæˆ‘å¯ä»¥ç”»ä¸€å¼  **â€œROS2 å®¢æˆ·ç«¯å¼‚æ­¥è°ƒç”¨æµç¨‹å›¾â€**ï¼Œå±•ç¤ºä» `async_send_request()` åˆ° `spin_until_future_complete()` æ•´ä¸ªè°ƒç”¨é“¾ï¼ˆå«äº‹ä»¶å¾ªç¯å’Œ future çŠ¶æ€å˜åŒ–ï¼‰ã€‚
è¦æˆ‘å¸®ä½ ç”»é‚£å¼ å›¾å—ï¼Ÿ

---
---