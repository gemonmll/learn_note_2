éå¸¸å¥½ ğŸ‘ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒã€ä½†å¾ˆå¤šåˆå­¦è€…å®¹æ˜“æ··æ·†çš„é—®é¢˜ã€‚
åœ¨ **ROS 2** ä¸­ï¼Œ**Serviceï¼ˆæœåŠ¡ï¼‰é€šä¿¡** çš„â€œåŒæ­¥ / å¼‚æ­¥â€è¡Œä¸ºï¼Œå–å†³äº**ä½ åœ¨å®¢æˆ·ç«¯æ€ä¹ˆè°ƒç”¨å®ƒ**ã€‚
æˆ‘ä»¬æ¥ç³»ç»Ÿè®²ä¸€ä¸‹ ğŸ‘‡

---

## ğŸ§© ä¸€ã€Service åœ¨ ROS 2 ä¸­çš„åŸºæœ¬ç»“æ„

ä¸€ä¸ª ROS 2 **Serviceï¼ˆæœåŠ¡ï¼‰**ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

| è§’è‰²  | åç§°                | ä½œç”¨                |
| --- | ----------------- | ----------------- |
| æœåŠ¡ç«¯ | `rclcpp::Service` | ç­‰å¾…è¯·æ±‚ï¼Œæ”¶åˆ°è¯·æ±‚åå¤„ç†å¹¶è¿”å›å“åº” |
| å®¢æˆ·ç«¯ | `rclcpp::Client`  | å‘é€è¯·æ±‚ï¼Œå¹¶ç­‰å¾…æœåŠ¡ç«¯çš„å“åº”    |

æ¶ˆæ¯ç±»å‹æ˜¯ `.srv` æ–‡ä»¶å®šä¹‰çš„ï¼ŒåŒ…å«ï¼š

```srv
# Example AddTwoInts.srv
int64 a
int64 b
---
int64 sum
```

---

## âš™ï¸ äºŒã€å®¢æˆ·ç«¯çš„ä¸¤ç§è°ƒç”¨æ–¹å¼

### âœ… 1. **åŒæ­¥è°ƒç”¨**ï¼ˆblocking callï¼‰

å®¢æˆ·ç«¯å‘é€è¯·æ±‚åï¼Œä¼š **é˜»å¡ç­‰å¾…å“åº”**ã€‚
è¿™æ˜¯æœ€ç›´è§‚çš„æ–¹å¼ã€‚

```cpp
auto client = node->create_client<example_interfaces::srv::AddTwoInts>("add_two_ints");

auto request = std::make_shared<example_interfaces::srv::AddTwoInts::Request>();
request->a = 2;
request->b = 3;

// ç­‰å¾…æœåŠ¡ç«¯å¯ç”¨
while (!client->wait_for_service(std::chrono::seconds(1))) {
  RCLCPP_INFO(node->get_logger(), "Waiting for service...");
}

// åŒæ­¥è°ƒç”¨ï¼Œç›´åˆ°æ”¶åˆ°å“åº”æ‰è¿”å›
auto result = client->call(request);  

RCLCPP_INFO(node->get_logger(), "Sum = %ld", result->sum);
```

ğŸ”¹ ç‰¹ç‚¹ï¼š

| é¡¹ç›®   | æè¿°                       |
| ---- | ------------------------ |
| æ‰§è¡Œæ–¹å¼ | åŒæ­¥ã€é˜»å¡                    |
| ä¼˜ç‚¹   | ç®€å•ã€é€»è¾‘ç›´è§‚                  |
| ç¼ºç‚¹   | é˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ— æ³•åŒæ—¶å¤„ç†å…¶ä»–å›è°ƒï¼ˆå¦‚è®¢é˜…æ¶ˆæ¯ï¼‰ |

---

### âš™ï¸ 2. **å¼‚æ­¥è°ƒç”¨**ï¼ˆnon-blocking, future-basedï¼‰

ROS 2 çš„æ¨èæ–¹å¼ã€‚
å®ƒä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œæ˜¯ç«‹å³è¿”å›ä¸€ä¸ª `std::shared_future` å¯¹è±¡ã€‚

```cpp
auto client = node->create_client<example_interfaces::srv::AddTwoInts>("add_two_ints");

auto request = std::make_shared<example_interfaces::srv::AddTwoInts::Request>();
request->a = 10;
request->b = 20;

auto future = client->async_send_request(request);

// ç­‰å¾…å“åº”ï¼ˆéé˜»å¡ç‰ˆæœ¬ï¼šä½ å¯ä»¥ç”¨ spin æˆ– spin_until_future_completeï¼‰
if (rclcpp::spin_until_future_complete(node, future) == 
    rclcpp::FutureReturnCode::SUCCESS)
{
  auto response = future.get();
  RCLCPP_INFO(node->get_logger(), "Sum = %ld", response->sum);
}
```

ğŸ”¹ ç‰¹ç‚¹ï¼š

| é¡¹ç›®   | æè¿°                                 |
| ---- | ---------------------------------- |
| æ‰§è¡Œæ–¹å¼ | å¼‚æ­¥                                 |
| å“åº”æœºåˆ¶ | è¿”å› `std::shared_future<ResponseT>` |
| ä¼˜ç‚¹   | ä¸é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¯å¹¶è¡Œæ‰§è¡Œå…¶ä»–ä»»åŠ¡                  |
| ç¼ºç‚¹   | å†™æ³•ç¨å¤æ‚ï¼Œéœ€è¦ä½¿ç”¨ future æˆ–å›è°ƒå¤„ç†ç»“æœ          |

---

## ğŸ§  ä¸‰ã€æœåŠ¡è°ƒç”¨è¿‡ç¨‹ï¼ˆåº•å±‚æœºåˆ¶ï¼‰

ä¸ç®¡åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œåº•å±‚éƒ½æ˜¯ï¼š

1. å®¢æˆ·ç«¯å°è£…è¯·æ±‚ â†’ å‘å¸ƒåˆ°è¯·æ±‚ä¸»é¢˜ `/service_name/_request`
2. æœåŠ¡ç«¯è®¢é˜…è¯¥è¯·æ±‚ä¸»é¢˜ â†’ æ‰§è¡Œå›è°ƒ â†’ å‘å¸ƒå“åº”åˆ° `/service_name/_response`
3. å®¢æˆ·ç«¯è®¢é˜… `_response` â†’ åŒ¹é…å¯¹åº”è¯·æ±‚ â†’ å®Œæˆ future

`rclcpp::spin()` ä¼šåœ¨å†…éƒ¨å¾ªç¯å¤„ç†è¿™äº›äº‹ä»¶ï¼ˆè®¡æ—¶å™¨ã€è®¢é˜…ã€æœåŠ¡å“åº”ç­‰ï¼‰ã€‚

---

## ğŸ§© å››ã€æ€»ç»“å¯¹æ¯”

| ç‰¹æ€§     | åŒæ­¥è°ƒç”¨ (`call()`)     | å¼‚æ­¥è°ƒç”¨ (`async_send_request()`)     |
| ------ | ------------------- | --------------------------------- |
| æ˜¯å¦é˜»å¡çº¿ç¨‹ | âœ… æ˜¯                 | âŒ å¦                               |
| è°ƒç”¨ç»“æœ   | ç›´æ¥è¿”å›ç»“æœ              | è¿”å› `future`                       |
| æ¨èåœºæ™¯   | ç®€å•è„šæœ¬ã€å°èŠ‚ç‚¹            | å®æ—¶ã€å¤šçº¿ç¨‹ã€å¤æ‚èŠ‚ç‚¹                       |
| ç¤ºä¾‹å‡½æ•°   | `client->call(req)` | `client->async_send_request(req)` |

---

## ğŸ’¬ ä¾‹å­å°ç»“

âœ… åŒæ­¥ï¼š

```cpp
auto result = client->call(req);  // é˜»å¡ç­‰å¾…å“åº”
```

âœ… å¼‚æ­¥ï¼š

```cpp
auto future = client->async_send_request(req);
rclcpp::spin_until_future_complete(node, future);
auto response = future.get();
```

---

æ˜¯å¦å¸Œæœ›æˆ‘æ¥ç€å¸®ä½ ç”»ä¸€å¼ å›¾ï¼Œå±•ç¤º **å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ â†’ å“åº” â†’ future å®Œæˆ** çš„å¼‚æ­¥è°ƒç”¨æ—¶åºå›¾ï¼Ÿ
é‚£å¼ å›¾èƒ½è®©ä½ ä¸€çœ¼çœ‹æ¸…åŒæ­¥å’Œå¼‚æ­¥çš„å·®åˆ«ã€‚

éå¸¸å¥½çš„é—®é¢˜ ğŸ‘ï¼Œä½ è¿™æ®µä»£ç å…¶å®æ˜¯ ROS 2 **å®¢æˆ·ç«¯ï¼ˆclientï¼‰è°ƒç”¨æœåŠ¡ï¼ˆserviceï¼‰** æ—¶çš„ä¸€ä¸ªå…¸å‹ç”¨æ³•ã€‚
æˆ‘ä»¬æ¥è¯¦ç»†æ‹†è§£è¿™å‡ è¡Œä»£ç åˆ°åº•å¹²äº†ä»€ä¹ˆã€ä»€ä¹ˆæ—¶å€™ä¼šå¤±è´¥ã€`spin` åˆ°åº•æ„å‘³ç€ä»€ä¹ˆã€‚

---

## ğŸ§© èƒŒæ™¯ï¼šæœåŠ¡è°ƒç”¨æµç¨‹

åœ¨ ROS 2 ä¸­ï¼Œä¸€ä¸ª **service client** çš„è°ƒç”¨æµç¨‹é€šå¸¸æ˜¯è¿™æ ·ï¼š

1. åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆ`client = node->create_client<srv_type>("service_name")`ï¼‰
2. å‘é€è¯·æ±‚ï¼ˆ`auto future = client->async_send_request(request)`ï¼‰
3. ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼ˆç”¨ `rclcpp::spin_until_future_complete()`ï¼‰
4. è¯»å–ç»“æœï¼ˆ`future.get()`ï¼‰

---

## ğŸ§  ä»£ç é€è¡Œè§£é‡Š

```cpp
if (rclcpp::spin_until_future_complete(node, result_future) !=
    rclcpp::FutureReturnCode::SUCCESS)
{
  RCLCPP_ERROR(node->get_logger(), "service call failed :(");
  client->remove_pending_request(result_future);
  return 1;
}
```

### âœ… `rclcpp::spin_until_future_complete(node, result_future)`

è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ï¼š

> è®©å½“å‰çº¿ç¨‹ **æŒç»­ spinï¼ˆå¾ªç¯å¤„ç† ROS äº‹ä»¶ï¼‰**ï¼Œç›´åˆ°ï¼š
>
> * æœ‰æ¶ˆæ¯æˆ–æœåŠ¡å“åº”åˆ°æ¥ï¼›
> * æˆ–è€…è¶…æ—¶ï¼›
> * æˆ–è€…ç¨‹åºä¸­æ–­ã€‚

ç®€å•ç†è§£ï¼š
ğŸ‘‰ å®ƒæ˜¯ä¸€ä¸ª**é˜»å¡ç­‰å¾…**ï¼Œåœ¨åå°ä¸åœå¤„ç†äº‹ä»¶å¾ªç¯ï¼ˆspinningï¼‰ï¼Œç›´åˆ° `result_future`ï¼ˆæœåŠ¡å“åº”çš„ futureï¼‰å®Œæˆã€‚

---

## â³ â€œspinâ€ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

åœ¨ ROS 2 ä¸­ï¼Œâ€œspinâ€ è¡¨ç¤º**å¾ªç¯æ‰§è¡ŒèŠ‚ç‚¹çš„å›è°ƒå‡½æ•°**ã€‚
ä¾‹å¦‚ï¼š

```cpp
rclcpp::spin(node);
```

è¿™ä¼šè®©èŠ‚ç‚¹ä¸æ–­æ£€æŸ¥æœ‰æ²¡æœ‰è®¢é˜…çš„æ¶ˆæ¯ã€æœåŠ¡è¯·æ±‚ã€å®šæ—¶å™¨è§¦å‘ç­‰äº‹ä»¶è¦å¤„ç†ã€‚

è€Œï¼š

```cpp
rclcpp::spin_until_future_complete(node, future)
```

æ˜¯ä¸€ä¸ªâ€œå¸¦æ¡ä»¶çš„ spinâ€ï¼š

> ä¸€ç›´ spinï¼Œç›´åˆ°è¿™ä¸ª futureï¼ˆå³æœåŠ¡çš„å“åº”ç»“æœï¼‰å˜æˆâ€œå·²å®Œæˆâ€ï¼ˆcompleteï¼‰ã€‚

æ¢å¥è¯è¯´ï¼š

* å¦‚æœæœåŠ¡ç«¯å›å¤äº† â†’ è¿”å› `SUCCESS`
* å¦‚æœè¶…æ—¶æˆ–å‡ºé”™ â†’ è¿”å›å…¶ä»–æšä¸¾å€¼

---

## âš ï¸ å®ƒå¯èƒ½è¿”å›çš„å‡ ç§ç»“æœ

`rclcpp::FutureReturnCode` æœ‰ä»¥ä¸‹å‡ ç§æšä¸¾ï¼š

```cpp
enum class FutureReturnCode
{
  SUCCESS,   // æœåŠ¡å“åº”æˆåŠŸæ”¶åˆ°
  INTERRUPTED, // spin è¢«å¤–éƒ¨ä¸­æ–­ï¼ˆä¾‹å¦‚ Ctrl+Cï¼‰
  TIMEOUT    // ç­‰å¾…è¶…æ—¶ï¼ˆå½“æœ‰è¶…æ—¶æ—¶é—´å‚æ•°æ—¶ï¼‰
};
```

---

## ğŸš¨ å¤±è´¥ï¼ˆé SUCCESSï¼‰çš„å‡ ç§å¸¸è§æƒ…å†µ

1. ### ğŸš« æœåŠ¡ç«¯æœªè¿è¡Œ

   * å®¢æˆ·ç«¯è¯·æ±‚å‘å‡ºåæ²¡æœ‰æœåŠ¡å™¨ç›‘å¬è¿™ä¸ª service åç§°ï¼›
   * è¯·æ±‚æ°¸è¿œä¸ä¼šæœ‰å“åº”ï¼›
   * `spin_until_future_complete()` ä¸€ç›´ç­‰å¾…ç›´åˆ°ä½ æ‰“æ–­æˆ–èŠ‚ç‚¹å…³é—­ï¼›
   * æœ€ç»ˆè¿”å› `INTERRUPTED` æˆ– `TIMEOUT`ã€‚

2. ### ğŸ•’ è¶…æ—¶ï¼ˆä»…å½“ä½ ä¼ äº†è¶…æ—¶å‚æ•°ï¼‰

   ä¾‹å¦‚ï¼š

   ```cpp
   rclcpp::spin_until_future_complete(node, result_future, std::chrono::seconds(3))
   ```

   å¦‚æœ 3 ç§’å†…æœåŠ¡æ²¡æœ‰å›åº”ï¼Œå°±è¿”å› `TIMEOUT`ã€‚

3. ### ğŸ”Œ èŠ‚ç‚¹è¢«ä¸­æ–­

   æ¯”å¦‚ä½ æŒ‰äº† Ctrl+C æˆ–èŠ‚ç‚¹åœ¨ç­‰å¾…æœŸé—´è¢«é”€æ¯ï¼›
   è¿”å› `INTERRUPTED`ã€‚

4. ### âŒ ç½‘ç»œé—®é¢˜ / DDS é€šä¿¡é”™è¯¯

   æ¯”å¦‚é€šä¿¡å±‚ä¸¢åŒ…ã€æœåŠ¡ç«¯ crashã€QoS ä¸åŒ¹é…ç­‰ï¼›
   ä¹Ÿå¯èƒ½å¯¼è‡´ `spin_until_future_complete` æ— æ³•æˆåŠŸå®Œæˆã€‚

---

## ğŸ’¡ å…³äºè¿™ä¸€è¡Œ

```cpp
client->remove_pending_request(result_future);
```

è¿™è¡¨ç¤ºï¼š

> æŠŠè¿™ä¸ª future ä»å®¢æˆ·ç«¯çš„â€œå¾…å¤„ç†è¯·æ±‚é˜Ÿåˆ—â€é‡Œåˆ é™¤ï¼Œé¿å…æ‚¬æŒ‚å¼•ç”¨ã€‚

è¿™é€šå¸¸åœ¨å¤±è´¥æ—¶è°ƒç”¨ï¼Œæ¸…ç†èµ„æºã€‚

---

## âœ… æ€»ç»“ä¸€ä¸‹

| æ¦‚å¿µ                             | å«ä¹‰                            |
| ------------------------------ | ----------------------------- |
| `spin`                         | ä¸åœå¾ªç¯ï¼Œå¤„ç† ROS çš„äº‹ä»¶é˜Ÿåˆ—ï¼ˆè®¢é˜…æ¶ˆæ¯ã€æœåŠ¡å“åº”ç­‰ï¼‰ |
| `spin_until_future_complete()` | ä¸€ç›´ spinï¼Œç›´åˆ°æŸä¸ªæœåŠ¡å“åº”ï¼ˆfutureï¼‰å®Œæˆ    |
| `SUCCESS`                      | æˆåŠŸæ”¶åˆ°æœåŠ¡å“åº”                      |
| `INTERRUPTED`                  | è¢«æ‰“æ–­ï¼ˆå¦‚ Ctrl+Cï¼‰                 |
| `TIMEOUT`                      | ç­‰å¾…è¶…æ—¶ï¼ˆä»…å½“æŒ‡å®šäº†è¶…æ—¶æ—¶é—´ï¼‰               |
| å¤±è´¥åŸå›                            | æœåŠ¡ç«¯æ²¡èµ·ã€è¶…æ—¶ã€ç½‘ç»œå¼‚å¸¸ã€è¢«ä¸­æ–­             |

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ è¡¥ä¸Šä¸€ä»½å®Œæ•´çš„ä¾‹å­ï¼ˆclient + serverï¼‰ï¼Œå±•ç¤ºåœ¨ **server ä¸å­˜åœ¨æ—¶** è¿™æ®µ `spin_until_future_complete` ä¼šå¦‚ä½•è¡¨ç°ï¼ˆåŒ…æ‹¬æ—¥å¿—è¾“å‡ºå’Œè¶…æ—¶è¡Œä¸ºï¼‰ã€‚
è¦æˆ‘å¸®ä½ å†™ä¸€ä»½ç®€çŸ­çš„ç¤ºä¾‹å—ï¼Ÿ

