å½“ç„¶å¯ä»¥ ğŸ‘
è¿™ç¯‡ ROS 2 æ•™ç¨‹è®²çš„æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„ä¸»é¢˜ï¼š**å¦‚ä½•åœ¨ C++ ä¸­ä½¿ç”¨ `ParameterEventHandler` åŠ¨æ€ç›‘æ§å‚æ•°å˜åŒ–**ã€‚
æˆ‘æ¥å¸®ä½ åˆ†æ®µè®²è§£è¿™ç¯‡æ–‡ç« ï¼Œé‡ç‚¹çªå‡ºæ ¸å¿ƒæœºåˆ¶ã€è¿è¡Œé€»è¾‘å’Œä½ åœ¨é¡¹ç›®ä¸­å¯ä»¥å¦‚ä½•åº”ç”¨ã€‚

---

## ğŸ§© ä¸€ã€èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆè¦ç›‘æ§å‚æ•°å˜åŒ–ï¼Ÿ

åœ¨ ROS 2 ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å£°æ˜å‚æ•°ï¼ˆä¾‹å¦‚é€Ÿåº¦ä¸Šé™ã€ç®—æ³•æ¨¡å¼ç­‰ï¼‰ã€‚
æœ‰æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›èŠ‚ç‚¹**è‡ªåŠ¨å“åº”å‚æ•°å˜åŒ–**ï¼Œè€Œä¸éœ€è¦é‡å¯æˆ–æ‰‹åŠ¨ç›‘å¬ã€‚

ä¾‹å¦‚ï¼š

* è°ƒæ•´æ§åˆ¶å™¨å¢ç›Šï¼ˆPIDï¼‰æ—¶ï¼ŒèŠ‚ç‚¹èƒ½ç«‹å³ç”¨æ–°çš„å‚æ•°ã€‚
* å¯ç”¨/ç¦ç”¨æŸä¸ªåŠŸèƒ½ï¼ˆå¦‚ debug è¾“å‡ºï¼‰æ—¶ï¼ŒèŠ‚ç‚¹è‡ªåŠ¨åˆ‡æ¢ã€‚

è¿™æ—¶å°±å¯ä»¥ç”¨ `rclcpp::ParameterEventHandler`ã€‚
å®ƒå…è®¸æˆ‘ä»¬ç›‘å¬ï¼š

1. è‡ªå·±èŠ‚ç‚¹å‚æ•°çš„å˜åŒ–ï¼›
2. å…¶ä»–èŠ‚ç‚¹å‚æ•°çš„å˜åŒ–ï¼›
3. æ‰€æœ‰èŠ‚ç‚¹æ‰€æœ‰å‚æ•°çš„å˜åŒ–ï¼ˆæ›´é«˜çº§ï¼‰ã€‚

---

## ğŸ— äºŒã€åŸºç¡€ä¾‹å­ï¼šç›‘å¬æœ¬èŠ‚ç‚¹å‚æ•°

```cpp
class SampleNodeWithParameters : public rclcpp::Node
{
public:
  SampleNodeWithParameters()
  : Node("node_with_parameters")
  {
    this->declare_parameter("an_int_param", 0);

    param_subscriber_ = std::make_shared<rclcpp::ParameterEventHandler>(this);

    auto cb = [this](const rclcpp::Parameter & p) {
      RCLCPP_INFO(
        this->get_logger(),
        "cb: Received an update to parameter \"%s\" of type %s: \"%ld\"",
        p.get_name().c_str(),
        p.get_type_name().c_str(),
        p.as_int());
    };

    cb_handle_ = param_subscriber_->add_parameter_callback("an_int_param", cb);
  }

private:
  std::shared_ptr<rclcpp::ParameterEventHandler> param_subscriber_;
  std::shared_ptr<rclcpp::ParameterCallbackHandle> cb_handle_;
};
```

### ğŸ” å…³é”®ç‚¹è§£æï¼š

| è¡Œ                        | åŠŸèƒ½      | è¯´æ˜                    |
| ------------------------ | ------- | --------------------- |
| `declare_parameter`      | å£°æ˜å‚æ•°    | ä½¿å‚æ•°å¯è¢«å¤–éƒ¨ä¿®æ”¹             |
| `ParameterEventHandler`  | åˆ›å»ºå‚æ•°è®¢é˜…å™¨ | å¯ä»¥ç›‘å¬ä»»æ„èŠ‚ç‚¹çš„å‚æ•°           |
| `add_parameter_callback` | æ³¨å†Œå›è°ƒ    | å½“æŒ‡å®šå‚æ•°å€¼å˜åŒ–æ—¶è§¦å‘           |
| `cb_handle_`             | ä¿å­˜å¥æŸ„    | è‹¥ä¸ä¿å­˜ï¼Œå›è°ƒä¼šè¢«é”€æ¯ï¼ˆ**éå¸¸é‡è¦**ï¼‰ |

è¿è¡Œåï¼Œä½ å¯ä»¥åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œï¼š

```bash
ros2 param set node_with_parameters an_int_param 43
```

è¾“å‡ºï¼š

```
[INFO] [node_with_parameters]: cb: Received an update to parameter "an_int_param" ...
```

---

## ğŸŒ ä¸‰ã€è¿›é˜¶ï¼šç›‘å¬å…¶ä»–èŠ‚ç‚¹å‚æ•°

ä½ ä¹Ÿå¯ä»¥è®©ä¸€ä¸ªèŠ‚ç‚¹ç›‘å¬**è¿œç¨‹èŠ‚ç‚¹çš„å‚æ•°**å˜åŒ–ã€‚

```cpp
auto cb2 = [this](const rclcpp::Parameter & p) {
  RCLCPP_INFO(
    this->get_logger(),
    "cb2: Received an update to parameter \"%s\": %.02lf",
    p.get_name().c_str(),
    p.as_double());
};

auto remote_node_name = "parameter_blackboard";
auto remote_param_name = "a_double_param";

cb_handle2_ = param_subscriber_->add_parameter_callback(
  remote_param_name, cb2, remote_node_name);
```

è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼š

> â€œå½“èŠ‚ç‚¹ `parameter_blackboard` çš„å‚æ•° `a_double_param` è¢«ä¿®æ”¹æ—¶ï¼Œè°ƒç”¨ cb2ã€‚â€

ä½ å¯ä»¥ç”¨ ROS è‡ªå¸¦çš„ç¤ºä¾‹èŠ‚ç‚¹æ¥æµ‹è¯•ï¼š

```bash
ros2 run cpp_parameter_event_handler parameter_event_handler
ros2 run demo_nodes_cpp parameter_blackboard
ros2 param set parameter_blackboard a_double_param 3.45
```

è¾“å‡ºï¼š

```
cb2: Received an update to parameter "a_double_param" of type double: "3.45"
```

---

## ğŸ§  å››ã€é«˜çº§ç”¨æ³•ï¼šç›‘å¬æ‰€æœ‰å‚æ•°äº‹ä»¶

å¦‚æœä½ ä¸æƒ³ä¸€ä¸ªä¸ªå‚æ•°ç›‘å¬ï¼Œå¯ä»¥ä¸€æ¬¡æ€§ç›‘å¬æ‰€æœ‰äº‹ä»¶ï¼š

```cpp
auto event_cb = [this](const rcl_interfaces::msg::ParameterEvent & event) {
  RCLCPP_INFO(
    this->get_logger(), "Received parameter event from node \"%s\"",
    event.node.c_str());

  for (const auto & p : event.changed_parameters) {
    RCLCPP_INFO(
      this->get_logger(), "Inside event: \"%s\" changed to %s",
      p.name.c_str(),
      rclcpp::Parameter::from_parameter_msg(p).value_to_string().c_str());
  }
};

event_cb_handle_ = param_subscriber_->add_parameter_event_callback(event_cb);
```

è¿™æ—¶ï¼Œä¸ç®¡å“ªä¸ªå‚æ•°ã€å“ªä¸ªèŠ‚ç‚¹ï¼Œåªè¦å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šè§¦å‘å›è°ƒã€‚

é€‚åˆåœºæ™¯ï¼š

* å…¨å±€å‚æ•°ç›‘æ§å™¨ï¼ˆå¦‚ç³»ç»Ÿè°ƒå‚å·¥å…·ï¼‰
* è‡ªåŠ¨æ—¥å¿—ã€é…ç½®è¿½è¸ªå™¨

---

## âš™ï¸ äº”ã€æ³¨æ„äº‹é¡¹

1. **ä¸€å®šè¦ä¿å­˜ callback handle (`cb_handle_`)**
   å¦åˆ™å›è°ƒä¼šåœ¨æ„é€ å‡½æ•°ç»“æŸåè¢«é”€æ¯ï¼Œç›‘å¬æ— æ•ˆã€‚

2. **å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªå‚æ•°**
   åªè¦å¤šæ¬¡è°ƒç”¨ `add_parameter_callback` å³å¯ã€‚

3. **çº¿ç¨‹å®‰å…¨**
   `ParameterEventHandler` å†…éƒ¨ä½¿ç”¨ rclcpp çš„ callback groupï¼Œå¯å®‰å…¨ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒã€‚

4. **å‚æ•°ç±»å‹æ£€æŸ¥**
   å¦‚æœç±»å‹ä¸åŒ¹é…ï¼ˆæ¯”å¦‚ä½  set æˆ float è€ŒæœŸæœ› intï¼‰ï¼Œ`as_int()` ä¼šæŠ›å¼‚å¸¸ã€‚

---

## ğŸ§© å…­ã€æ€»ç»“å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ParameterEventHandler     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ + add_parameter_callback(name, cb)â”‚
â”‚ + add_parameter_callback(name, cb, remote_node)â”‚
â”‚ + add_parameter_event_callback(cb)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Your callback function   â”‚
    â”‚  -> triggered on change   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ä¸ƒã€æ€»ç»“è¦ç‚¹

| åŠŸèƒ½       | æ–¹æ³•                                                 | é€‚ç”¨åœºæ™¯        |
| -------- | -------------------------------------------------- | ----------- |
| ç›‘å¬å•ä¸€å‚æ•°   | `add_parameter_callback("param", cb)`              | ç®€å•èŠ‚ç‚¹è°ƒå‚      |
| ç›‘å¬å…¶ä»–èŠ‚ç‚¹å‚æ•° | `add_parameter_callback("param", cb, "node_name")` | ç›‘æ§å¤–éƒ¨æ¨¡å—çŠ¶æ€    |
| ç›‘å¬æ‰€æœ‰å‚æ•°äº‹ä»¶ | `add_parameter_event_callback(cb)`                 | å…¨å±€å‚æ•°ç›‘æ§ã€è°ƒè¯•å·¥å…· |

---

æ˜¯å¦è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ªåŸºäºè¿™ç¯‡æ•™ç¨‹çš„**è‡ªå®šä¹‰ç›‘æ§ç¤ºä¾‹**ï¼Ÿ
ä¾‹å¦‚ï¼šç›‘å¬ä½ è‡ªå·±çš„èŠ‚ç‚¹å‚æ•°å˜åŒ–å¹¶åŠ¨æ€è°ƒæ•´æŸä¸ªç®—æ³•ï¼ˆæ¯”å¦‚PIDå¢ç›Šæˆ–é€Ÿåº¦é™åˆ¶ï¼‰ï¼Ÿ
